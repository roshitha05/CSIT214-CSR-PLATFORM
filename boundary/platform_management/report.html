<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Reports</title>

  <!-- Icons & Font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg-light:#f7f9fc;
      --primary:#34495e; --secondary:#2c3e50;
      --accent:#3498db; --accent-2:#2980b9;
      --text-dark:#2c3e50; --text-light:#fff;
      --border:#eef2f7; --shadow:0 4px 10px rgba(0,0,0,.1);
      --danger:#ef4444; --success:#16a34a; --ring:rgba(14,165,233,.3);
      --radius:12px; --input-h:40px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Poppins",sans-serif;
      background:var(--bg-light); color:var(--text-dark);
    }
    .main{min-height:100%; display:flex; flex-direction:column; gap:1.25rem; padding:2rem;}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:1rem;}
    .topbar h1{margin:0; font-size:1.6rem; font-weight:600; color:var(--accent-2);}
    .btn{
      height:var(--input-h); padding:0 .95rem; display:inline-flex; align-items:center; gap:.45rem;
      font-size:.85rem; font-weight:600; cursor:pointer; border-radius:10px; border:1px solid #cbd5e1;
      background:#fff; color:var(--secondary); box-shadow:0 1px 2px rgba(0,0,0,.03);
    }
    .btn.primary{background:var(--accent-2); color:#fff; border:none}
    .btn.primary:hover{opacity:.92}
    .btn.ghost{background:#eef2f7}
    .controls{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius);
      padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.04);
      display:grid; grid-template-columns:repeat(4,minmax(180px,1fr)) auto; gap:.75rem;
      align-items:end;
    }
    label{font-size:.85rem; color:#64748b; display:block; margin-bottom:.35rem;}
    .input,.select{
      width:100%; height:var(--input-h); padding:0 12px; border-radius:10px; background:#fff;
      border:1px solid #cbd5e1; font-size:.92rem;
    }
    .input:focus,.select:focus{outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring);}
    .panels{display:grid; gap:1rem;}
    .panel{
      background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    }
    .panel h2{
      margin:0; padding:1rem 1.25rem; border-bottom:1px solid var(--border);
      font-size:1.05rem; color:var(--accent-2);
      background:#f3f8ff; border-top-left-radius:12px; border-top-right-radius:12px;
    }
    .panel-body{padding:1rem 1.25rem}
    .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;}
    .kpi{
      border:1px solid var(--border); border-radius:10px; padding:.9rem; background:#fbfcff;
      display:flex; align-items:center; gap:.75rem;
    }
    .kpi i{font-size:1.1rem; color:var(--accent-2)}
    .kpi .label{font-size:.85rem; color:#555}
    .kpi .value{font-weight:700; font-size:1.1rem}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:10px; border:1px solid var(--border);}
    th,td{padding:.65rem .75rem; text-align:left; font-size:.92rem;}
    thead th{background:#f8fafc; border-bottom:1px solid var(--border); color:#475569;}
    tbody tr:not(:last-child) td{border-bottom:1px solid var(--border);}
    .muted{color:#64748b}
    .note{font-size:.85rem; color:#64748b; margin-top:.5rem}
    .right{display:flex; gap:.5rem; justify-content:flex-end}
    .status-pill{font-size:.75rem; padding:.2rem .5rem; border-radius:999px; border:1px solid #e2e8f0; background:#f1f5f9; color:#475569;}
    .loading{display:none; align-items:center; gap:.5rem; color:#64748b;}
    .loading.show{display:inline-flex;}
    @media (max-width:980px){.controls{grid-template-columns:1fr 1fr; grid-auto-rows:auto}}
  </style>
</head>
<body>
  <main class="main">
    <div class="topbar">
      <h1>Generate Reports</h1>
      <div class="right">
        <button class="btn" id="btnBack"><i class="fa-solid fa-arrow-left"></i>Return to Dashboard</button>
      </div>
    </div>

    <!-- Controls -->
    <section class="controls" aria-label="Report controls">
      <div>
        <label for="reportType">Report type</label>
        <select id="reportType" class="select" aria-label="Report type">
          <option value="DAILY">Daily</option>
          <option value="WEEKLY">Weekly</option>
          <option value="MONTHLY">Monthly</option>
        </select>
      </div>

      <div>
        <label for="from">From</label>
        <input type="date" id="from" class="input" aria-label="Start date">
      </div>

      <div>
        <label class="muted">&nbsp;</label>
        <button class="btn" id="btnReset"><i class="fa-solid fa-rotate-left"></i> Reset</button>
      </div>

      <div class="right">
        <span class="loading" id="loading"><i class="fa-solid fa-spinner fa-spin"></i> Loading…</span>
        <button class="btn primary" id="btnGenerate"><i class="fa-solid fa-chart-column"></i> Generate</button>
      </div>
    </section>

    <!-- Panels -->
    <section class="panels">
      <!-- Activity Overview -->
      <div class="panel" id="pActivity">
        <h2>Activity Overview</h2>
        <div class="panel-body">
          <div class="kpis" id="kpiActivity">
            <!-- KPIs injected here -->
          </div>
        </div>
      </div>

      <!-- Engagement Summary -->
      <div class="panel" id="pEngagement">
        <h2>Engagement Summary</h2>
        <div class="panel-body">
          <div class="kpis" id="kpiEngagement">
            <!-- KPIs injected here -->
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    /* =====================
        Config / constants
    ===================== */
    const API_URL = "http://127.0.0.1:80/api";
    const REPORTS_API = `${API_URL}/reports`;

    /* === SAMPLE REPORT (for immediate visualization) === */
    const SAMPLE_REPORT = {
        period: { from: "2025-10-20", to: "2025-10-26", type: "WEEKLY" },
        activity_overview: {
        total_requests: 48,
        active: 9,
        completed: 36,
        cancelled: 3,
        avg_completion_time_days: 1.9
        },
        engagement: {
        shortlisted_count: 72,
        matched_count: 36,
        avg_response_time_hours: 4.2,
        top_csr: { name: "Jane Lim", matches: 12 }
        },
        category_summary: [
        { category: "Elderly Assistance", total: 14, completed: 12, cancelled: 1, avg_completion_time_days: 1.6, completion_rate: 0.86 },
        { category: "Food Delivery", total: 10, completed: 9,  cancelled: 0, avg_completion_time_days: 1.1, completion_rate: 0.90 },
        { category: "Household Support", total: 9,  completed: 7,  cancelled: 1, avg_completion_time_days: 2.0, completion_rate: 0.78 },
        { category: "Medical Transport", total: 8,  completed: 6,  cancelled: 1, avg_completion_time_days: 2.4, completion_rate: 0.75 },
        { category: "Pet Care", total: 7,  completed: 2,  cancelled: 0, avg_completion_time_days: 3.5, completion_rate: 0.29 }
        ]
    };

    /* =====================
        DOM
    ===================== */
    const $ = (id)=>document.getElementById(id);
    const DOM = {
        type: $("reportType"),
        from: $("from"),
        to: $("to"),
        btnGenerate: $("btnGenerate"),
        btnExport: $("btnExport"),
        btnReset: $("btnReset"),
        btnBack: $("btnBack"),
        loading: $("loading"),

        kpiActivity: $("kpiActivity"),
        kpiEngagement: $("kpiEngagement"),
        tblCategory: $("tblCategory"),
    };

    /* =====================
        Utils
    ===================== */
    function setLoading(on){
        DOM.loading.classList.toggle("show", !!on);
        DOM.btnGenerate.disabled = !!on;
        //DOM.btnExport.disabled = !!on;
    }
    function sanitize(n, d=0){
        return (n===null || n===undefined || Number.isNaN(n)) ? d : n;
    }
    function fmtDays(n){ return sanitize(n).toFixed(1); }
    function fmtHours(n){ return sanitize(n).toFixed(1); }
    function fmtPct(n){ return (sanitize(n)*100).toFixed(1) + "%"; }
    function ymdToday(){ return new Date().toISOString().split("T")[0]; }

    async function fetchJSON(url, options={}) {
      const res = await fetch(url, { credentials:"include", mode:"cors", ...options });
      const ct  = res.headers.get("content-type") || "";
      let data=null; try{ data = ct.includes("application/json") ? await res.json() : await res.text(); }catch{}
      return { ok: res.ok, status: res.status, data };
    }

    /* =====================
        Renderers
    ===================== */
    function renderActivityKpis(a){
        const items = [
        { icon:"fa-list", label:"Total Requests", value:sanitize(a.requestsCreated) },
        { icon:"fa-check", label:"Completed", value:sanitize(a.completedRequests) },
        ];
        DOM.kpiActivity.innerHTML = items.map(k=>`
        <div class="kpi">
            <i class="fa-solid ${k.icon}"></i>
            <div>
            <div class="label">${k.label}</div>
            <div class="value">${k.value}</div>
            </div>
        </div>
        `).join("");
    }

    function renderEngagementKpis(e){
        const topCSR = e?.top_csr?.name ? `${e.top_csr.name} (${sanitize(e.top_csr.matches)} matches)` : "—";
        const items = [
        { icon:"fa-bookmark", label:"Shortlisted (count)", value:sanitize(e.shortlists) },
        { icon:"fa-handshake", label:"Matched / Completed", value:sanitize(e.matches) },
        ];
        DOM.kpiEngagement.innerHTML = items.map(k=>`
        <div class="kpi">
            <i class="fa-solid ${k.icon}"></i>
            <div>
            <div class="label">${k.label}</div>
            <div class="value">${k.value}</div>
            </div>
        </div>
        `).join("");
    }

    // function renderCategoryTable(rows){
    //     if (!Array.isArray(rows) || rows.length===0){
    //     DOM.tblCategory.innerHTML = `
    //         <tr><td colspan="6" class="muted">No data for this period.</td></tr>
    //     `;
    //     return;
    //     }
    //     rows.sort((a,b)=> (b.total||0) - (a.total||0));
    //     DOM.tblCategory.innerHTML = rows.map(r=>`
    //     <tr>
    //         <td>${r.category || "—"}</td>
    //         <td>${sanitize(r.total)}</td>
    //         <td>${sanitize(r.completed)}</td>
    //         <td>${sanitize(r.cancelled)}</td>
    //         <td>${fmtDays(r.avg_completion_time_days)}</td>
    //         <td>${fmtPct(r.completion_rate)}</td>
    //     </tr>
    //     `).join("");
    // }

    /* =====================
        CSV Export (client-side)
    ===================== */
    function toCsvCell(v){
        if (v===null || v===undefined) return "";
        const s = String(v).replace(/"/g,'""');
        return `"${s}"`;
    }
    function downloadCsv(filename, sections){
        const parts = [];

        // Activity
        if (sections.activity){
        parts.push("Activity Overview");
        const a = sections.activity;
        parts.push("Metric,Value");
        [
            ["Total Requests", a.total_requests],
            ["Completed", a.completed],
            ["Active", a.active],
            ["Cancelled", a.cancelled],
            ["Avg Completion (days)", a.avg_completion_time_days],
        ].forEach(([k,v])=>parts.push(`${toCsvCell(k)},${toCsvCell(v)}`));
        parts.push("");
        }

        // Engagement
        if (sections.engagement){
        parts.push("Engagement Summary");
        const e = sections.engagement;
        parts.push("Metric,Value");
        [
            ["Shortlisted (count)", e.shortlisted_count],
            ["Matched / Completed", e.matched_count],
            ["Avg Response (hours)", e.avg_response_time_hours],
            ["Top CSR", e.top_csr?.name ? `${e.top_csr.name} (${e.top_csr.matches})` : "—"],
        ].forEach(([k,v])=>parts.push(`${toCsvCell(k)},${toCsvCell(v)}`));
        parts.push("");
        }

        // Category
        if (sections.category && Array.isArray(sections.category)){
        parts.push("Category Summary");
        parts.push("Category,Total,Completed,Cancelled,Avg Completion (days),Completion Rate");
        sections.category.forEach(r=>{
            parts.push([
            r.category || "—",
            sanitize(r.total),
            sanitize(r.completed),
            sanitize(r.cancelled),
            fmtDays(r.avg_completion_time_days),
            fmtPct(r.completion_rate)
            ].map(toCsvCell).join(","));
        });
        parts.push("");
        }

        const blob = new Blob([parts.join("\n")], {type:"text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /* =====================
        Shared render entrypoint
    ===================== */
    function renderReportFromData(data) {
        renderActivityKpis(data || {});
        renderEngagementKpis(data || {});
        //renderCategoryTable(data || []);

        // Prepare export for this payload
        const type = (data?.period?.type || "custom").toLowerCase();
        const from = data?.period?.from || DOM.from.value || "from";
        //const to   = data?.period?.to   || DOM.to.value   || "to";
        // DOM.btnExport.onclick = ()=>{
        // const file = `report_${type}_${from}_to_${to}.csv`;
        // downloadCsv(file, {
        //     activity: data.activity_overview,
        //     engagement: data.engagement,
        //     category: data.category_summary
        // });
        // };
    }

    /* =====================
        B-C-E: Request + Render
    ===================== */
    async function generateReport(){
        const from = DOM.from.value;
        //const to = DOM.to.value;
        //if (!from || !to){ alert("Please select both From and To dates."); return; }
        //if (new Date(from) > new Date(to)){ alert("‘From’ must be earlier than or equal to ‘To’."); return; }

        const type = DOM.type.value; // DAILY | WEEKLY | MONTHLY
        //const qs = new URLSearchParams({ date_from: from, date_to: to, type });

        setLoading(true);
        try{
        const { ok, status, data } = await fetchJSON(
          `${REPORTS_API}/${type.toLowerCase()}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
              date: from
          })
        });
        if (!ok) throw new Error(`Report fetch failed (${status})`);
        renderReportFromData(data);
        }catch(err){
        console.error(err);
        alert("Unable to generate report. Showing sample data instead.");
        // Fallback to sample so you can still demo
        renderReportFromData(SAMPLE_REPORT);
        }finally{
        setLoading(false);
        }
    }

    /* =====================
        Init
    ===================== */
    (function init(){
        // Date max = today
        const today = ymdToday();
        DOM.from.setAttribute("max", today);
        //DOM.to.setAttribute("max", today);

        // Sensible default: last 7 days
        const d = new Date(); d.setDate(d.getDate()-6);
        DOM.from.value = d.toISOString().split("T")[0];
        //DOM.to.value = today;

        // Render SAMPLE immediately for visualization
        renderReportFromData(SAMPLE_REPORT);

        // Wire actions
        DOM.btnGenerate.addEventListener("click", generateReport);
        DOM.btnReset.addEventListener("click", (e)=>{
        e.preventDefault();
        DOM.type.value = "DAILY";
        const d2 = new Date(); d2.setDate(d2.getDate()-6);
        DOM.from.value = d2.toISOString().split("T")[0];
        DOM.to.value = today;
        // Optional: re-render sample on reset for quick demo
        renderReportFromData(SAMPLE_REPORT);
        });
        DOM.btnBack.addEventListener("click", ()=> window.location.href = "/platform_management/platform_dashboard.html");
    })();
    </script>
</body>
</html>
