<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category Management</title>
  <style>
    :root {
      --bg:#f0f9ff; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --accent:#38bdf8; 
      --accent-2:#0ea5e9; 
      --danger:#ef4444;
      --ring:rgba(14,165,233,.3); 
      --radius:16px;
    }

    /* ===== Base ===== */
    * { box-sizing: border-box; }
    html, body { min-height:100%; margin:0; }
    body {
      font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:linear-gradient(180deg,#e0f2fe,var(--bg));
      color:var(--text);
      display:flex; justify-content:center; align-items:flex-start;
      padding:24px; min-height:100svh; overflow:hidden;
    }

    /* ===== Card ===== */
    .card {
      width:100%; max-width:1000px; height:calc(100svh - 48px);
      background:var(--card); border:1px solid #e2e8f0; border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.1); overflow:hidden;
      display:flex; flex-direction:column;
    }

    /* ===== Header ===== */
    .header {
      padding:18px 24px; background:linear-gradient(180deg,#e0f2fe,#f8fafc);
      border-bottom:1px solid #e2e8f0;
      display:flex; justify-content:space-between; align-items:center;
    }
    .header h1 { margin:0; font-size:1.5rem; color:var(--accent-2); }
    .header-controls { display:flex; align-items:center; gap:12px; }

    .btn-dashboard {
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:#fff; border:0; border-radius:10px; padding:10px 18px;
      font-size:.9rem; font-weight:600; cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,.1); transition:.2s;
    }
    .btn-dashboard:hover { transform:scale(1.05); opacity:.9; }

    .search-box input {
      width:240px; padding:10px 14px; border-radius:12px; border:1px solid #cbd5e1;
      font-size:.95rem;
    }
    .search-box input:focus {
      border-color:var(--accent-2); outline:none; box-shadow:0 0 0 3px var(--ring);
    }

    /* ===== Table ===== */
    .table-wrap {
      flex:1; min-height:0;
      overflow-y:auto; overflow-x:auto;
      scrollbar-gutter:stable; position:relative;
    }
    table {
      width:100%; min-width:900px;
      border-collapse:collapse; table-layout:fixed;
    }
    thead th {
      position:sticky; top:0; z-index:10;
      background:#f8fafc; box-shadow:0 1px 0 #e2e8f0;
      text-align:left;
    }
    th, td {
      padding:14px 16px; min-width:0; vertical-align:middle;
      border-bottom:1px solid #e2e8f0;
      text-overflow:ellipsis; overflow:hidden;
    }
    td { font-size:.93rem; color:#334155; }

    /* Hint */
    .hint {
      margin-top: 6px; font-size: .85rem;
      color: var(--muted); display: block;
    }

    /* Hover and zebra */
    tbody tr:nth-child(odd) td { background:#fcfdff; }
    tbody tr:hover td { background:#f9fafb; }

    td.description { white-space:normal; line-height:1.4; }
    td.status { text-align:center; }
    td.actions { text-align:center; }

    th:nth-child(3), th:nth-child(4) {
      text-align: center;
    }

    /* ===== Status Badges ===== */
    .badge {
      display:inline-block; padding:4px 10px; border-radius:9999px;
      font-size:.78rem; font-weight:600; line-height:1; white-space:nowrap;
    }
    .badge-active {
      background:#dcfce7; color:#166534; border:1px solid #86efac;
    }
    .badge-suspended {
      background:#fee2e2; color:#991b1b; border:1px solid #fca5a5;
    }
    .badge-protected {
      display:inline-flex; align-items:center; gap:6px;
      background:#fef3c7; color:#92400e; border:1px solid #fcd34d;
      padding:2px 8px; border-radius:9999px; font-size:.75rem; font-weight:700;
    }

    /* ===== Buttons ===== */
    .btn-edit, .btn-suspend, .btn-reactivate {
      padding:6px 14px; border-radius:8px; border:0; cursor:pointer;
      font-size:.85rem; white-space:nowrap; transition:.2s;
    }
    .btn-edit { background:var(--accent-2); color:#fff; }
    .btn-suspend { background:var(--danger); color:#fff; }
    .btn-reactivate { background:#22c55e; color:#fff; }
    .btn-edit:hover, .btn-suspend:hover, .btn-reactivate:hover { opacity:.85; }

    td.actions .btn-row {
      display:flex; justify-content:center; align-items:center; gap:10px;
    }

    /* --- Protected Roles --- */
    .btn-suspend[disabled] {
      cursor: not-allowed;
      opacity:.55;
    }

    /* ===== Footer ===== */
    .footer {
      padding:12px 20px; border-top:1px solid #e2e8f0;
      color:var(--muted); font-size:.9rem;
      display:flex; justify-content:space-between; flex-wrap:wrap;
    }

    /* ===== Modals ===== */
    .modal {
      display:none; position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
      justify-content:center; align-items:center;
    }
    .modal-content {
      width:min(640px,92vw); background:#fff;
      border-radius:20px; padding:32px 36px;
      box-shadow:0 8px 36px rgba(0,0,0,.25);
      animation:fadeIn .25s ease-in-out;
    }
    .modal-content h2 {
      margin:0 0 24px; font-size:1.4rem; font-weight:700; color:var(--text);
      border-bottom:1px solid #e2e8f0; padding-bottom:12px;
    }
    .modal-body { display:grid; gap:18px; margin-top:6px; }

    .form-row label {
      display:block; font-size:.9rem; font-weight:600; color:var(--text);
      margin-bottom:8px;
    }
    .modal-input, .modal-textarea {
      width:100%; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px;
      padding:14px 16px; font-size:.95rem; font-family:inherit;
      transition:border-color .15s, box-shadow .15s;
    }
    .modal-input:focus, .modal-textarea:focus {
      outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring);
    }
    .modal-input[disabled] {
      cursor: not-allowed; opacity: .8; background: #f1f5f9;
    }
    .modal-textarea { min-height:110px; resize:vertical; }

    .modal-actions {
      margin-top:24px; padding-top:16px; border-top:1px solid #e2e8f0;
      display:flex; justify-content:flex-end; gap:12px;
    }
    .btn-cancel {
      background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1;
      padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-cancel:hover { background:#e2e8f0; }
    .btn-primary {
      background:var(--accent-2); color:#fff; padding:10px 18px; border-radius:8px;
      font-weight:600; cursor:pointer;
    }
    .btn-primary:hover { opacity:.9; transform:translateY(-1px); }
    .btn-danger {
      background:var(--danger); color:#fff; padding:10px 18px;
      border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-danger:hover { opacity:.9; transform:translateY(-1px); }

    .error {
      margin-top: 6px; color: var(--danger);
      font-size: .9rem; display: none;
    }

    @keyframes fadeIn { from{opacity:0; transform:scale(.95);} to{opacity:1; transform:scale(1);} }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>Category Management</h1>
      <div class="header-controls">
        <button class="btn-dashboard" id="returnDashboard">Return to Dashboard</button>
        <div class="search-box">
          <input type="text" id="search" placeholder="Search by keyword...">
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="profileTable">
        <colgroup>
          <col style="width: 20%"> <!-- Name -->
          <col style="width: 40%"> <!-- Description -->
          <col style="width: 20%"> <!-- Status -->
          <col style="width: 20%"> <!-- Actions -->
        </colgroup>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr id="noResultsRow" style="display:none;">
            <td colspan="4" class="no-results">No results found.</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="footer">
      <span>© 2025 Community Support Platform</span>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
      <h2 id="editTitle">Edit Category</h2>

      <div class="modal-body">
        <div class="form-row">
          <label for="editName">Name <span style="color:var(--muted)">*</span></label>
          <input type="text" id="editName" class="modal-input" placeholder="Category name"/>
          <small class="hint">Required. 1–64 characters.</small>
          <div id="editErr-name" class="error" style="display:none;">Please enter a valid name (1–64 characters).</div>
        </div>

        <div class="form-row">
          <label for="editDesc">Description <span style="color:var(--muted)">*</span></label>
          <textarea id="editDesc" class="modal-textarea" placeholder="Short description"></textarea>
          <small class="hint">Required. Up to 255 characters.</small>
          <div id="editErr-desc" class="error" style="display:none;">Description must be 255 characters or fewer.</div>
        </div>

        <div id="success" class="success" role="status" aria-live="polite"></div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button type="button" class="btn-primary" onclick="saveEditModal()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Archive Modal -->
  <div class="modal" id="suspendModal" role="dialog" aria-modal="true" aria-labelledby="suspendTitle">
    <div class="modal-content">
      <h2 id="suspendTitle">Confirm Archive</h2>
      <p>Are you sure you want to archive this category?</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSuspendModal()">Cancel</button>
        <button class="btn-danger" onclick="confirmSuspendUI()">Suspend</button>
      </div>
    </div>
  </div>

  <!-- Reactivate Modal -->
  <div class="modal" id="reactivateModal" role="dialog" aria-modal="true" aria-labelledby="reactivateTitle">
    <div class="modal-content">
      <h2 id="reactivateTitle">Confirm Restore</h2>
      <p>Are you sure you want to restore this category?</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeReactivateModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmReactivateUI()">Reactivate</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Config 
    // =========================
    const DEBUG           = false;
    const API_URL         = "http://127.0.0.1:80/api";
    const CATEGORIES_API  = `${API_URL}/categories`;

    const STATUS = { ACTIVE: "ACTIVE", ARCHIVED: "ARCHIVED" };

    // =========================
    // DOM
    // =========================
    const $  = (id) => document.getElementById(id);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const els = {
      table: $("profileTable"),
      tbody: $("profileTable")?.querySelector("tbody"),
      noResultsRow: $("noResultsRow"),
      search: $("search"),

      editModal: $("editModal"),
      editName: $("editName"),
      editDesc: $("editDesc"),
      editErrName: $("editErr-name"),
      editErrDesc: $("editErr-desc"),
      success: $("success"),
    }

    // =========================
    // Utilities / Normalizers
    // =========================
    const log = (...args) => { if (DEBUG) console.log("[categories]", ...args); };

    const norm            = (s) => String(s ?? "").trim().toLowerCase();
    const collapseSpaces  = (s) => String(s ?? "").replace(/\s+/g, " ").trim();
    const nonEmpty        = (s) => collapseSpaces(s).length > 0;

    const escapeHTML = (s) =>
      String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");

    // Duplicate name check (case-insensitive). Ignores the current record if provided.
    function isDuplicateName(newName, profiles, currentName = null) {
      const target = norm(newName);
      const cur    = norm(currentName);
      return profiles.some(p => {
        const existing = norm(p?.name);
        return existing === target && existing !== cur;
      });
    }

    // =========================
    // State
    // =========================
    let allCategories          = [];
    let currentRow           = null; // row being edited
    let pendingSuspendRow    = null;
    let pendingReactivateRow = null;

    // Request guards to prevent double-submission
    let editing        = false;
    let suspending     = false;
    let reactivating   = false;

    // =========================
    // UI Status Helpers
    // =========================
    function showErr(message) {
      els.success.style.display = "block";
      els.success.style.background = "#fee2e2";
      els.success.style.border = "1px solid #fecaca";
      els.success.style.color = "#991b1b";
      els.success.textContent = message;
    }

    function clearStatus() {
      els.success.style.display = "none";
      els.success.textContent = "";
    }

    // Debug Helper
    function showDebug(endpoint, payload) {
      els.success.style.display = "block";
      els.success.style.background = "#fef9c3";   
      els.success.style.border = "1px solid #fde047";
      els.success.style.color = "#854d0e";
      els.success.style.whiteSpace = "pre-wrap";
      els.success.textContent =
        `[DEBUG]:\n\n` +
        `This would PUT to:\n${endpoint}\n\n` +
        `With values:\n${JSON.stringify(payload, null, 2)}`;
    }

    // =========================
    // API
    // =========================
    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, { credentials: "include", mode: "cors", ...options });
      const ct = res.headers.get("content-type") || "";
      let data = null;
      try {
        data = ct.includes("application/json") ? await res.json() : await res.text();
      } catch {}
      return { ok: res.ok, status: res.status, data };
    }

    // =========================
    // Rendering
    // =========================
    function statusBadgeHTML(statusStr) {
        return String(statusStr).toUpperCase() === STATUS.ARCHIVED
            ? '<span class="badge badge-suspended">Archived</span>'
            : '<span class="badge badge-active">Active</span>';
    }

    function actionButtonHTML(statusStr) {
        return String(statusStr).toUpperCase() === STATUS.ARCHIVED
            ? '<button class="btn-reactivate" onclick="openReactivateModal(this)">Restore</button>'
            : '<button class="btn-suspend" onclick="openSuspendModal(this)">Archive</button>';
    }

    function rowHTML(p) {
      const rawName = String(p?.name ?? "");
      const status  = (p?.status || STATUS.ACTIVE).toUpperCase();
      const name    = escapeHTML(p?.name);
      const desc    = escapeHTML(p?.description);
      const key     = encodeURIComponent(rawName);

      return `
        <tr data-key="${key}" data-category="${name}" data-raw="${rawName}" data-status="${status}">
          <td class="name">${name}</td>
          <td class="description">${desc}</td>
          <td class="status">${statusBadgeHTML(status)}</td>
          <td class="actions">
            <div class="btn-row">
              <button class="btn-edit" onclick="openEditModal(this.closest('tr'))">Edit</button>
              ${actionButtonHTML(status)}
            </div>
          </td>
        </tr>
      `;
    }

    function populateTable(profiles) {
      els.tbody.innerHTML = profiles
        .slice()
        .sort((a, b) => String(a.name).localeCompare(String(b.name), undefined, { sensitivity: "base" }))
        .map(rowHTML)
        .join("");
      updateNoResults();
    }

    function updateNoResults() {
      const rows = $$("#profileTable tbody tr");
      const visible = rows.some((r) => r.style.display !== "none");
      els.noResultsRow.style.display = visible ? "none" : "";
    }

    function applyStatusToRow(row, statusStr) {
      const status = (statusStr || STATUS.ACTIVE).toUpperCase();
      row.dataset.status = status;
      row.querySelector(".status").innerHTML = statusBadgeHTML(status);

      const btnRow = row.querySelector(".actions .btn-row");
      const swapTarget = btnRow.querySelector(".btn-suspend, .btn-reactivate");

      const tmp = document.createElement("div");
      tmp.innerHTML = actionButtonHTML(status);
      const fresh = tmp.firstElementChild;

      swapTarget ? swapTarget.replaceWith(fresh) : btnRow.appendChild(fresh);
    }

    async function loadCategories() {
      try {
        const { ok, status, data } = await fetchJSON(CATEGORIES_API, { method: "GET" });
        if (!ok) throw new Error(`Failed to load categories (${status})`);
        const list = Array.isArray(data?.categories) ? data.categories : [];
        allCategories = list;
        populateTable(allCategories);
      } catch (e) {
        console.error(e);
        allCategories = [];
        populateTable(allCategories); // shows “No results”
        showErr("Unable to load categories. Please try again later.");
      }
    }

    loadCategories();

    // =========================
    // Search
    // =========================
    els.search.addEventListener("input", function () {
      const filter = this.value.toLowerCase();
      $$("#profileTable tbody tr").forEach((row) => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
      });
      updateNoResults();
      });

    // =========================
    // Modals: Edit
    // =========================
    function openEditModal(row) {
      currentRow = row;
      const currentName = currentRow.dataset.raw || "";

      els.editName.value  = currentRow.querySelector(".name").textContent.trim();
      els.editDesc.value  = currentRow.querySelector(".description").textContent.trim();

      // reset UI
      els.editErrName.style.display = "none";
      els.editErrDesc.style.display = "none";
      [els.editName, els.editDesc].forEach(el => el.removeAttribute("aria-invalid"));
      clearStatus();

      els.editModal.style.display = "flex";
    }

    function closeEditModal() {
      els.editModal.style.display = "none";
      els.editName.disabled = false;

      // reset UI (field-level)
      els.editErrName.style.display = "none";
      els.editErrDesc.style.display = "none";

      [els.editName, els.editDesc].forEach(el => el.removeAttribute("aria-invalid"));

      clearStatus();
    }

    function validateEditForm() {
      const nameEl  = els.editName;
      const descEl  = els.editDesc;

      const vName  = collapseSpaces(nameEl.value);
      const vDesc  = collapseSpaces(descEl.value);

      nameEl.value  = vName;
      descEl.value  = vDesc;

      let ok = true;

      // Name: required (1–64), not duplicate (case-insensitive)
      if (!nonEmpty(vName) || vName.length > 64) {
        els.editErrName.textContent = "Please enter a valid name (1–64 characters).";
        els.editErrName.style.display = "block";
        nameEl.setAttribute("aria-invalid", "true");
        ok = false;
      } 
      else if (isDuplicateName(vName, allCategories, currentRow?.dataset?.raw)) {
        els.editErrName.textContent = "A category with that name already exists.";
        els.editErrName.style.display = "block";
        nameEl.setAttribute("aria-invalid", "true");
        ok = false;
      }

      // Description: required, <= 255
      if (!nonEmpty(vDesc) || vDesc.length > 255) {
        els.editErrDesc.textContent = "Description must be 255 characters or fewer.";
        els.editErrDesc.style.display = "block";
        descEl.setAttribute("aria-invalid", "true");
        ok = false;
      }

      // Focus first invalid
      if (!ok) {
        if (nameEl.hasAttribute("aria-invalid")) nameEl.focus({ preventScroll: true });
        else if (descEl.hasAttribute("aria-invalid")) descEl.focus({ preventScroll: true });
      }
      
      return ok;
    }

    async function saveEditModal() {
      if (editing) return;
      if (!validateEditForm()) return;

      editing = true;

      const name = els.editName.value.trim();
      const description = els.editDesc.value.trim();

      const curKey   = currentRow.dataset.key;
      const curRaw   = currentRow.dataset.raw;
      const curDesc  = currentRow.querySelector(".description").textContent.trim();

      const payload = { name, description }

      // nothing changed
      if (name === curRaw && description === curDesc) {
        editing = false;
        closeEditModal();
        return;
      }

      // DEBUG mode
      if (DEBUG) {
        showDebug(`${CATEGORIES_API}/${curKey}`, payload);
        editing = false;
        return;
      }

      try {
        const { ok, status } = await fetchJSON(`${CATEGORIES_API}/${curKey}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!ok) throw new Error(`Update failed (${status})`);

        // Update row in place
        currentRow.querySelector(".name").textContent        = name;
        currentRow.querySelector(".description").textContent = description;

        currentRow.dataset.raw = name;
        currentRow.dataset.key = encodeURIComponent(name);

        // Update cache
        const i = allCategories.findIndex(p => norm(p.name) === norm(curRaw));
        if (i !== -1) allCategories[i] = { ...allCategories[i], ...payload };

        closeEditModal();
      } catch (e) {
        console.error(e);
        showErr("Could not save changes. Please try again.");
        // keep modal open so user can correct
      } finally {
        editing = false;
      }
    }

    // =========================
    // Modals: Suspend
    // =========================
    function openSuspendModal(button) {
      pendingSuspendRow = button.closest("tr");
      $("suspendModal").style.display = "flex";
    }

    function closeSuspendModal() {
      $("suspendModal").style.display = "none";
      pendingSuspendRow = null;
    }

    async function confirmSuspendUI() {
      if (!pendingSuspendRow || suspending) return;
      suspending = true;

      const key = pendingSuspendRow.dataset.key;
      try {
        const { ok, status, data } = await fetchJSON(`${CATEGORIES_API}/${key}/archive`, {
          method: "POST"
        });
        if (!ok) throw new Error(`Archive failed (${status})`);

        let newStatus = STATUS.ARCHIVED;
        try { newStatus = String((data?.data?.status ?? STATUS.ARCHIVED)).toUpperCase(); } catch {}
        applyStatusToRow(pendingSuspendRow, newStatus);
      } catch (e) {
        console.error(e);
        showErr("Could not suspend. Please try again.");
      } finally {
        suspending = false;
        closeSuspendModal();
      }
    }

    // =========================
    // Modals: Restore
    // =========================
    function openReactivateModal(button) {
      pendingReactivateRow = button.closest("tr");
      $("reactivateModal").style.display = "flex";
    }

    function closeReactivateModal() {
      $("reactivateModal").style.display = "none";
      pendingReactivateRow = null;
    }

    async function confirmReactivateUI() {
      if (!pendingReactivateRow || reactivating) return;
      reactivating = true;

      const key = pendingReactivateRow.dataset.key;
      const modalBtn = document.querySelector("#reactivateModal .btn-primary");
      modalBtn.disabled = true;
      const original = modalBtn.textContent;
      modalBtn.textContent = "Restoring...";

      try {
        const { ok, status } = await fetchJSON(`${CATEGORIES_API}/${key}/restore`, {
          method: "POST"
        });
        if (!ok) throw new Error(`Reinstate failed (${status})`);

        applyStatusToRow(pendingReactivateRow, STATUS.ACTIVE);
      } catch (e) {
        console.error(e);
        showErr("Could not reactivate. Please try again.");
      } finally {
        reactivating = false;
        modalBtn.disabled = false;
        modalBtn.textContent = original;
        closeReactivateModal();
      }
    }

    // =========================
    // Navigation
    // =========================
    $("returnDashboard").addEventListener("click", () => {
      window.location.href = "/platform_management/platform_dashboard.html";
    });
  </script>
</body>
</html>
