<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category Management</title>

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"/>
  
  <style>
    /* =========================
      Design Tokens
    ========================= */
    :root{
      --bg:#f0f9ff;
      --card:#ffffff;
      --text:#1e293b;
      --muted:#64748b;
      --accent:#38bdf8;
      --accent-2:#0ea5e9;
      --danger:#ef4444;
      --ring:rgba(14,165,233,.3);
      --radius:16px;
    }

    /* =========================
      Base / Reset
    ========================= */
    *{ box-sizing:border-box; }
    html, body{ min-height:100%; margin:0; }
    body{
      font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:linear-gradient(180deg,#e0f2fe,var(--bg));
      color:var(--text);
      display:flex; justify-content:center; align-items:flex-start;
      padding:24px; min-height:100svh; overflow:hidden;
    }

    /* =========================
      Layout (Card)
    ========================= */
    .card{
      width:100%; max-width:1000px; height:calc(100svh - 48px);
      background:var(--card); border:1px solid #e2e8f0; border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.1); overflow:hidden;
      display:flex; flex-direction:column;
    }

    /* =========================
      Header
    ========================= */
    .header{
      padding:18px 24px; background:linear-gradient(180deg,#e0f2fe,#f8fafc);
      border-bottom:1px solid #e2e8f0;
      display:flex; justify-content:space-between; align-items:center;
    }
    .header h1{ margin:0; font-size:1.5rem; color:var(--accent-2); }
    .header-controls{ display:flex; align-items:center; gap:12px; }

    /* Header button */
    .btn-dashboard{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:#fff; border:0; border-radius:10px; padding:10px 18px;
      font-size:.9rem; font-weight:600; cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,.1); transition:.2s;
    }
    .btn-dashboard:hover{ transform:scale(1.05); opacity:.9; }

    /* =========================
      Search (icon inside input)
    ========================= */
    .header .search-box{ position:relative; }
    .header .search-box input{
      width:240px; padding:10px 14px; border-radius:12px; border:1px solid #cbd5e1;
      font-size:.95rem; transition:border-color .15s, box-shadow .15s;
    }
    .header .search-box input:focus{
      border-color:var(--accent-2); outline:none; box-shadow:0 0 0 3px var(--ring);
    }
    .header .search-box .fa-magnifying-glass{
      position:absolute; left:12px; top:50%; transform:translateY(-50%);
      color:var(--muted); font-size:.95rem; line-height:0; pointer-events:none;
    }
    /* Add left padding only when icon exists */
    .header .search-box:has(.fa-magnifying-glass) input{ padding-left:2.25rem; }

    /* =========================
      Table Wrapper
    ========================= */
    .table-wrap{
      flex:1; min-height:0;
      overflow-y:auto; overflow-x:auto;
      scrollbar-gutter:stable; position:relative;
    }

    /* =========================
      Table
    ========================= */
    table{
      width:100%; min-width:900px;
      border-collapse:collapse; table-layout:fixed;
    }
    thead th{
      position:sticky; top:0; z-index:10;
      background:#f8fafc; box-shadow:0 1px 0 #e2e8f0;
      text-align:left;
    }
    th, td{
      padding:14px 16px; min-width:0; vertical-align:middle;
      border-bottom:1px solid #e2e8f0;
      text-overflow:ellipsis; overflow:hidden;
    }
    td{ font-size:.93rem; color:#334155; }

    /* Hints */
    .hint{ margin-top:6px; font-size:.85rem; color:var(--muted); display:block; }

    /* Row states */
    tbody tr:nth-child(odd) td{ background:#fcfdff; }
    tbody tr:hover td{ background:#f9fafb; }

    /* Column specifics */
    td.description{ white-space:normal; line-height:1.4; }
    td.status{ text-align:center; }
    td.actions{ text-align:center; }
    th:nth-child(3), th:nth-child(4){ text-align:center; }

    /* =========================
      Status Badges
    ========================= */
    .badge{
      display:inline-block; padding:4px 10px; border-radius:9999px;
      font-size:.78rem; font-weight:600; line-height:1; white-space:nowrap;
    }
    .badge-active{ background:#dcfce7; color:#166534; border:1px solid #86efac; }
    .badge-suspended{ background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
    .badge-protected{
      display:inline-flex; align-items:center; gap:6px;
      background:#fef3c7; color:#92400e; border:1px solid #fcd34d;
      padding:2px 8px; border-radius:9999px; font-size:.75rem; font-weight:700;
    }

    /* =========================
      Row Actions (Buttons)
    ========================= */
    .btn-edit, .btn-suspend, .btn-reactivate{
      padding:6px 14px; border-radius:8px; border:0; cursor:pointer;
      font-size:.85rem; white-space:nowrap; transition:.2s;
    }
    .btn-edit{ background:var(--accent-2); color:#fff; }
    .btn-suspend{ background:var(--danger); color:#fff; }
    .btn-reactivate{ background:#22c55e; color:#fff; }
    .btn-edit:hover, .btn-suspend:hover, .btn-reactivate:hover{ opacity:.85; }
    td.actions .btn-row{ display:flex; justify-content:center; align-items:center; gap:10px; }
    .btn-suspend[disabled]{ cursor:not-allowed; opacity:.55; }

    /* =========================
      Footer
    ========================= */
    .footer{
      padding:12px 20px; border-top:1px solid #e2e8f0;
      color:var(--muted); font-size:.9rem;
      display:flex; justify-content:space-between; flex-wrap:wrap;
    }

    /* =========================
      Modals
    ========================= */
    .modal{
      display:none; position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
      justify-content:center; align-items:center;
    }
    .modal-content{
      width:min(640px,92vw); background:#fff;
      border-radius:20px; padding:32px 36px;
      box-shadow:0 8px 36px rgba(0,0,0,.25);
      animation:fadeIn .25s ease-in-out;
    }
    .modal-content h2{
      margin:0 0 24px; font-size:1.4rem; font-weight:700; color:var(--text);
      border-bottom:1px solid #e2e8f0; padding-bottom:12px;
    }
    .modal-body{ display:grid; gap:18px; margin-top:6px; }

    .form-row label{
      display:block; font-size:.9rem; font-weight:600; color:var(--text);
      margin-bottom:8px;
    }
    .modal-input, .modal-textarea{
      width:100%; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px;
      padding:14px 16px; font-size:.95rem; font-family:inherit;
      transition:border-color .15s, box-shadow .15s;
    }
    .modal-input:focus, .modal-textarea:focus{
      outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring);
    }
    .modal-input[disabled]{ cursor:not-allowed; opacity:.8; background:#f1f5f9; }
    .modal-textarea{ min-height:110px; resize:vertical; }

    .modal-actions{
      margin-top:24px; padding-top:16px; border-top:1px solid #e2e8f0;
      display:flex; justify-content:flex-end; gap:12px;
    }
    .btn-cancel{
      background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1;
      padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-cancel:hover{ background:#e2e8f0; }
    .btn-primary{
      background:var(--accent-2); color:#fff; padding:10px 18px; border-radius:8px;
      font-weight:600; cursor:pointer;
    }
    .btn-primary:hover{ opacity:.9; transform:translateY(-1px); }
    .btn-danger{
      background:var(--danger); color:#fff; padding:10px 18px;
      border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-danger:hover{ opacity:.9; transform:translateY(-1px); }

    /* =========================
      Utilities
    ========================= */
    .error{ margin-top:6px; color:var(--danger); font-size:.9rem; display:none; }

    @keyframes fadeIn{
      from{ opacity:0; transform:scale(.95); }
      to{ opacity:1; transform:scale(1); }
    }

    .flash-success td {
      background:#dcfce7 !important;
      transition: background-color 1200ms ease-in-out;
    }
    @media (prefers-reduced-motion: reduce) {
      .flash-success td { transition: none; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>Category Management</h1>
      <div class="header-controls">
        <button class="btn-dashboard" id="btnBackToDash">Return to Dashboard</button>
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          <input type="text" id="search" placeholder="Search by keyword...">
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="categoryTable">
        <colgroup>
          <col style="width: 20%"> <!-- Name -->
          <col style="width: 40%"> <!-- Description -->
          <col style="width: 20%"> <!-- Status -->
          <col style="width: 20%"> <!-- Actions -->
        </colgroup>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr id="noResultsRow" style="display:none;">
            <td colspan="4" class="no-results">No results found.</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="footer">
      <span>© 2025 Community Support Platform</span>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
      <h2 id="editTitle">Edit Category</h2>

      <div class="modal-body">
        <div class="form-row">
          <label for="editName">Name <span style="color:var(--muted)">*</span></label>
          <input type="text" id="editName" class="modal-input" placeholder="Category name"/>
          <small class="hint">Required. 1–64 characters.</small>
          <div id="editErr-name" class="error">Please enter a valid name (1–64 characters).</div>
        </div>

        <div class="form-row">
          <label for="editDesc">Description <span style="color:var(--muted)">*</span></label>
          <textarea id="editDesc" class="modal-textarea" placeholder="Short description"></textarea>
          <small class="hint">Required. Up to 255 characters.</small>
          <div id="editErr-desc" class="error">Description must be 255 characters or fewer.</div>
        </div>

        <div id="statusMsg" class="success" role="status" aria-live="polite" style="display:none;"></div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="editModalCancelBtn">Cancel</button>
          <button type="button" class="btn-primary" id="editModalSaveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Archive Modal -->
  <div class="modal" id="archiveModal" role="dialog" aria-modal="true" aria-labelledby="archiveTitle">
    <div class="modal-content">
      <h2 id="archiveTitle">Confirm Archive</h2>
      <p>Are you sure you want to archive this category?</p>
      <div class="modal-actions">
        <button class="btn-cancel" id="archiveModalCancelBtn">Cancel</button>
        <button class="btn-danger" id="archiveModalConfirmBtn">Archive</button>
      </div>
    </div>
  </div>

  <!-- Restore Modal -->
  <div class="modal" id="restoreModal" role="dialog" aria-modal="true" aria-labelledby="restoreTitle">
    <div class="modal-content">
      <h2 id="restoreTitle">Confirm Restore</h2>
      <p>Are you sure you want to restore this category?</p>
      <div class="modal-actions">
        <button class="btn-cancel" id="restoreModalCancelBtn">Cancel</button>
        <button class="btn-primary" id="restoreModalConfirmBtn">Restore</button>
      </div>
    </div>
  </div>

  <script>
  /* =========================================================
    1) Config & constants
  ========================================================= */
  const DEBUG          = false;
  const API_URL        = "http://127.0.0.1:80/api";
  const CATEGORIES_API = `${API_URL}/categories`;

  const STATUS = { ACTIVE:"ACTIVE", ARCHIVED:"ARCHIVED" };
  const NAME_MAX = 64, DESC_MAX = 255;

  /* =========================================================
    2) DOM shortcuts
  ========================================================= */
  const $  = (id) => document.getElementById(id);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const DOM = {
    // Table
    table: $("categoryTable"),
    tbody: $("categoryTable")?.querySelector("tbody"),
    noResultsRow: $("noResultsRow"),
    search: $("search"),

    // Edit modal
    editModal: $("editModal"),
    editName: $("editName"),
    editDesc: $("editDesc"),
    editErrName: $("editErr-name"),
    editErrDesc: $("editErr-desc"),
    statusMsg: $("statusMsg"),
    editCancel: $("editModalCancelBtn"),
    editSave: $("editModalSaveBtn"),

    // Archive modal
    archiveModal: $("archiveModal"),
    archiveCancel: $("archiveModalCancelBtn"),
    archiveConfirm: $("archiveModalConfirmBtn"),

    // Restore modal
    restoreModal: $("restoreModal"),
    restoreCancel: $("restoreModalCancelBtn"),
    restoreConfirm: $("restoreModalConfirmBtn"),

    // Nav
    btnBackToDash: $("btnBackToDash"),
  };

  /* =========================================================
    3) Utilities
  ========================================================= */
  const log = (...a)=>{ if(DEBUG) console.log("[categories]", ...a); };
  const norm = (s)=> String(s ?? "").trim().toLowerCase();
  const collapse = (s)=> String(s ?? "").replace(/\s+/g," ").trim();
  const hasText = (s)=> collapse(s).length > 0;

  const escapeHTML = (s)=>
    String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");

  // Status message helpers
  function showStatusError(msg){
    DOM.statusMsg.style.display="block";
    DOM.statusMsg.style.background="#fee2e2";
    DOM.statusMsg.style.border="1px solid #fecaca";
    DOM.statusMsg.style.color="#991b1b";
    DOM.statusMsg.style.whiteSpace="normal";
    DOM.statusMsg.textContent = msg;
  }
  function showStatusDebug(endpoint, payload){
    DOM.statusMsg.style.display="block";
    DOM.statusMsg.style.background="#fef9c3";
    DOM.statusMsg.style.border="1px solid #fde047";
    DOM.statusMsg.style.color="#854d0e";
    DOM.statusMsg.style.whiteSpace="pre-wrap";
    DOM.statusMsg.textContent = `[DEBUG]\nPUT ${endpoint}\n\n${JSON.stringify(payload,null,2)}`;
  }
  function clearStatus(){ DOM.statusMsg.style.display="none"; DOM.statusMsg.textContent=""; }

  function flashRow(tr) {
    if (!tr) return;
    tr.classList.remove("flash-success"); // allow re-trigger
    void tr.offsetWidth;
    tr.classList.add("flash-success");
    setTimeout(() => tr && tr.classList.remove("flash-success"), 1400);
  }

  /* =========================================================
    4) State
  ========================================================= */
  let allCategories = [];
  let currentRow = null;          // <tr> currently being edited
  let pendingArchiveRow = null;   // <tr> awaiting archive confirm
  let pendingRestoreRow = null;   // <tr> awaiting restore confirm

  // Request guards
  let editing=false, archiving=false, restoring=false;

  /* =========================================================
    5) API layer
  ========================================================= */
  async function fetchJSON(url, options={}){
    const res = await fetch(url, { credentials:"include", mode:"cors", ...options });
    const ct  = res.headers.get("content-type") || "";
    let data=null; try{ data = ct.includes("application/json") ? await res.json() : await res.text(); }catch{}
    return { ok: res.ok, status: res.status, data };
  }

  async function loadCategories(){
    try{
      const { ok, status, data } = await fetchJSON(CATEGORIES_API, { method:"GET" });
      if(!ok) throw new Error(`Failed to load categories (${status})`);
      const list = Array.isArray(data?.categories) ? data.categories : [];
      allCategories = list;
      renderRows(allCategories);
    }catch(e){
      console.error(e);
      allCategories = [];
      renderRows(allCategories);
      showStatusError("Unable to load categories. Please try again later.");
    }
  }

  async function loadCategoriesBySearch(keyword){
    try{
      const { ok, status, data } = await fetchJSON(`${CATEGORIES_API}/search?keyword=${encodeURIComponent(keyword)}`, { method:"GET" });
      if(!ok) throw new Error(`Failed to load categories (${status})`);
      const list = Array.isArray(data?.categories) ? data.categories : [];
      allCategories = list;
      renderRows(allCategories);
    }catch(e){
      console.error(e);
      allCategories = [];
      renderRows(allCategories);
      showStatusError("Unable to load categories. Please try again later.");
    }
  }

  async function updateCategoryAPI(key, payload){
    return fetchJSON(`${CATEGORIES_API}/${key}`,{
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
  }

  async function archiveCategoryAPI(key){
    return fetchJSON(`${CATEGORIES_API}/${key}/archive`, { method:"POST" });
  }

  async function restoreCategoryAPI(key){
    return fetchJSON(`${CATEGORIES_API}/${key}/restore`, { method:"POST" });
  }

  /* =========================================================
    6) Rendering
  ========================================================= */
  function getStatusBadgeHTML(statusStr){
    return String(statusStr).toUpperCase() === STATUS.ARCHIVED
      ? '<span class="badge badge-suspended">Archived</span>'
      : '<span class="badge badge-active">Active</span>';
  }

  function getActionButtonHTML(statusStr){
    return String(statusStr).toUpperCase() === STATUS.ARCHIVED
      ? '<button class="btn-reactivate" onclick="openRestoreModal(this)">Restore</button>'
      : '<button class="btn-suspend" onclick="openArchiveModal(this)">Archive</button>';
  }

  function rowHTML(cat){
    const rawName = String(cat?.name ?? "");
    const status  = (cat?.status || STATUS.ACTIVE).toUpperCase();
    const name    = escapeHTML(cat?.name);
    const desc    = escapeHTML(cat?.description);
    const key     = encodeURIComponent(rawName);

    return `
      <tr data-key="${key}" data-raw="${rawName}" data-status="${status}">
        <td class="name">${name}</td>
        <td class="description">${desc}</td>
        <td class="status">${getStatusBadgeHTML(status)}</td>
        <td class="actions">
          <div class="btn-row">
            <button class="btn-edit" onclick="openEditModal(this.closest('tr'))">Edit</button>
            ${getActionButtonHTML(status)}
          </div>
        </td>
      </tr>
    `;
  }

  function renderRows(categories){
    DOM.tbody.innerHTML = categories
      .slice()
      .sort((a,b)=> String(a.name).localeCompare(String(b.name), undefined, { sensitivity:"base" }))
      .map(rowHTML)
      .join("");
    updateNoResultsRow();
  }

  function updateNoResultsRow(){
    const rows = $$("#categoryTable tbody tr");
    const anyVisible = rows.some(r => r.style.display !== "none");
    DOM.noResultsRow.style.display = anyVisible ? "none" : "";
  }

  function setRowState(tr, nextStatus){
    const status = (nextStatus || STATUS.ACTIVE).toUpperCase();
    tr.dataset.status = status;
    tr.querySelector(".status").innerHTML = getStatusBadgeHTML(status);

    const btnRow = tr.querySelector(".actions .btn-row");
    const curAct = btnRow.querySelector(".btn-suspend, .btn-reactivate");
    const tmp = document.createElement("div");
    tmp.innerHTML = getActionButtonHTML(status);
    const fresh = tmp.firstElementChild;
    curAct ? curAct.replaceWith(fresh) : btnRow.appendChild(fresh);
  }

  /* =========================================================
    7) Modal logic + validation
  ========================================================= */
  function openEditModal(tr){
    currentRow = tr;
    DOM.editName.value = tr.querySelector(".name")?.textContent?.trim() || "";
    DOM.editDesc.value = tr.querySelector(".description")?.textContent?.trim() || "";

    // reset field errors + status
    clearStatus();
    [DOM.editErrName, DOM.editErrDesc].forEach(el => el.style.display="none");
    [DOM.editName, DOM.editDesc].forEach(el => el.removeAttribute("aria-invalid"));

    DOM.editModal.style.display="flex";
  }
  function closeEditModal(){
    DOM.editModal.style.display="none";
    [DOM.editName, DOM.editDesc].forEach(el => { el.disabled=false; el.removeAttribute("aria-invalid"); });
    [DOM.editErrName, DOM.editErrDesc].forEach(el => el.style.display="none");
    clearStatus();
  }

  function validateNameInline(){
    const el  = DOM.editName;
    const raw = el.value;   // keep what user typed
    const v   = raw.trim(); // use trimmed for checks

    if(!hasText(v) || v.length > NAME_MAX){
      DOM.editErrName.textContent = `Please enter a valid name (1–${NAME_MAX} characters).`;
      DOM.editErrName.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    DOM.editErrName.style.display="none";
    el.removeAttribute("aria-invalid");
    return true;
  }

  function validateDescInline(){
    const el = DOM.editDesc;
    const v  = el.value.trim();

    if(!hasText(v) || v.length > DESC_MAX){
      DOM.editErrDesc.textContent = `Description must be ${DESC_MAX} characters or fewer.`;
      DOM.editErrDesc.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    DOM.editErrDesc.style.display="none";
    el.removeAttribute("aria-invalid");
    return true;
  }

  function validateEditForm(){
    const a = validateNameInline();
    const b = validateDescInline();
    if(!a){ DOM.editName.focus({preventScroll:true}); return false; }
    if(!b){ DOM.editDesc.focus({preventScroll:true}); return false; }
    return true;
  }

  async function saveEditModal(){
    if(editing || !currentRow) return;
    if(!validateEditForm()) return;

    editing = true;
    clearStatus();

    // read what the user typed
    const nameRaw = DOM.editName.value;
    const descRaw = DOM.editDesc.value;

    // normalize for persistence
    const name        = collapse(nameRaw);
    const description = collapse(descRaw);

    // current values from row
    const curRaw  = currentRow.dataset.raw;
    const curDesc = currentRow.querySelector(".description").textContent.trim();
    const curKey  = currentRow.dataset.key;

    // lock UI
    const origText = DOM.editSave.textContent;
    DOM.editSave.disabled = true;  DOM.editSave.textContent = "Updating...";
    DOM.editCancel.disabled = true;
    [DOM.editName, DOM.editDesc].forEach(el => el.disabled = true);

    // nothing changed
    if(name === curRaw && description === curDesc){
      await new Promise(r => setTimeout(r, 300));
      DOM.editSave.disabled=false; DOM.editSave.textContent = origText;
      DOM.editCancel.disabled=false;
      [DOM.editName, DOM.editDesc].forEach(el => el.disabled = false);
      editing=false;
      closeEditModal();
      return;
    }

    // DEBUG path
    if(DEBUG){
      showStatusDebug(`${CATEGORIES_API}/${curKey}`, { name, description });
      await new Promise(r => setTimeout(r, 400));
      DOM.editSave.disabled=false; DOM.editSave.textContent = origText;
      DOM.editCancel.disabled=false;
      [DOM.editName, DOM.editDesc].forEach(el => el.disabled = false);
      editing=false;
      return;
    }

    try{
      const { ok, status } = await updateCategoryAPI(curKey, { name, description });
      if(!ok) throw new Error(`Update failed (${status})`);

      // Update row
      currentRow.querySelector(".name").textContent = name;
      currentRow.querySelector(".description").textContent = description;
      currentRow.dataset.raw = name;
      currentRow.dataset.key = encodeURIComponent(name);

      // Update cache
      const i = allCategories.findIndex(p => norm(p.name) === norm(curRaw));
      if(i !== -1) allCategories[i] = { ...allCategories[i], name, description };

      flashRow(currentRow);

      await new Promise(r => setTimeout(r, 500));
      closeEditModal();
    }catch(e){
      console.error(e);
      showStatusError("Could not save changes. Please try again.");
    }finally{
      DOM.editSave.disabled=false; DOM.editSave.textContent = origText;
      DOM.editCancel.disabled=false;
      [DOM.editName, DOM.editDesc].forEach(el => el.disabled = false);
      editing=false;
    }
  }

  // Archive modal
  function openArchiveModal(button){
    pendingArchiveRow = button.closest("tr");
    DOM.archiveModal.style.display="flex";
  }

  function closeArchiveModal(){
    DOM.archiveModal.style.display="none";
    pendingArchiveRow = null;
  }

  async function confirmArchive(){
    if(!pendingArchiveRow || archiving) return;
    archiving = true;

    const key = pendingArchiveRow.dataset.key;
    const origText = DOM.archiveConfirm.textContent;
    DOM.archiveConfirm.disabled=true; DOM.archiveConfirm.textContent="Archiving...";
    DOM.archiveCancel.disabled=true;

    try{
      const { ok, status } = await archiveCategoryAPI(key);
      if(!ok) throw new Error(`Archive failed (${status})`);
      setRowState(pendingArchiveRow, STATUS.ARCHIVED);
      flashRow(pendingArchiveRow);
    }catch(e){
      console.error(e);
      showStatusError("Could not archive the category. Please try again.");
    }finally{
      await new Promise(r => setTimeout(r, 500));
      DOM.archiveConfirm.disabled=false; DOM.archiveConfirm.textContent=origText;
      DOM.archiveCancel.disabled=false;
      archiving=false;
      closeArchiveModal();
    }
  }

  // Restore modal
  function openRestoreModal(button){
    pendingRestoreRow = button.closest("tr");
    DOM.restoreModal.style.display="flex";
  }

  function closeRestoreModal(){
    DOM.restoreModal.style.display="none";
    pendingRestoreRow = null;
  }

  async function confirmRestore(){
    if(!pendingRestoreRow || restoring) return;
    restoring = true;

    const key = pendingRestoreRow.dataset.key;
    const origText = DOM.restoreConfirm.textContent;
    DOM.restoreConfirm.disabled=true; DOM.restoreConfirm.textContent="Restoring...";
    DOM.restoreCancel.disabled=true;

    try{
      const { ok, status } = await restoreCategoryAPI(key);
      if(!ok) throw new Error(`Restore failed (${status})`);
      setRowState(pendingRestoreRow, STATUS.ACTIVE);
      flashRow(pendingRestoreRow);
    }catch(e){
      console.error(e);
      showStatusError("Could not restore the category. Please try again.");
    }finally{
      await new Promise(r => setTimeout(r, 500));
      DOM.restoreConfirm.disabled=false; DOM.restoreConfirm.textContent=origText;
      DOM.restoreCancel.disabled=false;
      restoring=false;
      closeRestoreModal();
    }
  }

  /* =========================================================
    8) Search
  ========================================================= */
  function handleSearchInput(){
    const q = DOM.search.value.trim().toLowerCase();
    loadCategoriesBySearch(q);
    updateNoResultsRow();
  }

  /* =========================================================
    9) Boot
  ========================================================= */
  (async function init(){
    await loadCategories();

    // Search
    DOM.search.addEventListener("input", handleSearchInput);

    // Edit modal events
    DOM.editSave.addEventListener("click", saveEditModal);
    DOM.editCancel.addEventListener("click", closeEditModal);
    DOM.editName.addEventListener("input", validateNameInline);
    DOM.editName.addEventListener("blur",  validateNameInline);
    DOM.editDesc.addEventListener("input", validateDescInline);
    DOM.editDesc.addEventListener("blur",  validateDescInline);

    // Archive modal events
    DOM.archiveConfirm.addEventListener("click", confirmArchive);
    DOM.archiveCancel.addEventListener("click", closeArchiveModal);

    // Restore modal events
    DOM.restoreConfirm.addEventListener("click", confirmRestore);
    DOM.restoreCancel.addEventListener("click", closeRestoreModal);

    // Nav
    DOM.btnBackToDash.addEventListener("click", ()=>{ window.location.href = "platform_dashboard.html"; });
  })();

  window.openEditModal = openEditModal;
  window.openArchiveModal = openArchiveModal;
  window.openRestoreModal = openRestoreModal;
  </script>
</body>
</html>
