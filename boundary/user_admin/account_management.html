<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Management</title>
  <style>
    :root{
      --bg:#f0f9ff; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --accent:#38bdf8; 
      --accent-2:#0ea5e9; 
      --danger:#ef4444;
      --ring:rgba(14,165,233,.3); 
      --radius:16px;
      --actions-w:170px;
    }

    /* ===== Base / Layout ===== */
    *{ box-sizing:border-box; }
    html,body{ min-height:100%; margin:0; }
    body{
      font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:linear-gradient(180deg,#e0f2fe,var(--bg));
      color:var(--text);
      display:flex; justify-content:center; align-items:flex-start;
      padding:24px; min-height:100svh; overflow:hidden;
    }
    .card{
      width:100%; max-width:1000px; height:calc(100svh - 48px);
      background:var(--card); border:1px solid #e2e8f0; border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.1);
      overflow:hidden; display:flex; flex-direction:column;
    }

    /* ===== Page Header ===== */
    .header{
      padding:18px 24px; background:linear-gradient(180deg,#e0f2fe,#f8fafc);
      border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;
    }
    .header h1{ margin:0; font-size:1.5rem; color:var(--accent-2); }
    .header-controls{ display:flex; align-items:center; gap:12px; }
    .btn-dashboard{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:#fff; border:0; border-radius:10px; padding:10px 18px; font-size:.9rem; font-weight:600;
      cursor:pointer; box-shadow:0 3px 6px rgba(0,0,0,.1); transition:.2s;
    }
    .btn-dashboard:hover{ transform:scale(1.05); opacity:.9; }
    .search-box input{
      width:240px; padding:10px 14px; border-radius:12px; border:1px solid #cbd5e1; font-size:.95rem;
    }
    .search-box input:focus{ border-color:var(--accent-2); outline:none; box-shadow:0 0 0 3px var(--ring); }

    /* ===== Table Wrapper ===== */
    .table-wrap{
      flex:1; min-height:0; overflow-y:auto; overflow-x:auto; scrollbar-gutter:stable; position:relative;
    }

    /* ===== Table ===== */
    table{
      width:100%; min-width:2000px; border-collapse:collapse; table-layout:fixed;
    }

    /* Sticky header */
    thead th{
      position:sticky; top:0; z-index:15;
      background:#f8fafc; box-shadow:0 1px 0 #e2e8f0;
    }

    /* Base cells */
    th,td{
      padding:14px 16px; min-width:0; text-align:left; vertical-align:middle;
      border-bottom:1px solid #e2e8f0; overflow:hidden; text-overflow:ellipsis;
      background:var(--card);
    }

    /* Row backgrounds (opaque) */
    tbody tr:nth-child(odd) td{ background:#fcfdff; }
    tbody tr:hover td{ background:#f9fafb; }

    /* Content tweaks */
    td.address{ white-space:normal; line-height:1.35; }
    td.status{ text-align:center; padding-right:20px; white-space:nowrap; }

    /* ===== Sticky Actions Column ===== */
    th.actions,
    td.actions{
      width:var(--actions-w); min-width:var(--actions-w); max-width:var(--actions-w);
      padding:0;
    }

    /* Header cell */
    thead th.actions{
      position:sticky; right:0; z-index:60;                      
      text-align:center;
      background:#f8fafc;
      border-left:1px solid #e2e8f0;
      box-shadow:-8px 0 12px rgba(0,0,0,.06);
    }

    th.status { text-align: center;}

    /* Body cells (sticky) */
    tbody td.actions{
      position:sticky; right:0; z-index:40;
      background:var(--card);
      border-left:1px solid #e2e8f0;
      box-shadow:-8px 0 12px rgba(0,0,0,.06);
      padding:12px 16px;
    }

    tbody td.actions::before{
      content:"";
      position:absolute;
      left:-8px; top:0; bottom:0; width:8px;
      background:var(--card); pointer-events:none;
    }
    tbody tr:nth-child(odd) td.actions::before{ background:#fcfdff; }
    tbody tr:hover td.actions::before{ background:#f9fafb; }

    /* Buttons layout inside Actions */
    td.actions .btn-row{
      display:flex; justify-content:center; align-items:center; gap:10px;
    }

    /* ===== Buttons & Badges ===== */
    .btn-edit, .btn-suspend, .btn-reactivate{
      padding:6px 14px; border-radius:8px; border:0; cursor:pointer; font-size:.85rem; white-space:nowrap;
    }
    .btn-edit{ background:var(--accent-2); color:#fff; }
    .btn-suspend{ background:var(--danger); color:#fff; }
    .btn-reactivate{ background:#22c55e; color:#fff; }
    .btn-edit:hover, .btn-suspend:hover, .btn-reactivate:hover{ opacity:.85; }
    .btn-suspend[disabled]{ opacity:.6; cursor:not-allowed; }
    .btn-reactivate[disabled]{ opacity:.6; cursor:not-allowed; }

    .badge{
      display:inline-block; padding:4px 10px; border-radius:9999px;
      font-size:.78rem; font-weight:600; line-height:1; white-space:nowrap;
    }
    .badge-active{ background:#dcfce7; color:#166534; border:1px solid #86efac; }
    .badge-suspended{ background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }

    .no-results{ text-align:center; color:var(--muted); padding:24px !important; }

    /* ===== Modals ===== */
    .modal{
      display:none; position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
      justify-content:center; align-items:center;
    }
    .modal-content{
      width:min(640px, 92vw); background:#fff; border-radius:16px; padding:32px 36px;
      box-shadow:0 8px 30px rgba(0,0,0,.25); animation:fadeIn .2s ease-in-out;
    }
    .modal-content h2{
      margin:0 0 18px; font-size:1.25rem; font-weight:700; color:var(--text);
      border-bottom:1px solid #e2e8f0; padding-bottom:8px;
    }
    .modal-body{ display:grid; gap:14px; margin-top:6px; }
    .form-row label{ display:block; font-size:.9rem; font-weight:600; color:var(--text); margin-bottom:6px; }

    .modal-input, .modal-textarea, .modal-select{
      width:100%; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px; margin-top: 6px;
      padding:14px 16px; font-size:.96rem; font-family:inherit; transition:border-color .15s, box-shadow .15s;
    }
    .modal-input:focus, .modal-textarea:focus{ outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring); }
    .modal-textarea{ min-height:96px; resize:vertical; }

    .modal-input:disabled,
    .modal-textarea:disabled,
    .modal-select:disabled { 
      background:#f1f5f9; 
      color:#94a3b8; 
      cursor:not-allowed; 
    }

    .modal-actions{
      margin-top:24px; padding-top:12px; border-top:1px solid #e2e8f0;
      display:flex; justify-content:flex-end; gap:10px;
    }

    /* modal buttons */
    .btn-cancel{
      background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1;
      padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-cancel:hover{ background:#e2e8f0; }
    .btn-primary{
      background:var(--accent-2); color:#fff; padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-primary:hover{ opacity:.9; transform:translateY(-1px); }
    .btn-danger{
      background:var(--danger); color:#fff; padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-danger:hover{ opacity:.9; transform:translateY(-1px); }

    @keyframes fadeIn{ from{opacity:0; transform:scale(.95);} to{opacity:1; transform:scale(1);} }

    /* ===== Edit Modal Grid ===== */
    .modal-content .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:24px 20px; }
    .modal-content .row{ display:flex; flex-direction:column; }
    .modal-content .hint{ margin-top:6px; font-size:.85rem; color:var(--muted); }
    .modal-content .error{ margin-top:6px; color:var(--danger); font-size:.9rem; display:none; }
    @media (max-width:640px){ .modal-content .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>Account Management</h1>
      <div class="header-controls">
        <button class="btn-dashboard" onclick="returnToDashboard()">Return to Dashboard</button>
        <div class="search-box">
          <input type="text" id="search" placeholder="Search by keyword...">
        </div>
      </div>
    </div>

  <div class="table-wrap">
    <table id="profileTable">
      <colgroup>
        <col style="width: 14%">   <!-- Full Name -->
        <col style="width: 16%">   <!-- Email -->
        <col style="width: 12%">   <!-- Username -->
        <col style="width: 10%">   <!-- Phone -->
        <col style="width: 18%">   <!-- Address (allows wrapping) -->
        <col style="width: 8%">   <!-- Date of Birth -->
        <col style="width: 10%">   <!-- Profile -->
        <col style="width: 8%">   <!-- Created At -->
        <col style="width: 10%">    <!-- Status -->
        <col style="width: 170px"> <!-- Actions -->
      </colgroup>
      <thead>
        <tr>
          <th class="full_name">Full Name</th>
          <th class="email">Email</th>
          <th class="username">Username</th>
          <th class="phone_number">Phone Number</th>
          <th class="address">Address</th>
          <th class="dob">Date of Birth</th>
          <th class="profile">Profile</th>
          <th class="created_at">Created At</th>
          <th class="status">Status</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr id="noResultsRow" style="display:none;">
          <td colspan="10" class="no-results">No results found.</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>Edit User</h2>

      <div class="modal-body">
        <form id="editForm" novalidate>
          <div class="grid">
            <!-- Full name -->
            <div class="row">
              <label for="editFullname">Full Name <span style="color:var(--muted)">*</span></label>
              <input id="editFullname" type="text" class="modal-input" maxlength="64" placeholder="e.g., Jane Doe"/>
              <small class="hint">Required. Up to 64 characters.</small>
              <div id="editErr-fullname" class="error">Please enter a name (max 64 chars).</div>
            </div>

            <!-- Username -->
            <div class="row">
              <label for="editUsername">Login ID <span style="color:var(--muted)">*</span></label>
              <input id="editUsername" type="text" class="modal-input" maxlength="32"
                    placeholder="e.g., janedoe123" pattern="^[A-Za-z0-9._-]{3,32}$"/>
              <small class="hint">Required. 3–32 chars: letters, numbers, dot, underscore, hyphen.</small>
              <div id="editErr-username" class="error">Please enter a valid Login ID (3–32 allowed chars).</div>
            </div>

            <!-- Email -->
            <div class="row">
              <label for="editEmail">Email <span style="color:var(--muted)">*</span></label>
              <input id="editEmail" type="email" class="modal-input" maxlength="254" placeholder="you@example.com"/>
              <small class="hint">Required.</small>
              <div id="editErr-email" class="error">Please enter a valid email.</div>
            </div>

            <!-- Phone -->
            <div class="row">
              <label for="editPhone">Phone Number <span style="color:var(--muted)">*</span></label>
              <input id="editPhone" type="tel" class="modal-input" minlength="8" maxlength="8"
                    placeholder="8123 4567" pattern="^[0-9]{8}$" inputmode="tel"/>
              <small class="hint">Required. 8 digits.</small>
              <div id="editErr-phone" class="error">Please enter a valid phone number.</div>
            </div>

            <!-- Address -->
            <div class="row" style="grid-column:1 / -1">
              <label for="editAddress">Address <span style="color:var(--muted)">*</span></label>
              <textarea id="editAddress" class="modal-textarea" maxlength="255"
                        placeholder="Block/Street, Unit, Postal Code"></textarea>
              <small class="hint">Required. Up to 255 characters.</small>
              <div id="editErr-address" class="error">Address is too long (max 255).</div>
            </div>

            <!-- DOB -->
            <div class="row">
              <label for="editDob">Date of Birth <span style="color:var(--muted)">*</span></label>
              <input id="editDob" type="date" class="modal-input" />
              <small class="hint">Required. Must be in the past.</small>
              <div id="editErr-dob" class="error">Please choose a valid date in the past.</div>
            </div>

            <!-- Profile -->
            <div class="row">
              <label for="editProfile">User Profile <span style="color:var(--muted)">*</span></label>
              <select id="editProfile" class="modal-input" required aria-describedby="hint-edit-profile">
                <option value="">Loading profiles…</option>
              </select>
              <small id="hint-edit-profile" class="hint">Required. Select a role.</small>
              <div id="editErr-profile" class="error">Please select a profile.</div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
            <button type="submit" class="btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Suspend Modal -->
  <div class="modal" id="suspendModal" role="dialog" aria-modal="true" aria-labelledby="suspendTitle">
    <div class="modal-content">
      <h2 id="suspendTitle">Suspend User</h2>
      <p id="suspendPrompt">Are you sure you want to suspend this user?</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSuspendModal()">Cancel</button>
        <button class="btn-danger" onclick="confirmSuspendUI()">Suspend</button>
      </div>
    </div>
  </div>

  <!-- Reactivate Modal -->
  <div class="modal" id="reactivateModal" role="dialog" aria-modal="true" aria-labelledby="reactivateTitle">
    <div class="modal-content">
      <h2 id="reactivateTitle">Confirm Reactivation</h2>
      <p>Are you sure you want to reactivate this account?</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeReactivateModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmReactivateUI()">Reactivate</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Constants & Endpoints
    // =========================
    const DEBUG        = false;
    const API_URL      = "http://127.0.0.1:80/api";
    const USERS_API    = `${API_URL}/users`;
    const PROFILES_API = `${API_URL}/user-profiles`;

    const STATUS = { ACTIVE : "ACTIVE", SUSPENDED : "SUSPENDED" }
    const CURRENT_USERNAME = (localStorage.getItem("username") ?? "").trim(); // who am I? 

    // =========================
    // DOM
    // =========================
    const $  = (id) => document.getElementById(id);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const els = {
      table: $("profileTable"),
      tbody: $("profileTable")?.querySelector("tbody"),
      search: $("search"),
      noResultsRow: $("noResultsRow"),

      // Edit modal
      editModal: $("editModal"),
      editForm: $("editForm"),
      editFullname: $("editFullname"),
      editUsername: $("editUsername"),
      editEmail: $("editEmail"),
      editPhone: $("editPhone"),
      editAddress: $("editAddress"),
      editDob: $("editDob"),
      editProfile: $("editProfile"),
      editErr: {
        fullname: $("editErr-fullname"),
        username: $("editErr-username"),
        email: $("editErr-email"),
        phone: $("editErr-phone"),
        address: $("editErr-address"),
        dob: $("editErr-dob"),
        profile: $("editErr-profile"),
      },

      // Suspend / Reactivate modals
      suspendModal: $("suspendModal"),
      reactivateModal: $("reactivateModal"),

      // Buttons
      primaryBtn: {
        edit: $("editModal")?.querySelector(".btn-primary"),
        suspend: $("suspendModal")?.querySelector(".btn-danger"),
        reactivate: $("reactivateModal")?.querySelector(".btn-primary"),
      },

      cancelBtn: {
        edit: $("editModal")?.querySelector(".btn-cancel"),
        suspend: $("suspendModal")?.querySelector(".btn-cancel"),
        reactivate: $("reactivateModal")?.querySelector(".btn-cancel"),
      }
    };

    // =========================
    // Utilities / Normalizers
    // =========================
    const log = (...args) => { if (DEBUG) console.log("[accounts]", ...args); };

    // used to normalize inputs
    const nonEmpty   = (s) => String(s ?? "").trim().length > 0;
    const collapse   = (s) => String(s ?? "").replace(/\s+/g, " ").trim();
    const lowerTrim  = (s) => collapse(s).toLowerCase();
    const digitsOnly = (s) => String(s ?? "").replace(/\D+/g, "");

    // used for field validations 
    const show = (el, on) => { if (el) el.style.display = on ? "block" : "none"; };

    const escapeHTML = (s) =>
      String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");

    const pastDateOnly = (value) => {
      if (!value) return true;
      const d = new Date(value), today = new Date();
      d.setHours(0,0,0,0); today.setHours(0,0,0,0);
      return d instanceof Date && !isNaN(d) && d < today;
    };

    const formatDateTime = (iso) => {
      if (!iso) return "—";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return String(iso);
      return new Intl.DateTimeFormat(undefined, {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      }).format(d);
    };

    function attachEditLiveValidation(fields, validateFn, debounceMs = 200) {
      let timer = null;
      fields.forEach((field) => {
        field.addEventListener("input", () => {
          if (!editHasSubmitted) return; // only live-validate after first submit
          clearTimeout(timer);
          timer = setTimeout(() => {
            validateFn();
          }, debounceMs);
        });
      });
    }

    attachEditLiveValidation(
      [els.editFullname, els.editUsername, els.editEmail, els.editPhone, els.editAddress],
      validateEditForm
    );

    ["editDob", "editProfile"].forEach(id => {
      $(id)?.addEventListener("change", () => {
        if (editHasSubmitted) validateEditForm();
      });
    });

    // =========================
    // Helpers
    // =========================
    function getRowUsername(row) {
      if (!row) return "";
      return (
        row.dataset.username ||
        row.querySelector(".username")?.textContent.trim() ||
        ""
      );
    }

    function sameUser(a, b) {
      return String(a ?? "").trim().toLowerCase() === String(b ?? "").trim().toLowerCase();
    }

    // =========================
    // API
    // =========================
    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, { credentials: "include", mode: "cors", ...options });
      const ct = res.headers.get("content-type") || "";
      let data = null;
      try {
        data = ct.includes("application/json") ? await res.json() : await res.text();
      } catch {}
      return { ok: res.ok, status: res.status, data };
    }

    // =========================
    // Rendering
    // =========================
    const statusBadgeHTML = (statusStr) => {
      if (String(statusStr || "").toUpperCase() === STATUS.SUSPENDED) {
        return '<span class="badge badge-suspended">Suspended</span>'
      }
      if (String(statusStr || "").toUpperCase() === STATUS.ACTIVE) {
        return '<span class="badge badge-active">Active</span>';
      }
      // Profile-level suspension
      return '<span class="badge badge-suspended">Suspended (Profile)</span>';
    }

    function actionButtonHTML(user) {
      const username       = String(user.username || "");
      const isSelf         = sameUser(username, CURRENT_USERNAME);
      const status         = String(user.status || "").toUpperCase();
      const profileSuspend = String(user.user_profile_status || "").toUpperCase() === STATUS.SUSPENDED;

      // If this is your own account -> disable suspend / reactivate
      if (isSelf) {
        return `<button class="btn-suspend" disabled title="You cannot suspend your own account">Suspend</button>`;
      }

      if (profileSuspend) {
        return `<button class="btn-reactivate" data-action="reinstate" disabled
                  title="This account is suspended via profile. Reinstate the profile first.">
                  Reinstate
                </button>`;
      }

      // Normal logic for other users
      return status === STATUS.ACTIVE
        ? `<button class="btn-suspend" data-action="suspend">Suspend</button>`
        : `<button class="btn-reactivate" data-action="reinstate">Reinstate</button>`;
    }

    function rowHTML(u) {
      const key = encodeURIComponent(String(u.user_id ?? u.username ?? ""));
      let status = String(u.status || STATUS.ACTIVE).toUpperCase();
      if (String(u.user_profile_status || "").toUpperCase() === STATUS.SUSPENDED)
        status = `${STATUS.SUSPENDED} (Profile)`;

      const fullname   = escapeHTML(u.fullname)        || "—";
      const email      = escapeHTML(u.email)           || "—";
      const username   = escapeHTML(u.username)        || "—";
      const phone      = escapeHTML(u.phone_number)    || "—";
      const address    = escapeHTML(u.address)         || "—";
      const dob        = escapeHTML(u.date_of_birth)   || "—";
      const profile    = escapeHTML(u.user_profile)    || "—";
      const created_at = formatDateTime(u.created_at);

      return `
        <tr 
          data-key="${key}" 
          data-user-id="${escapeHTML(String(u.user_id ?? ""))}" 
          data-username="${escapeHTML(String(u.username ?? ""))}"
          data-profile-suspended="${String(u.user_profile_status || "").toUpperCase() === STATUS.SUSPENDED}"
          data-status="${status}"
        >
          <td class="fullname">${fullname}</td>
          <td class="email">${email}</td>
          <td class="username">${username}</td>
          <td class="phone">${phone}</td>
          <td class="address">${address}</td>
          <td class="dob">${dob}</td>
          <td class="profile">${profile}</td>
          <td class="created_at">${created_at}</td>
          <td class="status">${statusBadgeHTML(status)}</td>
          <td class="actions">
            <div class="btn-row">
              <button class="btn-edit" data-action="edit">Edit</button>
              ${actionButtonHTML(u)}
            </div>
          </td>
        </tr>
      `;
    }

    function populateTable(users) {
      els.tbody.innerHTML = users
        .slice()
        .sort((a, b) => String(a.fullname || "").localeCompare(String(b.fullname || ""), undefined, { sensitivity: "base" }))
        .map(rowHTML)
        .join("");

      updateNoResults();
    }

    function updateNoResults() {
      const rows = $$("#profileTable tbody tr");
      const visible = rows.some(r => r.style.display !== "none");
      els.noResultsRow.style.display = visible ? "none" : "";
    }

    function applyStatusToRow(row, statusStr) {
      const status = (statusStr || STATUS.ACTIVE).toUpperCase();
      row.dataset.status = status;
      row.querySelector(".status").innerHTML = statusBadgeHTML(status);

      const btnRow = row.querySelector(".actions .btn-row");
      const swap = btnRow.querySelector(".btn-suspend, .btn-reactivate");

      const userForButtons = {
        username: row.dataset.username || row.querySelector(".username")?.textContent.trim() || "",
        status,
        user_profile_status: (row.dataset.profileSuspended === "true" ? STATUS.SUSPENDED : STATUS.ACTIVE)
      }

      const tmp = document.createElement("div");
      tmp.innerHTML = actionButtonHTML(userForButtons);
      const fresh = tmp.firstElementChild;
      swap ? swap.replaceWith(fresh) : btnRow.appendChild(fresh);
    }

    // =========================
    // State
    // =========================
    let allUsers               = [];
    let allProfiles            = [];
    let userProfilesStatusDict = {};

    let currentRow        = null; // editing
    let pendingSuspendRow = null;
    let pendingReactRow   = null;

    // Request guards
    let editing      = false; // editing user info (PUT/users/:id)
    let suspending   = false; // suspending an account (POST /users/:id/suspend)
    let reactivating = false; // reactivating an account (POST /users/:id/reinstate)

    let editHasSubmitted = false;

    // =========================
    // Load
    // =========================
    async function loadUsers() {
      els.tbody.innerHTML = `<tr><td colspan="10" class="no-results">Loading users…</td></tr>`;
      try {
        const { ok, status, data } = await fetchJSON(USERS_API, { method: "GET" });
        if (!ok) throw new Error(`Failed to load users (${status})`);

        let profile_res = await fetchJSON(PROFILES_API, { method: "GET" });
        if (!profile_res.ok) throw new Error(`Failed to load user profiles (${profile_res.status})`);

        allProfiles = Array.isArray(profile_res.data?.userProfiles) ? profile_res.data.userProfiles : [];
        
        userProfilesStatusDict = {}
        allProfiles.forEach( profile => {
          userProfilesStatusDict[profile.name] = profile.status;
        });

        allUsers = Array.isArray(data?.users) ? data.users : [];
        allUsers.forEach( user => {
          user.user_profile_status = userProfilesStatusDict[user.user_profile];
        });

        populateTable(allUsers);
      } catch (e) {
        console.error(e);
        els.tbody.innerHTML = `<tr><td colspan="10" class="no-results">Failed to load users.</td></tr>`;
      }
    }

    async function searchUsers(keyword) {
      els.tbody.innerHTML = `<tr><td colspan="10" class="no-results">Loading users…</td></tr>`;
      try {
        const { ok, status, data } = await fetchJSON(
          `${USERS_API}/search?keyword=${keyword}`, 
          { method: "GET" }
        );
        if (!ok) throw new Error(`Failed to load users (${status})`);

        let profile_res = await fetchJSON(PROFILES_API, { method: "GET" });
        if (!profile_res.ok) throw new Error(`Failed to load user profiles (${profile_res.status})`);

        allProfiles = Array.isArray(profile_res.data?.userProfiles) ? profile_res.data.userProfiles : [];
        
        userProfilesStatusDict = {}
        allProfiles.forEach( profile => {
          userProfilesStatusDict[profile.name] = profile.status;
        });

        allUsers = Array.isArray(data?.users) ? data.users : [];
        allUsers.forEach( user => {
          user.user_profile_status = userProfilesStatusDict[user.user_profile];
        });

        populateTable(allUsers);
      } catch (e) {
        console.error(e);
        els.tbody.innerHTML = `<tr><td colspan="10" class="no-results">Failed to load users.</td></tr>`;
      }
    }

    loadUsers();

    // =========================
    // Search
    // =========================
    els.search?.addEventListener("input", function () {
      applyFilter();
    });

    function applyFilter() {
      const q = els.search?.value.toLowerCase().trim() || "";
      searchUsers(q);
      // $$("#profileTable tbody tr").forEach(row => {
      //   row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
      // });
      updateNoResults();
    }

    // =========================
    // Edit Modal — Profiles dropdown
    // =========================
    async function loadProfilesForEdit(preselect, opts = {}) {
      const locked = !!opts.locked;
      const select = els.editProfile;

      // Always start disabled while loading
      select.disabled = true;

      // If editing yourself, render just your current profile and return early
      if (locked && preselect) {
        const label = String(preselect);
        select.innerHTML = `<option value="${label}">${label}</option>`;
        select.value = label;
        select.disabled = true;
        select.setAttribute("aria-disabled", "true");
        select.title = "You cannot change your own profile.";
        select.dataset.locked = true;
        return;
      }
      else {
        delete select.dataset.locked;
        select.title = "";
      }

      // normal (unlocked) load
      select.innerHTML = '<option value="">Loading profiles...</option>';

      try {
        const { ok, status, data } = await fetchJSON(PROFILES_API, { method: "GET" });
        if (!ok) throw new Error(`Profiles fetch failed (${status})`);

        const profiles = Array.isArray(data?.userProfiles) ? data.userProfiles : [];
        select.innerHTML = "";

        if (profiles.length === 0) {
          select.appendChild(new Option("No profiles available...", ""));
          select.disabled = true;
          return;
        }

        select.appendChild(new Option("Select a profile...", ""));
        profiles
          .filter(p => p?.name)
          .sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: "base" }))
          .forEach(p => select.appendChild(new Option(p.name, p.name)));

        if (preselect) select.value = preselect;
        select.disabled = profiles.length === 0;
        
      } catch (e) {
        console.error(e);
        select.innerHTML = "";
        select.appendChild(new Option("Error loading profiles", ""));
        select.disabled = true; // stay disabled on error
      }
    }

    // =========================
    // Edit Modal — Open/Close
    // =========================
    function setDobMaxToday() {
      const today = new Date().toISOString().split("T")[0];
      els.editDob?.setAttribute("max", today);
    }

    async function openEditModal(row) {
      currentRow = row;

      els.editFullname.value = row.querySelector(".fullname")?.textContent.trim() || "";
      els.editUsername.value = row.querySelector(".username")?.textContent.trim() || "";
      els.editEmail.value    = row.querySelector(".email")?.textContent.trim()    || "";
      els.editPhone.value    = row.querySelector(".phone")?.textContent.trim()    || "";
      els.editAddress.value  = row.querySelector(".address")?.textContent.trim()  || "";
      const rawDob           = row.querySelector(".dob")?.textContent.trim()      || "";
      els.editDob.value      = /^\d{4}-\d{2}-\d{2}$/.test(rawDob) ? rawDob : "";
      const curProfile       = row.querySelector(".profile")?.textContent.trim()  || "";

      // Reset field errors
      Object.values(els.editErr).forEach(el => show(el, false));
      [els.editFullname, els.editUsername, els.editEmail, els.editPhone, els.editAddress, els.editDob, els.editProfile]
        .forEach(f => f?.removeAttribute("aria-invalid"));
      editHasSubmitted = false;

      // --- Lock Profile change when editing yourself ---
      const rowUser = getRowUsername(row);
      const isSelf  = String(rowUser).trim().toLowerCase() === String(CURRENT_USERNAME).trim().toLowerCase();
      if (isSelf) els.editProfile.dataset.locked = "true"; else delete els.editProfile.dataset.locked;

      setDobMaxToday();
      els.editModal.style.display = "flex";
      await loadProfilesForEdit(curProfile, { locked: isSelf });
    }

    function closeEditModal() {
      els.editModal.style.display = "none";
      currentRow = null;
      Object.values(els.editErr).forEach(el => show(el, false));
      [els.editFullname, els.editUsername, els.editEmail, els.editPhone, els.editAddress, els.editDob, els.editProfile]
        .forEach(f => f?.removeAttribute("aria-invalid"));
      editHasSubmitted = false;
    }

    // =========================
    // Edit Modal — Validation & Save
    // =========================
    function validateEditForm() {
      let valid = true;

      // Normalize values
      const vName  = collapse(els.editFullname.value);
      const vLogin = collapse(els.editUsername.value);
      const vEmail = lowerTrim(els.editEmail.value);
      const vPhone = digitsOnly(els.editPhone.value);
      const vAddr  = collapse(els.editAddress.value);
      const vDob   = els.editDob.value;
      const vProf  = collapse(els.editProfile.value);

      // write back normalized values
      els.editFullname.value = vName;
      els.editUsername.value = vLogin;
      els.editEmail.value    = vEmail;
      els.editPhone.value    = vPhone;
      els.editAddress.value  = vAddr;

      // Full name: required, <= 64
      const okName = nonEmpty(vName) && vName.length <= 64;
      show(els.editErr.fullname, !okName);
      els.editFullname.toggleAttribute("aria-invalid", !okName);
      valid &&= okName;

      // Login ID: required, 3–32 allowed chars
      const okLogin = /^[A-Za-z0-9._-]{3,32}$/.test(vLogin);
      show(els.editErr.username, !okLogin);
      els.editUsername.toggleAttribute("aria-invalid", !okLogin);
      valid &&= okLogin;

      // Email: required, <= 254 and simple pattern
      const okEmail = /\S+@\S+\.\S+/.test(vEmail) && vEmail.length <= 254;
      show(els.editErr.email, !okEmail);
      els.editEmail.toggleAttribute("aria-invalid", !okEmail);
      valid &&= okEmail;

      // Phone: exactly 8 digits (SG style)
      const okPhone = /^\d{8}$/.test(vPhone);
      show(els.editErr.phone, !okPhone);
      els.editPhone.toggleAttribute("aria-invalid", !okPhone);
      valid &&= okPhone;

      // Address: required, <= 255
      const okAddr = nonEmpty(vAddr) && vAddr.length <= 255;
      show(els.editErr.address, !okAddr);
      els.editAddress.toggleAttribute("aria-invalid", !okAddr);
      valid &&= okAddr;

      // DOB: required, past
      const okDob = nonEmpty(vDob) && pastDateOnly(vDob);
      show(els.editErr.dob, !okDob);
      els.editDob.toggleAttribute("aria-invalid", !okDob);
      valid &&= okDob;

      // Profile: required unless the control is locked / disabled
      const profileLocked = els.editProfile.disabled || els.editProfile.dataset.locked === "true";
      const okProf = profileLocked ? true : (collapse(els.editProfile.value).length > 0);
      show(els.editErr.profile, !okProf);
      els.editProfile.toggleAttribute("aria-invalid", !okProf);
      valid &&= okProf;

      return valid;
    }

    async function saveEditModal() {
      if (editing) return;
      if (!validateEditForm()) return;
      if (!currentRow) return;

      editing = true;

      const id = currentRow.dataset.userId; 
      if (!id) {
        console.error("Missing data-user-id on row");
        alert("Internal error: missing row id.");
        editing = false;
        return;
      }

      const editBtn   = els.primaryBtn.edit;
      const cancelBtn = els.cancelBtn.edit;
      const origText  = editBtn?.textContent;

      if (editBtn)   { editBtn.disabled = true;  editBtn.textContent = "Updating..."; }
      if (cancelBtn) { cancelBtn.disabled = true; }

      // Freeze input fields during submit
      const formControls = [
        els.editFullname, els.editUsername, els.editEmail,
        els.editPhone, els.editAddress, els.editDob, els.editProfile
      ].filter(Boolean);
      formControls.forEach(el => el.disabled = true);

      const cur = {
        fullname:      currentRow.querySelector(".fullname")?.textContent.trim() || "",
        username:      currentRow.querySelector(".username")?.textContent.trim() || "",
        email:         currentRow.querySelector(".email")?.textContent.trim()    || "",
        phone_number:  currentRow.querySelector(".phone")?.textContent.trim()    || "",
        address:       currentRow.querySelector(".address")?.textContent.trim()  || "",
        date_of_birth: currentRow.querySelector(".dob")?.textContent.trim()      || "",
        user_profile:  currentRow.querySelector(".profile")?.textContent.trim()  || "",
      };

      const payload = {
        fullname:      els.editFullname.value.trim(),
        username:      els.editUsername.value.trim(),
        email:         els.editEmail.value.trim(),
        phone_number:  els.editPhone.value.trim(),
        address:       els.editAddress.value.trim(),
        date_of_birth: els.editDob.value.trim(),
        user_profile:  els.editProfile.value.trim(),
      };

      // --- Self Safeguard: prevent changing your own profile ---
      const rowUser = getRowUsername(currentRow);
      if (rowUser === CURRENT_USERNAME && payload.user_profile !== cur.user_profile) {
        if (editBtn)   { editBtn.disabled = false; editBtn.textContent = origText || "Save"; }
        if (cancelBtn) { cancelBtn.disabled = false; }
        formControls.forEach(el => el.disabled = false);
        editing = false;
        return;
      }

      // Early exit if nothing changed
      const changed = Object.keys(payload).some(k => String(payload[k] ?? "") !== String(cur[k] ?? ""));
      if (!changed) {
        await new Promise(r => setTimeout(r, 100));
        if (editBtn)   { editBtn.disabled = false; editBtn.textContent = origText || "Save"; }
        if (cancelBtn) { cancelBtn.disabled = false; }
        formControls.forEach(el => el.disabled = false);
        editing = false;
        closeEditModal();
        return;
      }

      if (DEBUG) {
        console.info("[DEBUG] PUT", `${USERS_API}/${id}`, payload);
        await new Promise(r => setTimeout(r, 400)); // brief visual feedback in debug
        if (editBtn)   { editBtn.disabled = false; editBtn.textContent = origText || "Save"; }
        if (cancelBtn) { cancelBtn.disabled = false; }
        formControls.forEach(el => el.disabled = false);
        editing = false;
        closeEditModal();
        return;
      }

      let updated = false;

      try {
        const { ok, status, data } = await fetchJSON(`${USERS_API}/${encodeURIComponent(id)}`, {
          method: "PUT",
          mode: "cors",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!ok) throw new Error(`Update failed (${status})`);

        // Update row in place
        if (payload.fullname      != null) currentRow.querySelector(".fullname").textContent = payload.fullname      || cur.fullname;
        if (payload.username      != null) currentRow.querySelector(".username").textContent = payload.username      || cur.username;
        if (payload.email         != null) currentRow.querySelector(".email").textContent    = payload.email         || cur.email;
        if (payload.phone_number  != null) currentRow.querySelector(".phone").textContent    = payload.phone_number  || cur.phone_number  || "—";
        if (payload.address       != null) currentRow.querySelector(".address").textContent  = payload.address       || cur.address       || "—";
        if (payload.date_of_birth != null) currentRow.querySelector(".dob").textContent      = payload.date_of_birth || cur.date_of_birth || "—";
        if (payload.user_profile  != null) currentRow.querySelector(".profile").textContent  = payload.user_profile  || cur.user_profile  || "—";

        // Update status and display badges accordingly
        const newProfile = (payload.user_profile || cur.user_profile || "").trim();
        const profStatus = String(userProfilesStatusDict?.[newProfile] ?? STATUS.ACTIVE).toUpperCase();
        currentRow.dataset.profileSuspended = (profStatus === STATUS.SUSPENDED);

        // Determine the users base status from previous display
        // If "SUSPENDED" (not profile), keep that; otherwise "ACTIVE"
        const prevDisplay = String(currentRow.dataset.status || "").toUpperCase();
        const ownBase     = (prevDisplay === STATUS.SUSPENDED) ? STATUS.SUSPENDED : STATUS.ACTIVE;

        // If profile is suspended -> display "Suspended (Profile)"; else keep base status
        const effective = (currentRow.dataset.profileSuspended === "true") ? "SUSPENDED_PROFILE" : ownBase;
        applyStatusToRow(currentRow, effective);

        updated = true;
      } 
      catch (e) {
        console.error(e);
        alert(e.message || "Could not save changes. Please try again.");
      } 
      finally {
        await new Promise(r => setTimeout(r, 1000));

        if (editBtn)   { editBtn.disabled = false; editBtn.textContent = origText || "Save"; }
        if (cancelBtn) { cancelBtn.disabled = false; }
        formControls.forEach(el => el.disabled = false);

        editing = false;

        if (updated) closeEditModal();
      }
    }

    // Hook up form submit & inputs live-validate 
    els.editForm?.addEventListener("submit", (e) => {
      e.preventDefault();
      editHasSubmitted = true;
      if (!validateEditForm()) return;
      saveEditModal();
    });

    // =========================
    // Suspend / Reinstate
    // =========================
    function openSuspendModal(button) {
      const row = button.closest("tr");
      const rowUser = row?.dataset.username || "";
      if (rowUser === CURRENT_USERNAME) {
        alert("You cannot suspend your own account.");
        return;
      }
      pendingSuspendRow = row;
      els.suspendModal.style.display = "flex";
    }

    function closeSuspendModal() {
      els.suspendModal.style.display = "none";
      pendingSuspendRow = null;
    }

    async function confirmSuspendUI() {
      if (!pendingSuspendRow || suspending) return;
      suspending = true;

      // --- Self-safeguard: prevent suspending yourself ---
      const rowUser = getRowUsername(pendingSuspendRow);
      if (rowUser === CURRENT_USERNAME) {
        alert("You cannot suspend your own account.");
        suspending = false;
        closeSuspendModal();
        return;
      }

      const key = pendingSuspendRow.dataset.key;
      const suspendBtn = els.primaryBtn.suspend;
      const cancelBtn = els.cancelBtn.suspend;
      const original = suspendBtn?.textContent;

      if (suspendBtn) { suspendBtn.disabled = true; suspendBtn.textContent = "Suspending..."; }
      if (cancelBtn)  { cancelBtn.disabled = true; }

      try {
        const { ok, status } = await fetchJSON(`${USERS_API}/${key}/suspend`, { method: "POST" });
        if (!ok) throw new Error(`Suspend failed (${status})`);
        applyStatusToRow(pendingSuspendRow, STATUS.SUSPENDED);
      } 
      catch (e) {
        console.error(e);
        alert("Could not suspend. Please try again.");
      } 
      finally {
        suspending = false;
        await new Promise(r => setTimeout(r, 1000));

        if (suspendBtn) { suspendBtn.disabled = false; suspendBtn.textContent = original || "Suspend"; }
        if (cancelBtn)  { cancelBtn.disabled = false; }
        
        closeSuspendModal();
      }
    }

    function openReactivateModal(button) {
      pendingReactRow = button.closest("tr");
      els.reactivateModal.style.display = "flex";
    }
    
    function closeReactivateModal() {
      els.reactivateModal.style.display = "none";
      pendingReactRow = null;
    }

    async function confirmReactivateUI() {
      if (!pendingReactRow || reactivating) return;
      reactivating = true;

      const key = pendingReactRow.dataset.key;
      const reactivateBtn = els.primaryBtn.reactivate;
      const cancelBtn = els.cancelBtn.reactivate;
      const original = reactivateBtn?.textContent;

      if (reactivateBtn) { reactivateBtn.disabled = true; reactivateBtn.textContent = "Reactivating..."; }
      if (cancelBtn)     { cancelBtn.disabled = true; }

      try {
        const { ok, status } = await fetchJSON(`${USERS_API}/${key}/reinstate`, { method: "POST" });
        if (!ok) throw new Error(`Reinstate failed (${status})`);
        applyStatusToRow(pendingReactRow, STATUS.ACTIVE);
      } 
      catch (e) {
        console.error(e);
        alert("Could not reactivate. Please try again.");
      } 
      finally {
        reactivating = false;
        await new Promise(r => setTimeout(r, 1000));

        // Re-enable both buttons
        if (reactivateBtn) { reactivateBtn.disabled = false; reactivateBtn.textContent = original || "Reactivate"; }
        if (cancelBtn)     { cancelBtn.disabled = false; }

        closeReactivateModal();
      }
    }

    // =========================
    // Table click delegation
    // =========================
    els.table?.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const row = e.target.closest("tr");
      if (!row) return;

      const action = btn.dataset.action;
      if (action === "edit")      return openEditModal(row);
      if (action === "suspend")   return openSuspendModal(btn);
      if (action === "reinstate") return openReactivateModal(btn);
    });

    // =========================
    // Navigation
    // =========================
    function returnToDashboard() { window.location.href = "admin_dashboard.html"; }
  </script>
</body>
</html>
