<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create User Profile</title>
  <style>
    /* =========================
      Design Tokens
    ========================== */
    :root {
      --bg: #f0f9ff;
      --card: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #38bdf8;
      --accent-2: #0ea5e9;
      --danger: #ef4444;
      --success-bg: #dcfce7;
      --success-text: #166534;
      --radius: 16px;
      --ring: rgba(14,165,233,.3);
    }

    /* =========================
      Base / Layout
    ========================== */
    * { box-sizing: border-box; }
    html, body { min-height: 100svh; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg, #e0f2fe, var(--bg));
      color: var(--text);
      display: grid; place-items: start center;
      padding: 24px; overflow: auto;
    }

    /* =========================
      Card
    ========================== */
    .card {
      width: 100%; max-width: 720px;
      background: var(--card); border: 1px solid #e2e8f0; border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: visible;
    }

    /* =========================
      Header
    ========================== */
    .header {
      padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(180deg, #e0f2fe, #f8fafc);
    }
    .header h1 { margin: 0 0 4px; font-size: 1.4rem; color: var(--accent-2); }
    .header p  { margin: 0; color: var(--muted); font-size: .95rem; }

    /* =========================
      Form & Fields
    ========================== */
    form { padding: 16px 20px 8px; }
    .row { display: flex; flex-direction: column; margin-bottom: 18px; }
    label { margin-bottom: 8px; font-weight: 600; color: var(--text); }

    input, textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      background: #f8fafc; border: 1px solid #cbd5e1; color: var(--text);
      font-size: .98rem; transition: border-color .2s, box-shadow .2s;
    }

    input:focus, textarea:focus {
      outline: none; border-color: var(--accent-2); box-shadow: 0 0 0 3px var(--ring);
    }
    textarea { min-height: 100px; resize: vertical; }

    /* Helper text / errors */
    .hint  { margin-top: 6px; font-size: .85rem; color: var(--muted); display: block; }
    .error { margin-top: 6px; color: var(--danger); font-size: .9rem; display: none; }

    /* =========================
      Actions & Buttons
    ========================== */
    .actions { display: flex; gap: 12px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
    button { border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; transition: transform .1s; }
    .btn-primary   { background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: #fff; }
    .btn-primary:hover { transform: scale(1.02); }
    .btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid #cbd5e1; }
    .btn-secondary:hover { background: #e2e8f0; }

    /* =========================
      Status Banner
    ========================== */
    .success { display: none; padding: 12px 14px; margin-top: 14px; border-radius: 12px; background: var(--success-bg); border: 1px solid #bbf7d0; color: var(--success-text); font-size: .95rem; }

    /* =========================
      Footer
    ========================== */
    .footer { padding: 18px 24px; border-top: 1px solid #e2e8f0; color: var(--muted); font-size: .9rem; display: flex; justify-content: space-between; flex-wrap: wrap; }

    /* =========================
      Responsive
    ========================== */
    @media (max-width: 640px) { .header, form, .footer { padding: 18px; } }
  </style>
</head>
<body>
  <div class="card" role="region">
    <div class="header">
      <h1>Create User Profile</h1>
      <p>Fill in the details below to add a new profile or role.</p>
    </div>

    <form id="profileForm" novalidate>
      <!-- Name (Required) -->
      <div class="row">
        <label for="name">Name <span style="color:var(--muted)">*</span></label>
        <input id="name" name="name" type="text" placeholder="e.g., User Admin, CSR Representative" required aria-describedby="name-hint err-name" autofocus />
        <small id="name-hint" class="hint">Required. 1–64 characters.</small>
        <div id="err-name" class="error">Please enter a valid, unique profile name.</div>
      </div>

      <!-- Description (optional) -->
      <div class="row">
        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Optional. Short description of this role." aria-describedby="desc-hint err-desc"></textarea>
        <small id="desc-hint" class="hint">Optional. Up to 255 characters.</small>
        <div id="err-desc" class="error">Description must be 255 characters or fewer.</div>
      </div>

      <!-- Other (optional) -->
      <div class="row">
        <label for="other">Other</label>
        <input id="other" name="other" type="text" placeholder="Optional notes or extra details." aria-describedby="oth-hint err-oth" />
        <small id="oth-hint" class="hint">Examples: “Emergency Contact”, “Case Manager”, “Senior Volunteer”.</small>
        <div id="err-oth" class="error">Other info must be 128 characters or fewer.</div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="submit" id="submitBtn">Submit</button>
        <button class="btn-secondary" type="reset">Clear</button>
        <button class="btn-secondary" type="button" onclick="returnToDashboard()">Return to Dashboard</button>
      </div>

      <div id="status" class="success" role="status" aria-live="polite"></div>
    </form>

    <div class="footer">
      <span>© 2025 Community Support Platform</span>
    </div>
  </div>

  <script>
    /* =========================================================
      1) Config & constants
    ========================================================= */
    const DEBUG        = false;
    const API_URL      = "http://127.0.0.1:80/api";
    const PROFILES_API = `${API_URL}/user-profiles`;

    // Limits
    const NAME_MAX = 64, DESC_MAX = 255, OTHER_MAX = 128;

    // Used to track whether a form was successfully submitted once
    const formCompletedRef = { value:false };

    /* =========================================================
      2) DOM
    ========================================================= */
    const $ = (id) => document.getElementById(id);
    const form      = $("profileForm");
    const submitBtn = $("submitBtn");
    const statusEl  = $("status");

    const input = {
      name:        $("name"),
      description: $("description"),
      other:       $("other"),
    };
    const err = {
      name:        $("err-name"),
      description: $("err-desc"),
      other:       $("err-oth"),
    };

    /* =========================================================
      3) Utils & status helpers
    ========================================================= */
    const collapse = (s)=> String(s ?? "").replace(/\s+/g, " ").trim();
    const nonEmpty = (s)=> collapse(s).length > 0;

    let hasSubmitted = false;
    let submitting   = false;

    function showOk(msg){
      statusEl.style.display = "block";
      statusEl.style.background = "#dcfce7";
      statusEl.style.border = "1px solid #bbf7d0";
      statusEl.style.color = "#166534";
      statusEl.style.marginTop = "14px"; // a little breathing room
      statusEl.setAttribute("aria-live", "polite");
      statusEl.textContent = msg;
      formCompletedRef.value = true;
    }
    function showErr(msg){
      statusEl.style.display = "block";
      statusEl.style.background = "#fee2e2";
      statusEl.style.border = "1px solid #fecaca";
      statusEl.style.color = "#991b1b";
      statusEl.style.marginTop = "14px";
      statusEl.setAttribute("aria-live", "assertive");
      statusEl.textContent = msg;
    }
    function showDebug(payload){
      statusEl.style.display = "block";
      statusEl.style.background = "#fef9c3";
      statusEl.style.border = "1px solid #fde047";
      statusEl.style.color = "#854d0e";
      statusEl.style.whiteSpace = "pre-wrap";
      statusEl.textContent = `[DEBUG]\nPOST ${PROFILES_API}\n\n${JSON.stringify(payload, null, 2)}`;
    }
    function clearStatus(){
      statusEl.style.display = "none";
      statusEl.textContent = "";
      statusEl.setAttribute("aria-live", "polite");
    }

    // Apply input constraints from constants (avoid drift)
    (function applyRuntimeConstraints(){
      const set = (el, prop, val) => { if (el && val != null) el[prop] = val; };

      set(input.name,        "maxLength", NAME_MAX);
      set(input.description, "maxLength", DESC_MAX);
      set(input.other,       "maxLength", OTHER_MAX);
    })();

    // After success, focus in any field resets the form once
    function attachPostSuccessReset(inputs, form, clearFn, flagRef){
      Object.values(inputs).forEach((f)=>{
        f.addEventListener("focus", ()=>{
          if(!flagRef.value) return;
          form.reset();
          clearFn();
          Object.values(inputs).forEach(el=> el.removeAttribute("aria-invalid"));
          flagRef.value = false;
        });
      });
    }

    /* =========================================================
      4) Validation (inline + on submit)
    ========================================================= */
    function validateName(){
      const v = collapse(input.name.value);
      const ok = nonEmpty(v) && v.length <= NAME_MAX;
      err.name.style.display = ok ? "none" : "block";
      input.name.toggleAttribute("aria-invalid", !ok);
      return ok;
    }

    function validateDesc(){
      const v = collapse(input.description.value);
      const ok = v.length <= DESC_MAX; // optional
      err.description.style.display = ok ? "none" : "block";
      input.description.toggleAttribute("aria-invalid", !ok);
      return ok;
    }

    function validateOther(){
      const v = collapse(input.other.value);
      const ok = v.length <= OTHER_MAX; // optional
      err.other.style.display = ok ? "none" : "block";
      input.other.toggleAttribute("aria-invalid", !ok);
      return ok;
    }

    function validateForm(){
      const a = validateName();
      const b = validateDesc();
      const c = validateOther();
      if(!a){ input.name.focus({preventScroll:true}); return false; }
      if(!b){ input.description.focus({preventScroll:true}); return false; }
      if(!c){ input.other.focus({preventScroll:true}); return false; }
      return true;
    }

    // Gentle live validation after first submit
    function attachLiveValidation(){
      const map = new Map([
        [input.name,        validateName],
        [input.description, validateDesc],
        [input.other,       validateOther],
      ]);

      let timer;
      
      map.forEach((fn, el) => {
        if (!el) return;
        
        el.addEventListener("input", () => {
          if (!hasSubmitted) return;
          clearTimeout(timer);
          timer = setTimeout(() => { clearStatus(); fn(); }, 300);
        });

        el.addEventListener("blur", () => {
          if (!hasSubmitted) return;
          clearTimeout(timer); clearStatus(); fn();
        });
      });
    }

    /* =========================================================
      5) Server boundary
    ========================================================= */
    async function displayServerMessage(response, { onSuccess } = {}){
      let body=null, serverMsg="";
      try{
        const ct = response.headers.get("content-type") || "";
        if(ct.includes("application/json")){
          body = await response.clone().json();
          serverMsg = body?.message || body?.error || "";
        }else{
          serverMsg = (await response.clone().text()).trim();
        }
      }catch{}

      if(response.ok === true){
        showOk(serverMsg || "Profile created successfully.");
        onSuccess?.(body);
        return;
      }
      else {
        showErr(serverMsg || "Profile creation failed. Please check your inputs.");
        return;
      }
    }

    /* =========================================================
      6) Submit / Reset / Nav
    ========================================================= */
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(submitting) return;
      submitting = true; hasSubmitted = true; clearStatus();

      if(!validateForm()){ submitting=false; return; }

      submitBtn.disabled = true;
      const payload = {
        name:        collapse(input.name.value),
        description: collapse(input.description.value),
        other:       collapse(input.other.value),
      };

      if(DEBUG){ showDebug(payload); submitBtn.disabled=false; submitting=false; hasSubmitted=false; return; }

      try{
        const res = await fetch(PROFILES_API, {
          method: "POST", mode: "cors", credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        await displayServerMessage(res, { onSuccess: ()=>{ formCompletedRef.value = true; } });
      }catch(err){
        console.error("Network error:", err);
        showErr("Network error. Please ensure the server is running.");
      }finally{
        setTimeout(()=>{ submitBtn.disabled = false; submitting=false; }, 700);
      }
    });

    form.addEventListener("reset", ()=>{
      Object.values(err).forEach(el => el.style.display = "none");
      Object.values(input).forEach(f => f.removeAttribute("aria-invalid"));
      clearStatus(); hasSubmitted = false; formCompletedRef.value = false;
    });

    function returnToDashboard(){ window.location.href = "admin_dashboard.html"; }

    /* =========================================================
      7) Boot
    ========================================================= */
    (async function init(){
      attachLiveValidation();
      attachPostSuccessReset(input, form, clearStatus, formCompletedRef);
    })();
  </script>
</body>
</html>
