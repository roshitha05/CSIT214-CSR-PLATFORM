<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Registration</title>
    <style>
      /* =========================
        Design Tokens
      ========================== */
      :root {
        --bg: #f0f9ff;
        --card: #fff;
        --text: #1e293b;
        --muted: #64748b;
        --accent: #38bdf8;
        --accent-2: #0ea5e9;
        --danger: #ef4444;
        --success-bg: #dcfce7;
        --success-text: #166534;
        --ring: rgba(14,165,233,.3);
        --radius: 16px;
      }

      /* =========================
        Base / Layout
      ========================== */
      * { box-sizing: border-box; }
      html, body { min-height: 100svh; }
      body {
        margin: 0;
        font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(180deg, #e0f2fe, var(--bg));
        color: var(--text);
        display: grid;
        place-items: start center;
        padding: 24px;
        overflow: auto;
      }

      /* =========================
        Card
      ========================== */
      .card {
        width: 100%;
        max-width: 720px;
        background: var(--card);
        border: 1px solid #e2e8f0;
        border-radius: var(--radius);
        box-shadow: 0 8px 24px rgba(0,0,0,.08);
        overflow: visible;
      }

      /* =========================
        Header
      ========================== */
      .header {
        padding: 24px 28px;
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(180deg, #e0f2fe, #f8fafc);
      }
      .header h1 { margin: 0 0 4px; font-size: 1.4rem; color: var(--accent-2); }
      .header p  { margin: 0; color: var(--muted); font-size: .95rem; }

      /* =========================
        Form & Fields
      ========================== */
      form { padding: 16px 20px 8px; }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px 16px;
      }
      .row { display: flex; flex-direction: column; }
      label { margin-bottom: 8px; font-weight: 600; color: var(--text); }

      input, select, textarea {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #cbd5e1;
        color: var(--text);
        font-size: .98rem;
        transition: border-color .2s, box-shadow .2s;
      }

      /* Focus */
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--accent-2);
        box-shadow: 0 0 0 3px var(--ring);
      }
      textarea { min-height: 100px; resize: vertical; }

      /* Helper Text */
      .hint  { margin-top: 6px; font-size: .85rem; color: var(--muted); }
      .error { margin-top: 6px; color: var(--danger); font-size: .9rem; display: none; }

      /* =========================
        Password Toggle
      ========================== */
      .password-wrapper { position: relative; }
      .password-wrapper input { padding-right: 2.5rem; }
      .password-wrapper i {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--accent-2);
        cursor: pointer;
        background: none;
        border: 0;
        padding: 0;
      }
      .password-wrapper i:hover { transform: translateY(-50%) scale(1.05); }

      /* =========================
        Actions & Buttons
      ========================== */
      .actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        border: 0;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform .1s;
      }
      .btn-primary   { background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: #fff; }
      .btn-primary:hover { transform: scale(1.02); }
      .btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid #cbd5e1; }
      .btn-secondary:hover { background: #e2e8f0; }

      /* =========================
        Status Banners
      ========================== */
      .success {
        display: none;
        padding: 12px 14px;
        margin-top: 12px;
        border-radius: 12px;
        background: var(--success-bg);
        border: 1px solid #bbf7d0;
        color: var(--success-text);
        font-size: .95rem;
      }

      /* =========================
        Footer
      ========================== */
      .footer {
        padding: 18px 28px;
        border-top: 1px solid #e2e8f0;
        color: var(--muted);
        font-size: .9rem;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      /* =========================
        Responsive
      ========================== */
      @media (max-width: 640px) {
        .grid { grid-template-columns: 1fr; }
        .header, form, .footer { padding: 18px; }
      }
    </style>
  </head>
  <body>
    <div class="card" role="region">
      <div class="header">
        <h1>User Registration</h1>
        <p>Create an account to request help, represent users, or volunteer.</p>
      </div>

      <form id="registerForm" novalidate>
        <div class="grid">
          <!-- 1. Name (required) -->
          <div class="row">
            <label for="fullName">Full Name <span style="color: var(--muted)">*</span></label>
            <input
              id="fullName"
              name="fullName"
              type="text"
              required
              maxlength="64"
              placeholder="e.g., Jane Doe"
              aria-describedby="fullName-hint err-fullName"
              autocomplete="name"
              autofocus
            />
            <small id="fullName-hint" class="hint">Required. Up to 64 characters.</small>
            <div id="err-fullName" class="error">
              Please enter your name (max 64 chars).
            </div>
          </div>

          <!-- 2. Login ID (required) -->
          <div class="row">
            <label for="loginId">Login ID <span style="color: var(--muted)">*</span></label>
            <input
              id="loginId"
              name="loginId"
              type="text"
              required
              maxlength="32"
              placeholder="e.g., janedoe123"
              aria-describedby="loginId-hint err-loginId"
              autocomplete="username"
              pattern="^[A-Za-z0-9._-]{3,32}$"
            />
            <small id="loginId-hint" class="hint"
              >Required. 3–32 chars: letters, numbers, dot, underscore,
              hyphen.</small
            >
            <div id="err-loginId" class="error">
              Please enter a valid Login ID (3–32 allowed chars).
            </div>
          </div>

          <!-- 3. Email (required) -->
          <div class="row">
            <label for="email">Email <span style="color: var(--muted)">*</span></label>
            <input
              id="email"
              name="email"
              type="email"
              required
              maxlength="254"
              placeholder="you@example.com"
              aria-describedby="email-hint err-email"
              autocomplete="email"
            />
            <small id="email-hint" class="hint">Required.</small>
            <div id="err-email" class="error">
              Please enter a valid email address.
            </div>
          </div>

          <!-- 4. Password (required) -->
          <div class="row">
            <label for="password">Password <span style="color: var(--muted)">*</span></label>
            <div class="password-wrapper">
              <input
                id="password"
                name="password"
                type="password"
                required
                minlength="8"
                maxlength="128"
                autocomplete="new-password"
                placeholder="At least 8 characters"
                aria-describedby="password-hint err-password"
              />
              <i class="fa-solid fa-eye-slash" id="togglePassword"></i>
            </div>
            <small id="password-hint" class="hint">Required. Password should be at least 8 characters.</small>
            <div id="err-password" class="error">Please enter a password (8–128 chars).</div>
          </div>

          <!-- 5. Phone Number (required) -->
          <div class="row">
            <label for="phone">Phone Number <span style="color: var(--muted)">*</span></label>
            <input
              id="phone"
              name="phone"
              type="tel"
              required
              minlength = "8"
              maxlength="8"
              inputmode="tel"
              placeholder="8123 4567"
              aria-describedby="phone-hint err-phone"
              autocomplete="tel"
              pattern="^[+0-9()\-.\s]{6,20}$"
            />
            <small id="phone-hint" class="hint"
              >Required. 8 digits</small
            >
            <div id="err-phone" class="error">
              Please enter a valid phone number.
            </div>
          </div>

          <!-- 6. Address (required) -->
          <div class="row" style="grid-column: 1 / -1">
            <label for="address">Address <span style="color: var(--muted)">*</span></label>
            <textarea
              id="address"
              name="address"
              required
              maxlength="255"
              placeholder="Block/Street, Unit, Postal Code"
              aria-describedby="address-hint err-address"
              autocomplete="street-address"
              spellcheck="false"
            ></textarea>
            <small id="err-address" class="hint">Required. Up to 255 characters.</small>
            <div id="err-address" class="error">
              Please enter your address (max 255 chars).
            </div>
          </div>

          <!-- 7. DOB (required) -->
          <div class="row">
            <label for="dob">Date of Birth <span style="color: var(--muted)">*</span></label>
            <input id="dob" name="dob" type="date" required max="" aria-describedby="hint-dob err-dob"/>
            <small id="hint-dob" class="hint">Required.</small>
            <div id="err-dob" class="error">
              Please choose a valid date in the past.
            </div>
          </div>

          <!-- 8. User Profile (role) required -->
          <div class="row">
            <label for="profile">User Profile <span style="color: var(--muted)">*</span></label>
            <select
              id="profile"
              name="profile"
              required
              aria-describedby="hint-profile err-profile"
            >
              <option value="">Loading profiles…</option>
            </select>
            <small id="hint-profile" class="hint"
              >Required. Select a role.</small
            >
            <div id="err-profile" class="error">Please select a profile.</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" type="submit" id="submitBtn">
            Create Account
          </button>
          <button class="btn-secondary" type="reset">Clear</button>
          <button class="btn-secondary" type="button" id="returnDashboard">Return to Dashboard</button>
        </div>

        <div id="success" class="success" role="status" aria-live="polite"></div>
      </form>

      <div class="footer">
        <span>© 2025 Community Support Platform</span>
      </div>
    </div>
  <script>
    // =========================
    // Config
    // =========================
    const DEBUG        = false; // toggle as needed
    const API_URL      = "http://127.0.0.1:80/api";
    const PROFILES_API = `${API_URL}/user-profiles`;
    const REGISTER_API = `${API_URL}/users`;

    // =========================
    // DOM
    // =========================
    const $ = (id) => document.getElementById(id);

    const form =      $("registerForm");
    const success =   $("success");
    const submitBtn = $("submitBtn");

    const input = {
      fullName: $("fullName"),
      loginId:  $("loginId"),
      email:    $("email"),
      password: $("password"),
      phone:    $("phone"),
      address:  $("address"),
      dob:      $("dob"),
      profile:  $("profile"),
    }

    const err = {
      fullName: $("err-fullName"),
      loginId:  $("err-loginId"),
      email:    $("err-email"),
      password: $("err-password"),
      phone:    $("err-phone"),
      address:  $("err-address"),
      dob:      $("err-dob"),
      profile:  $("err-profile"),
    }

    // =========================
    // UI Status Helpers
    // =========================
    function showOk(message) {
      success.style.display = "block";
      success.style.background = "#dcfce7";
      success.style.border = "1px solid #bbf7d0";
      success.style.color = "#166534";
      success.setAttribute("aria-live", "polite");
      success.textContent = message;
      formCompletedRef.value = true;
    }

    function showErr(message) {
      success.style.display = "block";
      success.style.background = "#fee2e2";
      success.style.border = "1px solid #fecaca";
      success.style.color = "#991b1b";
      success.setAttribute("aria-live", "assertive");
      success.textContent = message;
      formCompletedRef.value = true;
    }

    function clearStatus() {
      success.style.display = "none";
      success.textContent = "";
      success.setAttribute("aria-live", "polite");
    }

    // Debug Helper
    function showDebug(payload) {
      success.style.display = "block";
      success.style.background = "#fef9c3";   
      success.style.border = "1px solid #fde047";
      success.style.color = "#854d0e";
      success.style.whiteSpace = "pre-wrap";
      success.textContent =
        `[DEBUG]:\n\n` +
        `This would POST to:\n${REGISTER_API}\n\n` +
        `With values:\n${JSON.stringify(payload, null, 2)}`;
    }

    // =========================
    // Utils
    // =========================
    const show       = (el, on) => { el.style.display = on ? "block" : "none"; };
    const nonEmpty   = (s) => String(s ?? "").trim().length > 0;
    const collapse   = (s) => String(s ?? "").replace(/\s+/g, " ").trim();
    const lowerTrim  = (s) => collapse(s).toLowerCase();
    const digitsOnly = (s) => String(s ?? "").replace(/\D/g, "");

    let hasSubmitted = false;
    let submitting   = false;
    const formCompletedRef = { value: false };

    // Accept past dates only
    function pastDateOnly(value) {
      const d = new Date(value);
      const today = new Date();
      d.setHours(0, 0, 0, 0);
      today.setHours(0, 0, 0, 0);
      return d instanceof Date && !isNaN(d) && d < today;
    }

    // Keep DOB max to current date
    (function setDobMaxToday() {
      const today = new Date().toISOString().split("T")[0];
      input.dob.setAttribute("max", today);
    })();

    // Toggle Password Show / Hide
    const togglePassword = $("togglePassword");
    togglePassword?.addEventListener("click", function () {
      const type = input.password.type === "password" ? "text" : "password";
      input.password.type = type;
      this.classList.toggle("fa-eye");
      this.classList.toggle("fa-eye-slash");
    });

    function focusFirstInvalid() {
      const order = [
        input.fullName, input.loginId, input.email, input.password,
        input.phone, input.address, input.dob, input.profile
      ];
      for (const el of order) {
        if (el.hasAttribute("aria-invalid")) {
          el.focus({preventScroll: true});
          return;
        }
      }
    }

    function attachLiveValidation(fields, validateFn, debounceMs = 200) {
      let timer = null;
      fields.forEach((field) => {
        field.addEventListener("input", () => {
          if (!hasSubmitted) return;
          clearTimeout(timer);
          timer = setTimeout(() => { 
            clearStatus(); 
            validateFn(); 
          }, debounceMs);
        });
      });
    }

    function attachPostSuccessReset(inputs, form, clearFn, flagRef) {
      Object.values(inputs).forEach((field) => {
        field.addEventListener("focus", () => {
          if (!flagRef.value) return;
          form.reset();
          clearFn();
          Object.values(inputs).forEach((f) => f.removeAttribute("aria-invalid"));
          flagRef.value = false;
        });
      });
    }

    attachLiveValidation(
      [input.fullName, input.loginId, input.email, input.password, input.phone, input.address],
      validateFields
    );
    [input.dob, input.profile].forEach((el) =>
      el.addEventListener("change", () => { if (hasSubmitted) { clearStatus(); validateFields(); } })
    );
    attachPostSuccessReset(input, form, clearStatus, formCompletedRef);

    // =========================
    // Load roles (profiles)
    // =========================
    document.addEventListener("DOMContentLoaded", loadProfiles);

    async function loadProfiles() {
      const select = input.profile;
      select.innerHTML = '<option value="">Loading profiles…</option>';
      select.disabled  = true;

      try {
        const response = await fetch(PROFILES_API, {
          method: "GET",
          mode: "cors",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
        });

        // Non-OK -> error UI
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        const profiles = data.userProfiles || data.data || [];

        select.innerHTML = "";
        select.appendChild(new Option("Select a profile…", ""));

        if (!Array.isArray(profiles) || profiles.length === 0) {
          select.appendChild(new Option("No profiles available", ""));
          select.disabled = true;
          return;
        }

        profiles
          .map(p => p?.name || p?.profile_name)
          .filter(Boolean)
          .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }))
          .forEach((name) => select.appendChild(new Option(name, name)));

        select.disabled = false;
      } catch (e) {
        console.error("Failed to load profiles:", e);
        select.innerHTML = "";
        select.appendChild(new Option("Error loading profiles", ""));
        select.disabled = true;
        showErr("Unable to load profiles. Please try again later.");
      }
    }

    // =========================
    // Validation
    // =========================
    function validateFields() {
      let valid = true;

      const vName  = collapse(input.fullName.value);
      const vLogin = lowerTrim(input.loginId.value);
      const vEmail = lowerTrim(input.email.value);
      const vPw    = input.password.value;
      const vPhone = digitsOnly(input.phone.value);
      const vAddr  = collapse(input.address.value);
      const vDob   = input.dob.value;
      const vProf  = collapse(input.profile.value);

      // Full name: required, <= 64
      const okName = nonEmpty(vName) && vName.length <= 64;
      show(err.fullName, !okName);
      input.fullName.toggleAttribute("aria-invalid", !okName);
      valid &&= okName;

      // Login ID: required, 3–32 allowed chars (lowercased for storage)
      const okLogin = /^[a-z0-9._-]{3,32}$/.test(vLogin);
      show(err.loginId, !okLogin);
      input.loginId.toggleAttribute("aria-invalid", !okLogin);
      valid &&= okLogin;

      // Email: required, <= 254 and simple pattern
      const okEmail = /\S+@\S+\.\S+/.test(vEmail) && vEmail.length <= 254;
      show(err.email, !okEmail);
      input.email.toggleAttribute("aria-invalid", !okEmail);
      valid &&= okEmail;

      // Password: 8–128
      const okPw = vPw.length >= 8 && vPw.length <= 128;
      show(err.password, !okPw);
      input.password.toggleAttribute("aria-invalid", !okPw);
      valid &&= okPw;

      // Phone: exactly 8 digits (SG style)
      const okPhone = /^\d{8}$/.test(vPhone);
      show(err.phone, !okPhone);
      input.phone.toggleAttribute("aria-invalid", !okPhone);
      valid &&= okPhone;

      // Address: required, <= 255
      const okAddr = nonEmpty(vAddr) && vAddr.length <= 255;
      show(err.address, !okAddr);
      input.address.toggleAttribute("aria-invalid", !okAddr);
      valid &&= okAddr;

      // DOB: required, past
      const okDob = nonEmpty(vDob) && pastDateOnly(vDob);
      show(err.dob, !okDob);
      input.dob.toggleAttribute("aria-invalid", !okDob);
      valid &&= okDob;

      // Profile: required
      const okProf = nonEmpty(vProf);
      show(err.profile, !okProf);
      input.profile.toggleAttribute("aria-invalid", !okProf);
      valid &&= okProf;

      return valid;
    }

    // =========================
    // Server Message Display (Boundary)
    // =========================
    async function displayServerMessage(response, { onSuccess } = {}) {
      let body = null;
      let serverMsg = "";

      try {
        // Try JSON first
        const ct = response.headers.get("content-type") || "";
        if (ct.includes("application/json")) {
          body = await response.clone().json();
          serverMsg = body?.message || body?.error || "";
        } else {
          serverMsg = (await response.clone().text()).trim();
        }
      } catch {
        // ignore parse errors
      }

      // Success cases
      if (response.status === 201 || response.status === 200) {
        showOk(serverMsg || "Account created successfully.");
        onSuccess?.(body);
        return;
      }

      // Known error cases
      if (response.status === 400) { showErr(serverMsg || "Registration failed. Please check your inputs."); return; }
      if (response.status === 401) { showErr(serverMsg || "Unauthorized. Please log in and try again."); return; }
      if (response.status === 409) { showErr(serverMsg || "This login ID or email already exists."); return; }

      // Fallback
      showErr(serverMsg || `Unexpected error: ${response.status}`);
    }

    // =========================
    // Submit
    // =========================
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (submitting) return;
      submitting = true;
      hasSubmitted = true;
      clearStatus();

      if (!validateFields()) {
        focusFirstInvalid();
        submitting = false;
        return;
      }

      submitBtn.disabled = true;

      // Normalized payload
      const payload = {
        fullname     : collapse(input.fullName.value),
        username     : lowerTrim(input.loginId.value),
        email        : lowerTrim(input.email.value),
        password     : input.password.value,
        phone_number : digitsOnly(input.phone.value),
        address      : collapse(input.address.value),
        date_of_birth: input.dob.value,
        user_profile : collapse(input.profile.value),
      };

      if (DEBUG) {
        showDebug(payload);
        submitBtn.disabled = false;
        submitting = false;
        hasSubmitted = false;
        return;
      }

      try {
        const response = await fetch(REGISTER_API, {
          method : "POST",
          mode : "cors",
          credentials : "include",
          headers: { "Content-Type": "application/json" },
          body : JSON.stringify(payload),
        });

        await displayServerMessage(response, {
          onSuccess: () => {
            formCompletedRef.value = true;

            // Optionally redirect after success:
            // setTimeout(() => window.location.href = "admin_dashboard.html", 900);
          }
        });
      } catch (err) {
        console.error("Network error: ", err);
        showErr("Network error. Please ensure the server is running.");
      } finally {
        setTimeout(() => { submitBtn.disabled = false; submitting = false; }, 800);
      }
    });

    // =========================
    // Reset
    // =========================
    form.addEventListener("reset", () => {
      Object.values(err).forEach((el) => (el.style.display = "none"));
      Object.values(input).forEach((f) => f.removeAttribute("aria-invalid"));
      clearStatus();
      hasSubmitted = false;
      formCompletedRef.value = false;                                    
    });

    // =========================
    // Navigation
    // =========================
    $("returnDashboard").addEventListener("click", () => {
      window.location.href = "admin_dashboard.html";
    });
  </script>
</body>
</html>
