<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#f7f9fc; --primary:#34495e; --secondary:#2c3e50;
      --accent:#3498db; --accent-2:#2980b9;
      --text:#2c3e50; --white:#fff;
      --shadow:0 4px 10px rgba(0,0,0,.1);
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:Poppins,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    body{ min-height:100vh; display:flex; background:var(--bg); color:var(--text); }

    /* ===== Sidebar ===== */
    .sidebar{
      width:240px; background:var(--primary); color:var(--white);
      display:flex; flex-direction:column; padding:1.5rem 1rem; box-shadow:var(--shadow);
    }
    .sidebar h2{ font-size:1.4rem; margin-bottom:2rem; text-align:center; }
    .navlink{
      display:flex; align-items:center; gap:12px; padding:.75rem 1rem; color:var(--white);
      text-decoration:none; border-radius:8px; margin-bottom:.5rem; transition:background .2s ease;
    }
    .navlink:hover{ background:var(--accent); }
    .navlink[aria-current="page"]{ background:var(--accent-2); }

    /* ===== Main ===== */
    .main{ flex:1; padding:2rem; display:flex; flex-direction:column; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; }
    .topbar h1{ font-size:1.6rem; font-weight:600; }
    .user-info{ display:flex; align-items:center; gap:10px; }
    .user-info img{ width:40px; height:40px; border-radius:50%; border:2px solid var(--accent); }

    /* ===== Cards ===== */
    .cards{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem;
    }
    .card{
      width:100%; border:0; text-align:left; cursor:pointer; background:var(--white);
      color:inherit; border-radius:12px; padding:1.5rem; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:.5rem; transition:transform .2s, box-shadow .2s;
    }
    .card i{ font-size:2rem; color:var(--accent); }
    .card:hover{ transform:translateY(-4px); box-shadow:0 6px 15px rgba(0,0,0,.15); }
    .card h3{ font-size:1.1rem; }
    .card p{ color:#666; font-size:.95rem; }

    /* ===== Logout button ===== */
    .logout-btn{
      margin-top:auto; display:flex; gap:.5rem; align-items:center; justify-content:center;
      background:var(--accent-2); color:var(--white); padding:.75rem; border:0; border-radius:8px; cursor:pointer;
      transition:background .2s ease;
    }
    .logout-btn:hover{ background:#1f5f8b; }

    /* ===== Modal ===== */
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
      justify-content:center; align-items:center; z-index:1000;
    }
    .modal[open]{ display:flex; }
    .modal-content{
      background:var(--white); width:420px; max-width:90vw; border-radius:12px; padding:28px; box-shadow:0 8px 20px rgba(0,0,0,.2);
    }
    .modal-content h2{ font-size:1.2rem; margin:0 0 8px; }
    .modal-content p{ margin:0 0 16px; color:#475569; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; }
    .btn{
      padding:10px 16px; border:0; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn-cancel{ background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1; }
    .btn-cancel:hover{ background:#e2e8f0; }
    .btn-confirm{ background:#ef4444; color:#fff; }
    .btn-confirm[disabled]{ opacity:.7; cursor:not-allowed; }

    @media (max-width:768px){
      .sidebar{ width:70px; padding:1rem .5rem; }
      .sidebar h2, .navlink span{ display:none; }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Administrator</h2>
    <a class="navlink" href="#" aria-current="page"><i class="fa-solid fa-house"></i><span>Home</span></a>
    <a class="navlink" href="#"><i class="fa-solid fa-user"></i><span>Profile</span></a>
    <a class="navlink" href="#"><i class="fa-solid fa-list"></i><span>Reports</span></a>
    <a class="navlink" href="#"><i class="fa-solid fa-gear"></i><span>Settings</span></a>

    <button class="logout-btn" id="logoutBtn" type="button">
      <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i><span>Logout</span>
    </button>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <h1>Welcome back, <span class="show-fullname"></span> ðŸ‘‹</h1>
      <div class="user-info" aria-label="Signed-in user">
        <img src="https://i.pravatar.cc/100?img=68" alt="" />
        <span class="show-fullname"></span>
      </div>
    </div>

    <section class="cards" aria-label="Quick actions">
      <button class="card" type="button" data-href="/user_admin/create_profile.html">
        <i class="fa-solid fa-book"></i>
        <h3>Create User Profiles</h3>
        <p>Set up new user roles.</p>
      </button>

      <button class="card" type="button" data-href="/user_admin/create_account.html">
        <i class="fa-solid fa-circle-chevron-right"></i>
        <h3>Create User Accounts</h3>
        <p>Set up new user accounts.</p>
      </button>

      <button class="card" type="button" data-href="/user_admin/profile_management.html">
        <i class="fa-solid fa-users"></i>
        <h3>Profile Management</h3>
        <p>Manage user profiles.</p>
      </button>

      <button class="card" type="button" data-href="/user_admin/account_management.html">
        <i class="fa-solid fa-address-book"></i>
        <h3>Account Management</h3>
        <p>Manage and review account details.</p>
      </button>
    </section>
  </main>

  <!-- Logout Modal -->
  <div class="modal" id="logoutModal" role="dialog" aria-modal="true" aria-labelledby="logoutTitle" aria-describedby="logoutDesc">
    <div class="modal-content" role="document">
      <h2 id="logoutTitle">Confirm Logout</h2>
      <p id="logoutDesc">Are you sure you want to log out?</p>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelLogoutBtn" type="button">Cancel</button>
        <button class="btn btn-confirm" id="confirmLogoutBtn" type="button">Logout</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API_URL = "http://127.0.0.1:80/api";
    const LOGOUT_API = `${API_URL}/logout`;

    // ===== DOM =====
    const $  = sel => document.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const ui = {
      logoutBtn: $("#logoutBtn"),
      modal: $("#logoutModal"),
      confirm: $("#confirmLogoutBtn"),
      cancel: $("#cancelLogoutBtn"),
      cards: $$(".card"),
      nameHolders: $$(".show-fullname"),
    };

    // ===== Utils =====
    async function fetchWithTimeout(url, options={}, timeoutMs=15000){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      try{
        return await fetch(url, { ...options, signal: controller.signal });
      } finally { clearTimeout(t); }
    }

    function setFullname(){
      const name = localStorage.getItem("fullname") || "Not logged in";
      ui.nameHolders.forEach(el => el.textContent = name);
    }

    // ===== Modal (open/close, focus trap, ESC) =====
    let lastActiveEl = null;
    function openModal(){
      lastActiveEl = document.activeElement;
      ui.modal?.setAttribute("open", "");
      document.body.style.overflow = "hidden";
      ui.confirm?.focus({ preventScroll:true });
    }

    function closeModal(){
      ui.modal?.removeAttribute("open");
      document.body.style.overflow = "";
      lastActiveEl?.focus?.();
    }


    // ===== Wire up UI =====
    // header name
    setFullname();

    // card navigation
    ui.cards.forEach(btn => btn.addEventListener("click", () => {
      const href = btn.getAttribute("data-href");
      if(href) window.location.href = href;
    }));

    // modal controls
    ui.logoutBtn?.addEventListener("click", openModal);
    ui.cancel?.addEventListener("click", closeModal);

    // confirm logout
    ui.confirm?.addEventListener("click", async () => {
      ui.confirm.disabled = true;
      const original = ui.confirm.textContent;
      ui.confirm.textContent = "Logging outâ€¦";

      try{
        await new Promise(res => setTimeout(res, 2000));
        const res = await fetchWithTimeout(LOGOUT_API, {
          method:"POST", mode:"cors", credentials:"include",
          headers:{ "Content-Type":"application/json" },
        });

        // Treat OK or already-unauthenticated as success
        if(res.ok || res.status === 401){
          localStorage.removeItem("user_id");
          localStorage.removeItem("username");
          localStorage.removeItem("fullname");
          localStorage.removeItem("role");
          window.location.href = "../user_login.html";
          return;
        }

        let msg = "";
        try{ msg = (await res.clone().json())?.message || ""; }catch{}
        alert(msg || `Logout failed (${res.status}). Please try again.`);
      }catch(err){
        console.error("Network error:", err);
        alert("Network error. Please ensure the server is running.");
      }finally{
        ui.confirm.disabled = false;
        ui.confirm.textContent = original;
        closeModal();
      }
    });
  </script>
</body>
</html>
