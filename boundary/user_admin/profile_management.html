<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile Management</title>
  <style>
    :root {
      --bg:#f0f9ff; 
      --card:#ffffff; 
      --text:#1e293b; 
      --muted:#64748b;
      --accent:#38bdf8; 
      --accent-2:#0ea5e9; 
      --danger:#ef4444;
      --ring:rgba(14,165,233,.3); 
      --radius:16px;
    }

    /* ===== Base ===== */
    * { box-sizing: border-box; }
    html, body { min-height:100%; margin:0; }
    body {
      font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:linear-gradient(180deg,#e0f2fe,var(--bg));
      color:var(--text);
      display:flex; justify-content:center; align-items:flex-start;
      padding:24px; min-height:100svh; overflow:hidden;
    }

    /* ===== Card ===== */
    .card {
      width:100%; max-width:1000px; height:calc(100svh - 48px);
      background:var(--card); border:1px solid #e2e8f0; border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.1); overflow:hidden;
      display:flex; flex-direction:column;
    }

    /* ===== Header ===== */
    .header {
      padding:18px 24px; background:linear-gradient(180deg,#e0f2fe,#f8fafc);
      border-bottom:1px solid #e2e8f0;
      display:flex; justify-content:space-between; align-items:center;
    }
    .header h1 { margin:0; font-size:1.5rem; color:var(--accent-2); }
    .header-controls { display:flex; align-items:center; gap:12px; }

    .btn-dashboard {
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      color:#fff; border:0; border-radius:10px; padding:10px 18px;
      font-size:.9rem; font-weight:600; cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,.1); transition:.2s;
    }
    .btn-dashboard:hover { transform:scale(1.05); opacity:.9; }

    .search-box input {
      width:240px; padding:10px 14px; border-radius:12px; border:1px solid #cbd5e1;
      font-size:.95rem;
    }
    .search-box input:focus {
      border-color:var(--accent-2); outline:none; box-shadow:0 0 0 3px var(--ring);
    }

    /* ===== Table ===== */
    .table-wrap {
      flex:1; min-height:0;
      overflow-y:auto; overflow-x:auto;
      scrollbar-gutter:stable; position:relative;
    }
    table {
      width:100%; min-width:900px;
      border-collapse:collapse; table-layout:fixed;
    }
    thead th {
      position:sticky; top:0; z-index:10;
      background:#f8fafc; box-shadow:0 1px 0 #e2e8f0;
      text-align:left;
    }
    th, td {
      padding:14px 16px; min-width:0; vertical-align:middle;
      border-bottom:1px solid #e2e8f0;
      text-overflow:ellipsis; overflow:hidden;
    }
    td { font-size:.93rem; color:#334155; }

    /* Hint text */
    .hint { margin-top:6px; font-size:.85rem; color:var(--muted); display:block; }

    /* Hover and zebra */
    tbody tr:nth-child(odd) td { background:#fcfdff; }
    tbody tr:hover td { background:#f9fafb; }

    td.description, td.other { white-space:normal; line-height:1.4; }
    td.status { text-align:center; }
    td.actions { text-align:center; }
    th:nth-child(4), th:nth-child(5) { text-align:center; }

    /* ===== Status Badges ===== */
    .badge {
      display:inline-block; padding:4px 10px; border-radius:9999px;
      font-size:.78rem; font-weight:600; line-height:1; white-space:nowrap;
    }
    .badge-active {
      background:#dcfce7; color:#166534; border:1px solid #86efac;
    }
    .badge-suspended {
      background:#fee2e2; color:#991b1b; border:1px solid #fca5a5;
    }
    .badge-protected {
      display:inline-flex; align-items:center; gap:6px;
      background:#fef3c7; color:#92400e; border:1px solid #fcd34d;
      padding:2px 8px; border-radius:9999px; font-size:.75rem; font-weight:700;
    }

    /* ===== Buttons ===== */
    .btn-edit, .btn-suspend, .btn-reactivate {
      padding:6px 14px; border-radius:8px; border:0; cursor:pointer;
      font-size:.85rem; white-space:nowrap; transition:.2s;
    }
    .btn-edit { background:var(--accent-2); color:#fff; }
    .btn-suspend { background:var(--danger); color:#fff; }
    .btn-reactivate { background:#22c55e; color:#fff; }
    .btn-edit:hover, .btn-suspend:hover, .btn-reactivate:hover { opacity:.85; }

    td.actions .btn-row {
      display:flex; justify-content:center; align-items:center; gap:10px;
    }

    /* Protected (suspend disabled) */
    .btn-suspend[disabled] { cursor:not-allowed; opacity:.55; }

    /* ===== Footer ===== */
    .footer {
      padding:12px 20px; border-top:1px solid #e2e8f0;
      color:var(--muted); font-size:.9rem;
      display:flex; justify-content:space-between; flex-wrap:wrap;
    }

    /* ===== Modals ===== */
    .modal {
      display:none; position:fixed; inset:0; z-index:2000;
      background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
      justify-content:center; align-items:center;
    }
    .modal-content {
      width:min(640px,92vw); background:#fff;
      border-radius:20px; padding:32px 36px;
      box-shadow:0 8px 36px rgba(0,0,0,.25);
      animation:fadeIn .25s ease-in-out;
    }
    .modal-content h2 {
      margin:0 0 24px; font-size:1.4rem; font-weight:700; color:var(--text);
      border-bottom:1px solid #e2e8f0; padding-bottom:12px;
    }
    .modal-body { display:grid; gap:18px; margin-top:6px; }

    .form-row label {
      display:block; font-size:.9rem; font-weight:600; color:var(--text);
      margin-bottom:8px;
    }
    .modal-input, .modal-textarea {
      width:100%; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px;
      padding:14px 16px; font-size:.95rem; font-family:inherit;
      transition:border-color .15s, box-shadow .15s;
    }
    .modal-input:focus, .modal-textarea:focus {
      outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring);
    }
    .modal-input[disabled] { cursor:not-allowed; opacity:.8; background:#f1f5f9; }
    .modal-textarea { min-height:110px; resize:vertical; }

    .modal-actions {
      margin-top:24px; padding-top:16px; border-top:1px solid #e2e8f0;
      display:flex; justify-content:flex-end; gap:12px;
    }
    .btn-cancel {
      background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1;
      padding:10px 18px; border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-cancel:hover { background:#e2e8f0; }
    .btn-primary {
      background:var(--accent-2); color:#fff; padding:10px 18px; border-radius:8px;
      font-weight:600; cursor:pointer;
    }
    .btn-primary:hover { opacity:.9; transform:translateY(-1px); }
    .btn-danger {
      background:var(--danger); color:#fff; padding:10px 18px;
      border-radius:8px; font-weight:600; cursor:pointer;
    }
    .btn-danger:hover { opacity:.9; transform:translateY(-1px); }

    .error { margin-top:6px; color:var(--danger); font-size:.9rem; display:none; }
    #statusMsg { display:none; margin-top:4px; padding:10px 12px; border-radius:8px; }

    @keyframes fadeIn { from{opacity:0; transform:scale(.95);} to{opacity:1; transform:scale(1);} }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>Profile Management</h1>
      <div class="header-controls">
        <button class="btn-dashboard" id="btnBackToDash">Return to Dashboard</button>
        <div class="search-box">
          <input type="text" id="search" placeholder="Search by keyword...">
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="profileTable">
        <colgroup>
          <col style="width:20%"> <!-- Name -->
          <col style="width:35%"> <!-- Description -->
          <col style="width:10%"> <!-- Other -->
          <col style="width:15%"> <!-- Status -->
          <col style="width:20%"> <!-- Actions -->
        </colgroup>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Other</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr id="noResultsRow" style="display:none;">
            <td colspan="5" class="no-results">No results found.</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="footer">
      <span>© 2025 Community Support Platform</span>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
      <h2 id="editTitle">Edit Profile</h2>

      <div class="modal-body">
        <div class="form-row">
          <label for="editName">Name <span style="color:var(--muted)">*</span></label>
          <input type="text" id="editName" class="modal-input" placeholder="Profile name"/>
          <small class="hint">Required. 1–64 characters.</small>
          <div id="editErr-name" class="error">Please enter a valid name (1–64 characters).</div>
        </div>

        <div class="form-row">
          <label for="editDesc">Description</label>
          <textarea id="editDesc" class="modal-textarea" placeholder="Short description"></textarea>
          <small class="hint">Optional. Up to 255 characters.</small>
          <div id="editErr-desc" class="error">Description must be 255 characters or fewer.</div>
        </div>

        <div class="form-row">
          <label for="editOther">Other Info</label>
          <textarea id="editOther" class="modal-textarea" placeholder="Additional notes or info"></textarea>
          <small class="hint">Optional. Up to 128 characters.</small>
          <div id="editErr-other" class="error">Other info must be 128 characters or fewer.</div>
        </div>

        <div id="statusMsg" class="success" role="status" aria-live="polite"></div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="editModalCancelBtn">Cancel</button>
          <button type="button" class="btn-primary" id="editModalSaveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Suspend Modal -->
  <div class="modal" id="suspendModal" role="dialog" aria-modal="true" aria-labelledby="suspendTitle">
    <div class="modal-content">
      <h2 id="suspendTitle">Confirm Suspend</h2>
      <p>Are you sure you want to suspend this profile?</p>
      <div class="modal-actions">
        <button class="btn-cancel" id="suspendModalCancelBtn">Cancel</button>
        <button class="btn-danger" id="suspendModalConfirmBtn">Suspend</button>
      </div>
    </div>
  </div>

  <!-- Reactivate Modal -->
  <div class="modal" id="reactivateModal" role="dialog" aria-modal="true" aria-labelledby="reactivateTitle">
    <div class="modal-content">
      <h2 id="reactivateTitle">Confirm Reactivation</h2>
      <p>Are you sure you want to reactivate this profile?</p>
      <div class="modal-actions">
        <button class="btn-cancel" id="reactivateModalCancelBtn">Cancel</button>
        <button class="btn-primary" id="reactivateModalConfirmBtn">Reactivate</button>
      </div>
    </div>
  </div>

  <script>
  /* =========================================================
    1) Config & constants
  ========================================================= */
  const DEBUG         = false;
  const API_URL       = "http://127.0.0.1:80/api";
  const PROFILES_API  = `${API_URL}/user-profiles`;

  const STATUS = { ACTIVE:"ACTIVE", SUSPENDED:"SUSPENDED" };
  const NAME_MAX = 64, DESC_MAX = 255, OTHER_MAX = 128;

  // Policy toggles (case-insensitive)
  const RESERVED_NAMES = new Set([
    "user admin",
    "csr representative",
    "person-in-need",
    "platform management",
  ]);
  const PROTECTED_SUSPEND_NAMES = new Set(["user admin"]); // cannot suspend
  const LOCK_NAME_EDIT_NAMES    = RESERVED_NAMES;          // cannot edit name

  /* =========================================================
    2) DOM shortcuts
  ========================================================= */
  const $  = (id) => document.getElementById(id);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const DOM = {
    // Table
    table: $("profileTable"),
    tbody: $("profileTable")?.querySelector("tbody"),
    noResultsRow: $("noResultsRow"),
    search: $("search"),

    // Edit modal
    editModal: $("editModal"),
    editName: $("editName"),
    editDesc: $("editDesc"),
    editOther: $("editOther"),
    editErrName: $("editErr-name"),
    editErrDesc: $("editErr-desc"),
    editErrOther: $("editErr-other"),
    statusMsg: $("statusMsg"),
    editCancel: $("editModalCancelBtn"),
    editSave: $("editModalSaveBtn"),

    // Suspend modal
    suspendModal: $("suspendModal"),
    suspendCancel: $("suspendModalCancelBtn"),
    suspendConfirm: $("suspendModalConfirmBtn"),

    // Reactivate modal
    reactivateModal: $("reactivateModal"),
    reactivateCancel: $("reactivateModalCancelBtn"),
    reactivateConfirm: $("reactivateModalConfirmBtn"),

    // Nav
    btnBackToDash: $("btnBackToDash"),
  };

  /* =========================================================
    3) Utilities
  ========================================================= */
  const log = (...a)=>{ if(DEBUG) console.log("[profiles]", ...a); };
  const norm = (s)=> String(s ?? "").trim().toLowerCase();
  const collapse = (s)=> String(s ?? "").replace(/\s+/g," ").trim();
  const hasText = (s)=> collapse(s).length > 0;

  const escapeHTML = (s)=>
    String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");

  const isProtectedSuspend = (name)=> PROTECTED_SUSPEND_NAMES.has(norm(name));
  const isNameLocked       = (name)=> LOCK_NAME_EDIT_NAMES.has(norm(name));
  const isReservedName     = (name)=> RESERVED_NAMES.has(norm(name));

  // Duplicate name check (ignore current record if provided)
  function isDuplicateName(newName, profiles, currentName=null){
    const t = norm(newName), cur = norm(currentName);
    return profiles.some(p => {
      const ex = norm(p?.name);
      return ex === t && ex !== cur;
    });
  }

  // Status message helpers
  function showStatusError(msg){
    DOM.statusMsg.style.display="block";
    DOM.statusMsg.style.background="#fee2e2";
    DOM.statusMsg.style.border="1px solid #fecaca";
    DOM.statusMsg.style.color="#991b1b";
    DOM.statusMsg.style.whiteSpace="normal";
    DOM.statusMsg.textContent = msg;
  }
  function showStatusDebug(endpoint, payload){
    DOM.statusMsg.style.display="block";
    DOM.statusMsg.style.background="#fef9c3";
    DOM.statusMsg.style.border="1px solid #fde047";
    DOM.statusMsg.style.color="#854d0e";
    DOM.statusMsg.style.whiteSpace="pre-wrap";
    DOM.statusMsg.textContent = `[DEBUG]\nPUT ${endpoint}\n\n${JSON.stringify(payload,null,2)}`;
  }
  function clearStatus(){ DOM.statusMsg.style.display="none"; DOM.statusMsg.textContent=""; }

  /* =========================================================
    4) State
  ========================================================= */
  let allProfiles = [];
  let currentRow = null;            // <tr> currently being edited
  let pendingSuspendRow = null;     // <tr> awaiting suspend confirm
  let pendingReactivateRow = null;  // <tr> awaiting reactivate confirm

  // Request guards
  let editing=false, suspending=false, reactivating=false;

  /* =========================================================
    5) API layer
  ========================================================= */
  async function fetchJSON(url, options={}){
    const res = await fetch(url, { credentials:"include", mode:"cors", ...options });
    const ct  = res.headers.get("content-type") || "";
    let data=null; try{ data = ct.includes("application/json") ? await res.json() : await res.text(); }catch{}
    return { ok: res.ok, status: res.status, data };
  }

  async function loadProfiles(){
    try{
      const { ok, status, data } = await fetchJSON(PROFILES_API, { method:"GET" });
      if(!ok) throw new Error(`Failed to load profiles (${status})`);
      const list = Array.isArray(data?.userProfiles) ? data.userProfiles : [];
      allProfiles = list;
      renderRows(allProfiles);
    }catch(e){
      console.error(e);
      allProfiles = [];
      renderRows(allProfiles);
      showStatusError("Unable to load profiles. Please try again later.");
    }
  }

  async function loadProfilesBySearch(keyword){
    try{
      const { ok, status, data } = await fetchJSON(`${PROFILES_API}/search?keyword=${encodeURIComponent(keyword)}`, { method:"GET" });
      if(!ok) throw new Error(`Failed to load profiles (${status})`);
      const list = Array.isArray(data?.userProfiles) ? data.userProfiles : [];
      allProfiles = list;
      renderRows(allProfiles);
    }catch(e){
      console.error(e);
      allProfiles = [];
      renderRows(allProfiles);
      showStatusError("Unable to load profiles. Please try again later.");
    }
  }

  async function updateProfileAPI(key, payload){
    return fetchJSON(`${PROFILES_API}/${key}`,{
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
  }

  async function suspendProfileAPI(key){
    return fetchJSON(`${PROFILES_API}/${key}/suspend`, { method:"POST" });
  }

  async function reinstateProfileAPI(key){
    return fetchJSON(`${PROFILES_API}/${key}/reinstate`, { method:"POST" });
  }

  /* =========================================================
    6) Rendering
  ========================================================= */
  function statusBadgeHTML(name, statusStr){
    if(isProtectedSuspend(name)){
      return `
        <span class="badge badge-protected" title="Protected role — cannot be suspended">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" width="12" height="12">
            <path d="M12 1a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/>
          </svg>
          Protected
        </span>`;
    }
    return String(statusStr).toUpperCase() === STATUS.SUSPENDED
      ? '<span class="badge badge-suspended">Suspended</span>'
      : '<span class="badge badge-active">Active</span>';
  }

  function actionButtonHTML(name, statusStr){
    if(isProtectedSuspend(name)){
      return '<button class="btn-suspend" disabled title="Protected role — cannot be suspended">Suspend</button>';
    }
    return String(statusStr).toUpperCase() === STATUS.SUSPENDED
      ? '<button class="btn-reactivate" onclick="openReactivateModal(this)">Reactivate</button>'
      : '<button class="btn-suspend" onclick="openSuspendModal(this)">Suspend</button>';
  }

  function rowHTML(p){
    const rawName = String(p?.name ?? "");
    const status  = (p?.status || STATUS.ACTIVE).toUpperCase();
    const name    = escapeHTML(p?.name);
    const desc    = escapeHTML(p?.description);
    const other   = p?.other ? escapeHTML(p.other) : "";
    const key     = encodeURIComponent(rawName);

    return `
      <tr data-key="${key}" data-raw="${rawName}" data-status="${status}">
        <td class="name">${name}</td>
        <td class="description">${desc}</td>
        <td class="other">${other}</td>
        <td class="status">${statusBadgeHTML(rawName, status)}</td>
        <td class="actions">
          <div class="btn-row">
            <button class="btn-edit" onclick="openEditModal(this.closest('tr'))">Edit</button>
            ${actionButtonHTML(rawName, status)}
          </div>
        </td>
      </tr>
    `;
  }

  function renderRows(profiles){
    DOM.tbody.innerHTML = profiles
      .slice()
      .sort((a,b)=> String(a.name).localeCompare(String(b.name), undefined, { sensitivity:"base" }))
      .map(rowHTML)
      .join("");
    updateNoResultsRow();
  }

  function updateNoResultsRow(){
    const rows = $$("#profileTable tbody tr");
    const anyVisible = rows.some(r => r.style.display !== "none");
    DOM.noResultsRow.style.display = anyVisible ? "none" : "";
  }

  function setRowStatus(tr, nextStatus){
    const status = (nextStatus || STATUS.ACTIVE).toUpperCase();
    const rawName = tr.dataset.raw;
    tr.dataset.status = status;
    tr.querySelector(".status").innerHTML = statusBadgeHTML(rawName, status);

    const btnRow = tr.querySelector(".actions .btn-row");
    const curAct = btnRow.querySelector(".btn-suspend, .btn-reactivate");
    const tmp = document.createElement("div");
    tmp.innerHTML = actionButtonHTML(rawName, status);
    const fresh = tmp.firstElementChild;
    curAct ? curAct.replaceWith(fresh) : btnRow.appendChild(fresh);
  }

  /* =========================================================
    7) Modal logic + validation
  ========================================================= */
  function openEditModal(tr){
    currentRow = tr;

    const currentNameRaw = tr.dataset.raw || "";
    DOM.editName.value  = tr.querySelector(".name")?.textContent?.trim() || "";
    DOM.editDesc.value  = tr.querySelector(".description")?.textContent?.trim() || "";
    DOM.editOther.value = tr.querySelector(".other")?.textContent?.trim() || "";

    // lock name if reserved
    DOM.editName.disabled = isNameLocked(currentNameRaw);
    DOM.editName.title = DOM.editName.disabled
      ? "This profile name is reserved; it cannot be changed."
      : "";

    // reset field errors + status
    clearStatus();
    [DOM.editErrName, DOM.editErrDesc, DOM.editErrOther].forEach(el => el.style.display="none");
    [DOM.editName, DOM.editDesc, DOM.editOther].forEach(el => el.removeAttribute("aria-invalid"));

    DOM.editModal.style.display="flex";
  }
  function closeEditModal(){
    DOM.editModal.style.display="none";
    DOM.editName.disabled = false;
    [DOM.editName, DOM.editDesc, DOM.editOther].forEach(el => { el.disabled=false; el.removeAttribute("aria-invalid"); });
    [DOM.editErrName, DOM.editErrDesc, DOM.editErrOther].forEach(el => el.style.display="none");
    clearStatus();
  }

  function validateNameInline(){
    const el  = DOM.editName;
    if(el.disabled) { DOM.editErrName.style.display="none"; el.removeAttribute("aria-invalid"); return true; }

    const raw = el.value;
    const v   = collapse(raw);

    if(!hasText(v) || v.length > NAME_MAX){
      DOM.editErrName.textContent = `Please enter a valid name (1–${NAME_MAX} characters).`;
      DOM.editErrName.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    if(isReservedName(v)){
      DOM.editErrName.textContent = "This name is reserved and cannot be used.";
      DOM.editErrName.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    if(isDuplicateName(v, allProfiles, currentRow?.dataset?.raw)){
      DOM.editErrName.textContent = "A profile with that name already exists.";
      DOM.editErrName.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    DOM.editErrName.style.display="none";
    el.removeAttribute("aria-invalid");
    return true;
  }

  function validateDescInline(){
    const el = DOM.editDesc;
    const v  = collapse(el.value);
    if(v.length > DESC_MAX){
      DOM.editErrDesc.textContent = `Description must be ${DESC_MAX} characters or fewer.`;
      DOM.editErrDesc.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    DOM.editErrDesc.style.display="none";
    el.removeAttribute("aria-invalid");
    return true;
  }

  function validateOtherInline(){
    const el = DOM.editOther;
    const v  = collapse(el.value);
    if(v.length > OTHER_MAX){
      DOM.editErrOther.textContent = `Other info must be ${OTHER_MAX} characters or fewer.`;
      DOM.editErrOther.style.display="block";
      el.setAttribute("aria-invalid","true");
      return false;
    }
    DOM.editErrOther.style.display="none";
    el.removeAttribute("aria-invalid");
    return true;
  }

  function validateEditForm(){
    const a = validateNameInline();
    const b = validateDescInline();
    const c = validateOtherInline();
    if(!a && !DOM.editName.disabled){ DOM.editName.focus({preventScroll:true}); return false; }
    if(!b){ DOM.editDesc.focus({preventScroll:true}); return false; }
    if(!c){ DOM.editOther.focus({preventScroll:true}); return false; }
    return true;
  }

  async function saveEditModal(){
    if(editing || !currentRow) return;
    if(!validateEditForm()) return;

    editing = true;
    clearStatus();

    // read raw, then normalize for persistence
    const name = DOM.editName.disabled ? currentRow.dataset.raw : collapse(DOM.editName.value);
    const description = collapse(DOM.editDesc.value);
    const other = collapse(DOM.editOther.value);

    const curRaw   = currentRow.dataset.raw;
    const curDesc  = currentRow.querySelector(".description").textContent.trim();
    const curOther = currentRow.querySelector(".other").textContent.trim();
    const curKey   = currentRow.dataset.key;

    // lock UI
    const origText = DOM.editSave.textContent;
    DOM.editSave.disabled = true;  DOM.editSave.textContent = "Updating...";
    DOM.editCancel.disabled = true;
    [DOM.editName, DOM.editDesc, DOM.editOther].forEach(el => el.disabled = true);

    // nothing changed
    if(name === curRaw && description === curDesc && other === curOther){
      await new Promise(r => setTimeout(r, 300));
      DOM.editSave.disabled=false; DOM.editSave.textContent = origText;
      DOM.editCancel.disabled=false;
      [DOM.editName, DOM.editDesc, DOM.editOther].forEach(el => el.disabled = false);
      editing=false;
      closeEditModal();
      return;
    }

    // DEBUG path
    if(DEBUG){
      showStatusDebug(`${PROFILES_API}/${curKey}`, { name, description, other });
      await new Promise(r => setTimeout(r, 400));
      DOM.editSave.disabled=false; DOM.editSave.textContent = origText;
      DOM.editCancel.disabled=false;
      [DOM.editName, DOM.editDesc, DOM.editOther].forEach(el => el.disabled = false);
      editing=false;
      return;
    }

    try{
      const { ok, status } = await updateProfileAPI(curKey, { name, description, other });
      if(!ok) throw new Error(`Update failed (${status})`);

      // Update row
      currentRow.querySelector(".name").textContent = name;
      currentRow.querySelector(".description").textContent = description;
      currentRow.querySelector(".other").textContent = other;
      currentRow.dataset.raw = name;
      currentRow.dataset.key = encodeURIComponent(name);

      // Update cache
      const i = allProfiles.findIndex(p => norm(p.name) === norm(curRaw));
      if(i !== -1) allProfiles[i] = { ...allProfiles[i], name, description, other };

      await new Promise(r => setTimeout(r, 500));
      closeEditModal();
    }catch(e){
      console.error(e);
      showStatusError("Could not save changes. Please try again.");
    }finally{
      DOM.editSave.disabled=false; DOM.editSave.textContent = origText;
      DOM.editCancel.disabled=false;
      [DOM.editName, DOM.editDesc, DOM.editOther].forEach(el => el.disabled = false);
      editing=false;
    }
  }

  // Suspend modal
  function openSuspendModal(button){
    const row = button.closest("tr");
    const name = row?.dataset?.raw || "";
    if(isProtectedSuspend(name)) return;
    pendingSuspendRow = row;
    DOM.suspendModal.style.display="flex";
  }

  function closeSuspendModal(){
    DOM.suspendModal.style.display="none";
    pendingSuspendRow = null;
  }
  
  async function confirmSuspend(){
    if(!pendingSuspendRow || suspending) return;
    suspending = true;

    const key = pendingSuspendRow.dataset.key;
    if (!key) {
      showStatusError("Internal Error: Missing profile key.");
      suspending = false;
      return;
    }

    const origText = DOM.suspendConfirm.textContent;
    DOM.suspendConfirm.disabled=true; DOM.suspendConfirm.textContent="Suspending...";
    DOM.suspendCancel.disabled=true;

    try{
      const { ok, status } = await suspendProfileAPI(key);
      if(!ok) throw new Error(`Suspend failed (${status})`);
      setRowStatus(pendingSuspendRow, STATUS.SUSPENDED);
    }catch(e){
      console.error(e);
      showStatusError("Could not suspend. Please try again.");
    }finally{
      await new Promise(r => setTimeout(r, 500));
      DOM.suspendConfirm.disabled=false; DOM.suspendConfirm.textContent=origText;
      DOM.suspendCancel.disabled=false;
      suspending=false;
      closeSuspendModal();
    }
  }

  // Reactivate modal
  function openReactivateModal(button){
    pendingReactivateRow = button.closest("tr");
    DOM.reactivateModal.style.display="flex";
  }

  function closeReactivateModal(){
    DOM.reactivateModal.style.display="none";
    pendingReactivateRow = null;
  }

  async function confirmReactivate(){
    if(!pendingReactivateRow || reactivating) return;
    reactivating = true;

    const key = pendingReactivateRow.dataset.key;
    if (!key) {
      showStatusError("Internal Error: Missing profile key.");
      reactivating = false;
      return;
    }
    
    const origText = DOM.reactivateConfirm.textContent;
    DOM.reactivateConfirm.disabled=true; DOM.reactivateConfirm.textContent="Reactivating...";
    DOM.reactivateCancel.disabled=true;

    try{
      const { ok, status } = await reinstateProfileAPI(key);
      if(!ok) throw new Error(`Reinstate failed (${status})`);
      setRowStatus(pendingReactivateRow, STATUS.ACTIVE);
    }catch(e){
      console.error(e);
      showStatusError("Could not reactivate. Please try again.");
    }finally{
      await new Promise(r => setTimeout(r, 500));
      DOM.reactivateConfirm.disabled=false; DOM.reactivateConfirm.textContent=origText;
      DOM.reactivateCancel.disabled=false;
      reactivating=false;
      closeReactivateModal();
    }
  }

  /* =========================================================
    8) Search
  ========================================================= */
  function handleSearchInput(){
    const q = DOM.search.value.trim().toLowerCase();
    loadProfilesBySearch(q);
    updateNoResultsRow();
  }

  /* =========================================================
    9) Boot
  ========================================================= */
  (async function init(){
    await loadProfiles();

    // Search
    DOM.search.addEventListener("input", handleSearchInput);

    // Edit modal
    DOM.editSave.addEventListener("click", saveEditModal);
    DOM.editCancel.addEventListener("click", closeEditModal);
    DOM.editName.addEventListener("input", validateNameInline);
    DOM.editName.addEventListener("blur",  validateNameInline);
    DOM.editDesc.addEventListener("input", validateDescInline);
    DOM.editDesc.addEventListener("blur",  validateDescInline);
    DOM.editOther.addEventListener("input", validateOtherInline);
    DOM.editOther.addEventListener("blur",  validateOtherInline);

    // Suspend modal
    DOM.suspendConfirm.addEventListener("click", confirmSuspend);
    DOM.suspendCancel.addEventListener("click", closeSuspendModal);

    // Reactivate modal
    DOM.reactivateConfirm.addEventListener("click", confirmReactivate);
    DOM.reactivateCancel.addEventListener("click", closeReactivateModal);

    // Nav
    DOM.btnBackToDash.addEventListener("click", ()=>{ window.location.href = "admin_dashboard.html"; });
  })();

  // Expose modal openers like category page
  window.openEditModal = openEditModal;
  window.openSuspendModal = openSuspendModal;
  window.openReactivateModal = openReactivateModal;
  </script>
</body>
</html>
