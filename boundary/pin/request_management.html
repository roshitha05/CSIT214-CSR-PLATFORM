<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Requests</title>

    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"
    />
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root{
        --bg-light:#f7f9fc; --primary:#34495e; --secondary:#2c3e50;
        --accent:#3498db; --accent-2:#2980b9; --text-dark:#2c3e50; --text-light:#fff;
        --shadow:0 4px 10px rgba(0,0,0,.1); --border:#eef2f7;
        --danger:#ef4444; --ring:rgba(14,165,233,.3);
        --tray-max: 760px;
      }

      /* ========= Base ========= */
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:"Poppins",sans-serif;background:var(--bg-light);color:var(--text-dark)}

      /* ========= Layout ========= */
      .main{min-height:100%; display:flex; flex-direction:column; gap:1.5rem; padding:2rem}

      /* ========= Topbar ========= */
      .topbar{display:flex; justify-content:space-between; align-items:center}
      .topbar h1{font-size:1.6rem; font-weight:600; margin:0}
      .search-bar input{
        padding:.6rem 1rem;border:1px solid #ccc;border-radius:8px;width:260px;outline:none
      }
      .btn.outline{
        background:#fff; border:1px solid #cbd5e1; color:var(--secondary);
        padding:.55rem .9rem; border-radius:10px; display:inline-flex; align-items:center;
        gap:.45rem; box-shadow:0 1px 2px rgba(0,0,0,.03); cursor:pointer;
      }
      .btn.outline:hover{ background:#f8fafc; }
      .controls-tray{
        display:flex;
        align-items:center;
        gap:.6rem;
        width:min(100%, var(--tray-max));
        margin-left:auto;                 /* push to the right in the topbar */
      }

      .controls-tray .search-bar{ flex:1 1 auto; }    /* search grows */
      .controls-tray .search-bar input{ width:100%; } /* fill its slot */

      /* Match the completed-filters width & right alignment */
      #completedFilters{
        width:min(100%, var(--tray-max));
        margin-left:auto;
      }

      /* Optional: make heights match nicely */
      .controls-tray .search-bar input{ height:40px; }
      .btn.outline{ height:40px; }

      /* ========= Filters: segmented + completed-only row ========= */
      .filters{display:flex; align-items:center; gap:1rem}
      .segmented{display:flex; gap:.5rem; align-items:center}
      .grow{flex:1 1 auto; min-width:12px}
      .filters-actions{display:flex; align-items:center; gap:.75rem}

      /* Reuse your original filter-btn look but make it “pill segmented” */
      .filter-btn{
        padding:.5rem 1rem; background:#fff; border:1px solid var(--accent); border-radius:999px;
        color:var(--accent); cursor:pointer; transition:.25s
      }
      .filter-btn.active,
      .filter-btn:hover{background:var(--accent); color:#fff; box-shadow:0 0 0 3px var(--ring); border-color:var(--accent)}

      /* Completed-only filters container (hidden by default; shown via JS) */
      .completed-filters{
        display:flex; align-items:center; gap:.75rem;
        background:#fff; border:1px solid var(--border); border-radius:10px;
        padding:.6rem .8rem; box-shadow:0 2px 8px rgba(0,0,0,.04)
      }
      .filter-label{font-size:.85rem;color:#64748b;margin-right:.25rem;white-space:nowrap}
      .date-group{display:flex;align-items:center;gap:.5rem}
      .range-sep{display:inline-block;width:14px;text-align:center;color:#94a3b8}

      /* Inputs inside the completed chip */
      .completed-filters .select,
      .completed-filters .input{
        height:36px;padding:0 12px;border-radius:8px;font-size:.92rem;
        border:1px solid #cbd5e1;background:#f8fafc;color:var(--text-dark);
        transition:border-color .2s, box-shadow .2s
      }
      .completed-filters .select:focus,
      .completed-filters .input:focus{outline:none;border-color:var(--accent-2);box-shadow:0 0 0 3px var(--ring)}
      .completed-filters[hidden]{ display:none !important; }
      /* Optionally show when parent has .show-completed (we’ll toggle this via JS) */
      #filtersBar.show-completed .completed-filters{ display:flex; }

      /* ========= Card Grid ========= */
      .cards{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
        gap:1.5rem;
        align-items:stretch;
      }

      /* ========= Card ========= */
      .card{
        background:#fff;border-radius:12px;box-shadow:var(--shadow);
        transition:transform .3s, box-shadow .3s;display:flex;flex-direction:column;height:100%;
      }
      .card:hover{transform:translateY(-5px);box-shadow:0 6px 15px rgba(0,0,0,.15)}

      /* ========= Card Header ========= */
      .card-header{
        display:flex;justify-content:space-between;align-items:center;
        padding:1rem 1.25rem;border-bottom:1px solid var(--border);
        border-top-left-radius:12px;border-top-right-radius:12px;
        background:#f3f8ff;
      }
      .card-head-left{display:flex;flex-direction:column;gap:.3rem;min-width:0}
      .card-title{font-size:1.1rem;font-weight:700;color:var(--accent-2);margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .card-meta{display:flex;gap:.5rem;align-items:center}
      .id-pill{
        font-size:.72rem;line-height:1;padding:.25rem .5rem;border-radius:999px;
        background:#eef4ff;color:#476099;border:1px solid #dfe8ff;white-space:nowrap
      }

      .status-badge{
        font-size:.75rem;padding:.25rem .6rem;border-radius:999px;font-weight:600;border:1px solid #e6eef8
      }
      .status-ACTIVE{background:#ecf5ff;color:#1f6fba;border-color:#d6e9ff}
      .status-COMPLETED{background:#edf9f0;color:#1f8a4d;border-color:#d9f2e0}
      .status-CANCELLED{background:#fee2e2;color:#991b1b;border-color:#fca5a5}

      /* ========= Body / Footer ========= */
      .card-body{padding:1rem 1.25rem 0;background:#fff;flex:1 1 auto}
      .card-row{display:flex;gap:.5rem;margin:.35rem 0;flex-wrap:wrap}
      .card-label{font-weight:600;color:var(--secondary)}
      .muted{color:#666}

      .card-footer{
        display:flex;justify-content:space-between;align-items:center;gap:1rem;
        padding:.9rem 1.25rem;border-top:1px solid var(--border);margin-top:auto;background:#fbfcff;
      }
      .metrics{display:flex;align-items:center;gap:1rem}
      .metric{display:flex;align-items:center;gap:.45rem;font-size:.92rem;color:#555}
      .metric i{font-size:1rem}
      .metric .count{min-width:1ch;text-align:right}

      .actions{display:flex;gap:.5rem}
      .btn{padding:.45rem .9rem;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:500}
      .btn.edit{background:var(--accent);color:#fff}
      .btn.edit:hover{background:var(--accent-2)}

      .btn-cancel-request,
      .btn-restore-request{
        padding:.45rem .9rem;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:500
      }
      .btn-cancel-request{background:var(--danger);color:#fff}
      .btn-cancel-request:hover{opacity:.9}
      .btn-restore-request{background:#22c55e;color:#fff}
      .btn-restore-request:hover{opacity:.9}

      /* ========= Disabled: ensure cursor shows not-allowed ========= */
      button:disabled,
      .btn:disabled,
      .btn.is-disabled{
        opacity:.55 !important;
        cursor:not-allowed !important;
      }
      /* also affect children (icons/spans) */
      button:disabled *, .btn:disabled *{ cursor:not-allowed !important; }

      /* ========= Modal ========= */
      .modal-backdrop{
        position:fixed;inset:0;background:rgba(0,0,0,.35);
        display:none;align-items:center;justify-content:center;
        padding:1.5rem;z-index:1000;
      }
      .modal{width:100%;max-width:560px;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
      .modal-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid var(--border);background:#f7fbff}
      .modal-title{font-size:1.05rem;font-weight:700;margin:0;color:var(--secondary)}
      .modal-close{background:transparent;border:none;font-size:1.2rem;cursor:pointer;line-height:1;padding:.25rem;color:#666}
      .modal-body{padding:1rem 1.25rem;display:grid;gap:14px;margin-top:2px}
      .modal-footer{display:flex;justify-content:flex-end;gap:.5rem;padding:1rem 1.25rem;border-top:1px solid var(--border);background:#fbfcff}

      /* Inputs + validation in modal */
      .input,.select,.textarea{
        width:100%;background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;
        padding:12px 14px;font-size:.95rem;transition:border-color .15s,box-shadow .15s,background .15s;
      }
      .input:focus,.select:focus,.textarea:focus{outline:none;border-color:var(--accent-2);box-shadow:0 0 0 3px var(--ring)}
      .textarea{min-height:120px;resize:vertical}

      .hint{display:block;margin-top:6px;font-size:.85rem;color:#64748b}
      .field-error{display:none;margin-top:6px;color:var(--danger);font-size:.9rem}
      [aria-invalid="true"]{border-color:var(--danger)!important;box-shadow:0 0 0 3px rgba(239,68,68,.15)!important;background:#fff7f7}

      .btn.primary{background:var(--accent);color:#fff}
      .btn.primary:hover{background:var(--accent-2)}
      .btn.ghost{background:#eef2f7;color:#34495e}

      /* ========= Responsive ========= */
      @media (max-width: 720px){
        #filtersBar{gap:.6rem}
        .completed-filters{flex-wrap:wrap;width:100%}
        .date-group{width:100%}
        .date-group .input{flex:1 1 0;min-width:120px}
        .filters-actions{width:100%;justify-content:space-between;margin-top:.25rem}
      }

      @media (max-width:480px){
        .search-bar input{width:100%}
        .card-footer{flex-direction:column;align-items:flex-start}
      }
    </style>
  </head>

  <body>
    <main class="main">
      <div class="topbar">
        <h1>Manage Requests</h1>

        <!-- Top right bar (search + return to dashboard)-->
        <div class="controls-tray">
          <div class="search-bar">
            <input type="text" placeholder="Search requests..." />
          </div>

          <button type="button" class="btn outline" id="btnBackToDash">
            <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
            <span>Return to Dashboard</span>
          </button>
        </div>
        
      </div>

      <!-- Filter bar -->
      <div class="filters" id="filtersBar" style="flex-wrap:wrap;row-gap:.5rem">Filters:
        <!-- Status segmented -->
        <div class="segmented" role="tablist" aria-label="Status">
          <button class="filter-btn active" data-status="ALL"        role="tab" aria-selected="true">All</button>
          <button class="filter-btn"        data-status="ACTIVE"     role="tab">Active</button>
          <button class="filter-btn"        data-status="CANCELLED"  role="tab">Cancelled</button>
          <button class="filter-btn"        data-status="COMPLETED"  role="tab">Completed</button>
        </div>

        <!-- Spacer pushes actions to the right on wide screens -->
        <div class="grow"></div>

        <!-- Completed-only filters (hidden by default; shown when “Completed” is active) -->
        <div id="completedFilters" class="completed-filters" hidden>
          <label class="filter-label" for="svc">Service</label>
          <select id="svc" class="select">
            <option value="">All services</option>
            <!-- populated later from /categories -->
          </select>

          <div class="date-group" aria-label="Completed date range">
            <label class="filter-label" for="from">From</label>
            <input type="date" id="from" class="input" />
            <span class="range-sep" aria-hidden="true">–</span>
            <label class="filter-label" for="to">To</label>
            <input type="date" id="to" class="input" />
          </div>

          <div class="grow"></div>
          <button class="btn ghost" id="resetFilters">Reset</button>
          <span id="resultSummary" class="muted"></span>
        </div>
      </div>

      <div class="cards" id="cards"></div>

      <!-- Template used to render cards -->
      <template id="card-template">
        <article class="card" data-status="">
          <header class="card-header">
            <div class="card-head-left">
              <h3 class="card-title"></h3>
              <div class="card-meta">
                <span class="id-pill" data-field="service_request_id"></span>
              </div>
            </div>
            <span class="status-badge"></span>
          </header>

          <div class="card-body">
            <p class="card-row"><span class="card-label">Category:</span> <span data-field="category" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Description:</span> <span data-field="description" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Date created:</span> <span data-field="date_created" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Date completed:</span> <span data-field="date_completed" class="muted"></span></p>
          </div>

          <footer class="card-footer">
            <div class="metrics" aria-label="Request metrics">
              <span class="metric" title="Views">
                <i class="fa-solid fa-eye" aria-hidden="true"></i>
                <span class="count" data-field="view_count">0</span>
              </span>
              <span class="metric" title="Number of times shortlisted by volunteers">
                <i class="fa-regular fa-bookmark" aria-hidden="true"></i>
                <span class="count" data-field="shortlisted_by_count">0</span>
              </span>
            </div>

            <div class="actions">
              <button class="btn edit">Edit</button>
            </div>
          </footer>
        </article>
      </template>

      <!-- Edit Modal -->
      <div class="modal-backdrop" id="editModalBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
          <div class="modal-header">
            <h3 class="modal-title" id="editModalTitle">Edit Request</h3>
            <button class="modal-close" id="editModalClose" aria-label="Close">&times;</button>
          </div>
          <form id="editForm" novalidate>
            <div class="modal-body">
              <input type="hidden" name="service_request_id" id="edit_id" />

              <div class="form-row">
                <label for="edit_title">Title <span style="color:var(--muted)">*</span></label>
                <input class="input" type="text" id="edit_title" name="title" required />
                <small class="hint">Required. 1–80 characters.</small>
                <div id="editErr-title" class="field-error">Please enter a valid title (1–80 characters).</div>
              </div>

              <div class="form-row">
                <label for="edit_category">Category <span style="color:var(--muted)">*</span></label>
                <select class="select" id="edit_category" name="category" required></select>
                <small class="hint">Choose the most accurate category.</small>
                <div id="editErr-category" class="field-error">Please select a category.</div>
              </div>

              <div class="form-row">
                <label for="edit_description">Description <span style="color:var(--muted)">*</span></label>
                <textarea class="textarea" id="edit_description" name="description" required></textarea>
                <small class="hint">Required. Up to 255 characters.</small>
                <div id="editErr-description" class="field-error">Please enter a valid description (max 255 characters).</div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn ghost" id="editModalCancelBtn">Cancel</button>
              <button type="submit" class="btn primary" id="editModalSaveBtn">Save</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Confirm Cancel Modal -->
      <div class="modal-backdrop" id="cancelModalBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cancelModalTitle">
          <div class="modal-header">
            <h3 class="modal-title" id="cancelModalTitle">Confirm Cancel</h3>
            <button class="modal-close" id="cancelModalClose" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to cancel this request?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn ghost" id="cancelModalCancelBtn">Cancel</button>
            <button type="button" class="btn primary" id="cancelModalConfirmBtn">Confirm</button>
          </div>
        </div>
      </div>

      <!-- Confirm Restore Modal -->
      <div class="modal-backdrop" id="restoreModalBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="restoreModalTitle">
          <div class="modal-header">
            <h3 class="modal-title" id="restoreModalTitle">Confirm Restore</h3>
            <button class="modal-close" id="restoreModalClose" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to restore this request?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn ghost" id="restoreModalCancelBtn">Cancel</button>
            <button type="button" class="btn primary" id="restoreModalConfirmBtn">Confirm</button>
          </div>
        </div>
      </div>

    </main>

    <script>
      /* =========================================================
        1) Config & constants
      ========================================================= */
      const DEBUG             = false;
      const API_URL           = "http://127.0.0.1:80/api";
      const CATEGORIES_API    = `${API_URL}/categories`;
      const SERVICE_REQUEST_API = `${API_URL}/service-requests`;
      const STATUS = { ACTIVE:"ACTIVE", COMPLETED:"COMPLETED", CANCELLED:"CANCELLED" };
      const TITLE_MAX = 120, DESC_MAX = 255;

      /* =========================================================
        2) DOM shortcuts
      ========================================================= */
      const $  = (id) => document.getElementById(id);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const DOM = {
        // Lists & templates
        cardsWrap: $("cards"),
        tpl: $("card-template"),

        // Status segmented + completed-only filters
        filterBtns: $$(".segmented .filter-btn"),
        filtersBar: $("filtersBar"),
        completedFilters: $("completedFilters"),
        filtersActions: document.querySelector(".filters-actions"),
        svc: $("svc"),
        dateFrom: $("from"),
        dateTo: $("to"),
        resetBtn: $("resetFilters"),

        // Edit modal
        editModalBackdrop: $("editModalBackdrop"),
        editForm: $("editForm"),
        editId: $("edit_id"),
        editTitle: $("edit_title"),
        editCategory: $("edit_category"),
        editDescription: $("edit_description"),
        editClose: $("editModalClose"),
        editCancel: $("editModalCancelBtn"),
        editSave: $("editModalSaveBtn"),
      };

      /* =========================================================
        3) Utilities
      ========================================================= */
      const log = (...a)=>{ if(DEBUG) console.log("[requests]", ...a); };
      const collapse = (s)=>String(s ?? "").replace(/\s+/g," ").trim();

      /* =========================================================
        4) State
      ========================================================= */
      let categoriesActive = [];          // active names (sorted)
      let categoriesAllMap = new Map();   // name -> status (ACTIVE/ARCHIVED)
      let currentEditCard  = null;

      // Current status selection for filtering UI
      let currentStatus = "ALL";          // "ALL" | "ACTIVE" | "CANCELLED" | "COMPLETED"

      // TEMP data until connected to backend
      const demoData = [
        { service_request_id:1, title:"Need grocery shopping assistance", description:"Elderly person unable to shop for groceries due to mobility issues.", category:"Food Support", status:"ACTIVE", view_count:3, date_created:"2025-10-24 04:52:14.360+00", date_completed:null, shortlisted_by_count:2 },
        { service_request_id:2, title:"Ride to medical appointment", description:"Single mother needs transportation to clinic for child’s checkup.", category:"Transportation", status:"COMPLETED", view_count:7, date_created:"2025-10-24 04:52:14.360+00", date_completed:"2025-10-26 08:15:00.000+00", shortlisted_by_count:5 }
      ];

      /* =========================================================
        5) API layer
      ========================================================= */
      async function fetchJSON(url, options={}) {
        const res = await fetch(url, { credentials:"include", mode:"cors", ...options });
        const ct  = res.headers.get("content-type") || "";
        let data=null; try{ data = ct.includes("application/json") ? await res.json() : await res.text(); }catch{}
        return { ok: res.ok, status: res.status, data };
      }

      async function loadCategories() {
        try {
          const { ok, status, data } = await fetchJSON(CATEGORIES_API);
          if (!ok) throw new Error(`Categories load failed (${status})`);

          const list = Array.isArray(data?.categories) ? data.categories : [];
          categoriesAllMap = new Map(
            list
              .map(c => [ String(c?.name || ""), String(c?.status || "").toUpperCase() ])
              .filter(([name]) => !!name)
          );

          categoriesActive = [...categoriesAllMap.entries()]
            .filter(([, st]) => st === "ACTIVE")
            .map(([name]) => name)
            .sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));

          // Clear any error state if previously shown
          clearCategoryLoadError();
          setCategoryOptions(categoriesActive);
          DOM.editCategory.disabled = false;
          DOM.editSave.disabled = false;

        } catch (e) {
          console.error(e);
          showCategoryLoadError("Unable to load categories at the moment. Please try again later.");
          DOM.editCategory.disabled = true;
          DOM.editSave.disabled = true;
          categoriesAllMap.clear();
          categoriesActive = [];
          setCategoryOptions([]); // empty list
        }
      }

      async function loadServiceRequests() {
        try {
          const { ok, status, data } = await fetchJSON(`${SERVICE_REQUEST_API}/${localStorage.getItem('user_id')}`);
          if (!ok) throw new Error(`Service requests load failed (${status})`);
          const serviceRequests = Array.isArray(data) ? data : [];

          await Promise.all(
            serviceRequests.map(async (request) => {
              const viewsRequest = await fetchJSON(
                `${SERVICE_REQUEST_API}/${request.service_request_id}/views`
              );
              request.view_count = viewsRequest.data;
            })
          );

          return serviceRequests;
        } catch (e) {
          console.error(e);
        }
      }

      async function cancelServiceRequest(service_request_id) {
        const { ok, status, data } = await fetchJSON(
          `${SERVICE_REQUEST_API}/${service_request_id}`,
          { method: 'DELETE' }
        );
        if (!ok) throw new Error(`Service request cancellation failed (${status})`);
      }

      async function restoreServiceRequest(service_request_id) {
        const { ok, status, data } = await fetchJSON(
          `${SERVICE_REQUEST_API}/${service_request_id}/restore`,
          { method: 'POST' }
        );
        if (!ok) throw new Error(`Service request restoration failed (${status})`);
      }

      async function editServiceRequest(service_request_id, payload) {
        const { ok, status, data } = await fetchJSON(
          `${SERVICE_REQUEST_API}/${service_request_id}`,
          { 
            method: 'PUT', 
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          }
        );
        if (!ok) throw new Error(`Service request update failed (${status})`);
      }

      /* =========================================================
        6) Rendering
      ========================================================= */
      function setCategoryOptions(activeNames, currentValue = "") {
        // Populate dropdown with ACTIVE categories (sorted)
        DOM.editCategory.innerHTML = "";
        activeNames.forEach(name=>{
          const o = document.createElement("option");
          o.value = name; o.textContent = name;
          DOM.editCategory.appendChild(o);
        });

        // If current value is archived, include it as "(Archived)" once
        if (currentValue && !activeNames.includes(currentValue)) {
          const status = categoriesAllMap.get(currentValue);
          if (status && status !== "ACTIVE") {
            const o = document.createElement("option");
            o.value = currentValue;
            o.textContent = `${currentValue} (Archived)`;
            o.dataset.archived = "true"; // informational
            DOM.editCategory.appendChild(o);
          }
        }

        // Select current if present; otherwise select first
        if (currentValue && [...DOM.editCategory.options].some(o=>o.value===currentValue)) {
          DOM.editCategory.value = currentValue;
        } else if (DOM.editCategory.options.length) {
          DOM.editCategory.value = DOM.editCategory.options[0].value;
        }
      }

      function applyStatusBadge(badgeEl, status) {
        badgeEl.className = "status-badge";
        const s = String(status||"").toUpperCase();
        badgeEl.classList.add(`status-${s}`);
        badgeEl.textContent = s.charAt(0) + s.slice(1).toLowerCase();
      }

      function renderCards(items=[]) {
        DOM.cardsWrap.innerHTML = "";
        items.forEach((item)=>{
          const node = DOM.tpl.content.cloneNode(true);
          const card = node.querySelector(".card");

          card.dataset.id     = item.service_request_id;
          card.dataset.status = item.status;

          node.querySelector(".card-title").textContent = item.title || "(Untitled request)";
          node.querySelector('[data-field="service_request_id"]').textContent = `#${item.service_request_id}`;
          applyStatusBadge(node.querySelector(".status-badge"), item.status);

          node.querySelector('[data-field="category"]').textContent     = item.category ?? "";
          node.querySelector('[data-field="description"]').textContent  = item.description ?? "";
          node.querySelector('[data-field="date_created"]').textContent = item.date_created ?? "";
          node.querySelector('[data-field="date_completed"]').textContent = item.date_completed ?? "—";

          node.querySelector('[data-field="view_count"]').textContent           = item.view_count ?? 0;
          node.querySelector('[data-field="shortlisted_by_count"]').textContent = item.shortlisted_by_count ?? 0;

          const editBtn    = node.querySelector(".btn.edit");
          const actionSlot = node.querySelector(".actions");
          const actionBtn  = document.createElement("button");
          actionBtn.className = "btn-cancel-request";
          actionBtn.textContent = "Cancel Request";

          // Edit modal
          editBtn.addEventListener("click", ()=>{
            if (editBtn.disabled) return;
            currentEditCard = card;
            populateEditModalFromCard(card);
            openEditModal();
          });

          // Cancel/Restore toggle (no backend yet)
          actionBtn.addEventListener("click", async ()=>{
            if (actionBtn.disabled) return;
            const current = card.dataset.status;
            
            if (current === STATUS.ACTIVE) {
              try {
                await cancelServiceRequest(card.dataset.id);
                setCardState(card, STATUS.CANCELLED);
              } catch (e) {
                console.error(e)
              }
            }
            if (current === STATUS.CANCELLED) {
              try {
                await restoreServiceRequest(card.dataset.id);
                setCardState(card, STATUS.ACTIVE);
              } catch (e) {
                console.error(e)
              }
            }
          });

          actionSlot.appendChild(actionBtn);
          refreshFooterActionsForState(card, { editBtn, actionBtn });

          DOM.cardsWrap.appendChild(node);
        });

        // Apply current status filter to the freshly rendered cards
        applyStatusFilter();
      }

      function refreshFooterActionsForState(card, { editBtn, actionBtn }) {
        const st = card.dataset.status;
        editBtn.style.display = "";
        actionBtn.style.display = "";

        if (st === STATUS.ACTIVE) {
          editBtn.disabled = false;
          actionBtn.disabled = false;
          actionBtn.className = "btn-cancel-request";
          actionBtn.textContent = "Cancel Request";
        } else if (st === STATUS.CANCELLED) {
          editBtn.disabled = true;
          actionBtn.disabled = false;
          actionBtn.className = "btn-restore-request";
          actionBtn.textContent = "Restore Request";
        } else if (st === STATUS.COMPLETED) {
          editBtn.disabled = true;
          actionBtn.disabled = true;
          actionBtn.className = "btn-cancel-request";
          actionBtn.textContent = "Cancel Request";
        }
      }

      function setCardState(card, nextStatus) {
        card.dataset.status = nextStatus;
        applyStatusBadge(card.querySelector(".status-badge"), nextStatus);
        const editBtn   = card.querySelector(".btn.edit");
        const actionBtn = card.querySelector(".btn-cancel-request, .btn-restore-request")
                        || card.querySelector(".actions button");
        refreshFooterActionsForState(card, { editBtn, actionBtn });

        // Re-apply list filtering so the card may hide/show based on currentStatus
        applyStatusFilter();
      }

      /* =========================================================
        7) Modal logic + validation
      ========================================================= */
      // Error helpers
      function setError(el, errEl, msg){ if(!el||!errEl)return; errEl.textContent=msg; errEl.style.display="block"; el.setAttribute("aria-invalid","true"); }
      function clearError(el, errEl){ if(!el||!errEl)return; errEl.style.display="none"; el.removeAttribute("aria-invalid"); }

      // Category load error in modal
      function showCategoryLoadError(msg){
        const err = $("editErr-category");
        if (err){ err.textContent = msg; err.style.display = "block"; }
        DOM.editCategory?.setAttribute("aria-invalid","true");
      }
      function clearCategoryLoadError(){
        const err = $("editErr-category");
        if (err){ err.style.display = "none"; }
        DOM.editCategory?.removeAttribute("aria-invalid");
      }

      // Field validators
      function validateTitleInline(){
        const el = DOM.editTitle, err = $("editErr-title");
        const v = collapse(el.value);
        if (v.length===0 || v.length>TITLE_MAX){ setError(el,err,`Please enter a valid title (1–${TITLE_MAX} characters).`); return false; }
        clearError(el,err); return true;
      }
      function validateCategoryInline(){
        const el = DOM.editCategory, err = $("editErr-category");
        const v = (el.value||"").trim();
        if (!v){ setError(el,err,"Please select a category."); return false; }
        clearError(el,err); return true;
      }
      function validateDescriptionInline(){
        const el = DOM.editDescription, err = $("editErr-description");
        const v = collapse(el.value);
        DOM.editDescription.value = v;
        if (v.length===0 || v.length>DESC_MAX){ setError(el,err,`Description must be 1–${DESC_MAX} characters.`); return false; }
        clearError(el,err); return true;
      }
      function validateEditFormAll(){
        const a=validateTitleInline(), b=validateCategoryInline(), c=validateDescriptionInline();
        if(!a){ DOM.editTitle.focus({preventScroll:true}); return false; }
        if(!b){ DOM.editCategory.focus({preventScroll:true}); return false; }
        if(!c){ DOM.editDescription.focus({preventScroll:true}); return false; }
        return true;
      }

      function openEditModal(){
        DOM.editModalBackdrop.style.display="flex";
        clearError(DOM.editTitle, $("editErr-title"));
        clearError(DOM.editCategory, $("editErr-category"));
        clearError(DOM.editDescription, $("editErr-description"));
      }
      function closeEditModal(){
        DOM.editModalBackdrop.style.display="none";
        DOM.editForm.reset();
      }

      function populateEditModalFromCard(cardEl){
        const id          = cardEl.dataset.id;
        const title       = cardEl.querySelector(".card-title")?.textContent?.trim() || "";
        const category    = cardEl.querySelector('[data-field="category"]')?.textContent?.trim() || "";
        const description = cardEl.querySelector('[data-field="description"]')?.textContent?.trim() || "";

        DOM.editId.value          = id;
        DOM.editTitle.value       = title;
        DOM.editDescription.value = description;

        // Build options from ACTIVE; if current is archived, include `(Archived)`
        setCategoryOptions(categoriesActive, category);
      }

      /* =========================================================
        8) Filters (status segmented control + Completed-only UI)
      ========================================================= */
      function applyStatusFilter(){
        // Show/hide cards by data-status
        $$("#cards .card").forEach((card)=>{
          const st = String(card.dataset.status || "");
          if (currentStatus === "ALL") {
            card.style.display = "";
          } else {
            card.style.display = (st === currentStatus) ? "" : "none";
          }
        });

        // Show the extended filters + reset only for COMPLETED
        const showCompleted = currentStatus === "COMPLETED";
        DOM.filtersBar.classList.toggle("show-completed", showCompleted);
        DOM.completedFilters.toggleAttribute("hidden", !showCompleted);
        if (DOM.filtersActions) DOM.filtersActions.style.display = showCompleted ? "flex" : "none";
      }

      function wireStatusButtons(){
        DOM.filterBtns.forEach((btn)=>{
          btn.addEventListener("click", ()=>{
            DOM.filterBtns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentStatus = btn.dataset.status || "ALL";
            applyStatusFilter();
          });
        });
      }

      // Reset of completed-only inputs (stay in Completed view)
      function resetCompletedFilters(){
        if (DOM.svc) DOM.svc.value = "";
        if (DOM.dateFrom) DOM.dateFrom.value = "";
        if (DOM.dateTo) DOM.dateTo.value = "";
        // Re-apply status filter (remains on Completed, shows all completed items)
        applyStatusFilter();
        // Optional: clear any summary text if you add it later
        const summary = $("resultSummary");
        if (summary) summary.textContent = "";
      }

      /* =========================================================
        9) Boot
      ========================================================= */
      (async function init(){
        wireStatusButtons();     // hook status buttons
        await loadCategories();  // load categories for the edit modal dropdown
        const serviceRequests = await loadServiceRequests();
        renderCards(serviceRequests);   // render initial list, then applyStatusFilter() runs
        applyStatusFilter();     // ensure UI state & completed-filters visibility are correct

        // Wire reset button (only visible in Completed mode)
        if (DOM.resetBtn) {
          DOM.resetBtn.addEventListener("click", (e)=>{
            e.preventDefault();
            resetCompletedFilters();
          });
        }
      })();

      // Modal close
      DOM.editClose.addEventListener("click", closeEditModal);
      DOM.editCancel.addEventListener("click", closeEditModal);

      // Live validation
      DOM.editTitle.addEventListener("input",  validateTitleInline);
      DOM.editTitle.addEventListener("blur",   validateTitleInline);
      DOM.editCategory.addEventListener("change", validateCategoryInline);
      DOM.editCategory.addEventListener("blur",   validateCategoryInline);
      DOM.editDescription.addEventListener("input", validateDescriptionInline);
      DOM.editDescription.addEventListener("blur",  validateDescriptionInline);

      // Submit (works with novalidate)
      DOM.editForm.addEventListener("submit",(e)=>{
        e.preventDefault();
        if (!currentEditCard) return;
        if (!validateEditFormAll()) return;

        const id          = DOM.editId.value;
        const title       = collapse(DOM.editTitle.value);
        const category    = DOM.editCategory.value;
        const description = collapse(DOM.editDescription.value);
        
        try {
          editServiceRequest(id, { title, category, description });

          currentEditCard.querySelector(".card-title").textContent = title || "(Untitled request)";
          currentEditCard.querySelector('[data-field="category"]').textContent    = category;
          currentEditCard.querySelector('[data-field="description"]').textContent = description;

          const detail = { service_request_id:Number(id), title, category, description };
          document.dispatchEvent(new CustomEvent("request:update",{ detail }));
        } catch (e) {
          console.error(e);
        }

        closeEditModal();
      });

      document.getElementById("btnBackToDash").addEventListener("click", () => {
        window.location.href = "/pin/pin_dashboard.html";
      });
    </script>
  </body>
</html>
