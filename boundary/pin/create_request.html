<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Service Request</title>
  <style>
    /* =========================
      Design Tokens
    ========================== */
    :root {
      --bg: #f0f9ff;
      --card: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #38bdf8;
      --accent-2: #0ea5e9;
      --danger: #ef4444;
      --success-bg: #dcfce7;
      --success-text: #166534;
      --radius: 16px;
      --ring: rgba(14,165,233,.3);
    }

    /* =========================
      Base / Layout
    ========================== */
    * { box-sizing: border-box; }
    html, body { min-height: 100svh; }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg, #e0f2fe, var(--bg));
      color: var(--text);
      display: grid; place-items: start center;
      padding: 24px; overflow: auto;
    }

    /* =========================
      Card
    ========================== */
    .card {
      width: 100%; max-width: 720px;
      background: var(--card); border: 1px solid #e2e8f0; border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: visible;
    }

    /* =========================
      Header
    ========================== */
    .header {
      padding: 20px 24px; border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(180deg, #e0f2fe, #f8fafc);
    }
    .header h1 { margin: 0 0 4px; font-size: 1.4rem; color: var(--accent-2); }
    .header p  { margin: 0; color: var(--muted); font-size: .95rem; }

    /* =========================
      Form & Fields
    ========================== */
    form { padding: 16px 20px 8px; }
    .row { display: flex; flex-direction: column; margin-bottom: 18px; }
    label { margin-bottom: 8px; font-weight: 600; color: var(--text); }

    select, input, textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      background: #f8fafc; border: 1px solid #cbd5e1; color: var(--text);
      font-size: .98rem; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: var(--accent-2); box-shadow: 0 0 0 3px var(--ring);
    }
    textarea { min-height: 100px; resize: vertical; }

    /* Category preview */
    #categoryDesc {
      margin-top: 10px;
      background: #f1f5f9;
      color: #475569;
      cursor: not-allowed;
      opacity: 1;
      font-style: italic;
      max-height: 120px;
      overflow-y: auto;
    }

    /* Helper text / errors */
    .hint  { margin-top: 6px; font-size: .85rem; color: var(--muted); display: block; }
    .error { margin-top: 6px; color: var(--danger); font-size: .9rem; display: none; }

    /* =========================
      Actions & Buttons
    ========================== */
    .actions { display: flex; gap: 12px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
    button { border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; transition: transform .1s; }
    .btn-primary   { background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: #fff; }
    .btn-primary:hover { transform: scale(1.02); }
    .btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid #cbd5e1; }
    .btn-secondary:hover { background: #e2e8f0; }

    /* =========================
      Status Banner
    ========================== */
    .success { display: none; padding: 12px 14px; margin-top: 14px; border-radius: 12px; background: var(--success-bg); border: 1px solid #bbf7d0; color: var(--success-text); font-size: .95rem; }

    /* =========================
      Footer
    ========================== */
    .footer { padding: 18px 24px; border-top: 1px solid #e2e8f0; color: var(--muted); font-size: .9rem; display: flex; justify-content: space-between; flex-wrap: wrap; }

    /* =========================
      Responsive
    ========================== */
    @media (max-width: 640px) { .header, form, .footer { padding: 18px; } }
  </style>
</head>
<body>
  <div class="card" role="region" aria-labelledby="pageTitle">
    <div class="header">
      <h1 id="pageTitle">Create Service Request</h1>
      <p>Submit a new request (e.g., Transport, Meals, etc.).</p>
    </div>

    <form id="requestForm" novalidate>
      <!-- Category (Required) -->
      <div class="row">
        <label for="category">Category <span style="color:var(--muted)">*</span></label>
        <select id="category" name="category" required aria-describedby="cat-hint err-category">
          <option value="">Loading categories...</option>
        </select>
        <div id="err-category" class="error">Please select a category.</div>

        <textarea id="categoryDesc" rows="3" disabled placeholder="Select a category to view its description."></textarea>
        <small id="cat-hint" class="hint">Required. Choose the most suitable category.</small>
      </div>

      <!-- Title (Required) -->
      <div class="row">
        <label for="title">Title <span style="color:var(--muted)">*</span></label>
        <input id="title" name="title" type="text" placeholder="e.g., Ride to clinic" required aria-describedby="title-hint err-title" autofocus />
        <small id="title-hint" class="hint">Required. 1–80 characters.</small>
        <div id="err-title" class="error">Please enter a valid title.</div>
      </div>

      <!-- Description (Required) -->
      <div class="row">
        <label for="description">Description <span style="color:var(--muted)">*</span></label>
        <textarea id="description" name="description" placeholder="Briefly describe what you need help with." required aria-describedby="desc-hint err-desc"></textarea>
        <small id="desc-hint" class="hint">Required. Up to 255 characters.</small>
        <div id="err-desc" class="error">Please enter a valid description (max 255 characters).</div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="submit" id="submitBtn">Submit</button>
        <button class="btn-secondary" type="reset">Clear</button>
        <button class="btn-secondary" type="button" onclick="returnToDashboard()">Return to Dashboard</button>
      </div>

      <div id="status" class="success" role="status" aria-live="polite"></div>
    </form>

    <div class="footer">
      <span>© 2025 Community Support Platform</span>
    </div>
  </div>

  <script>
    /* =========================================================
      1) Config & constants
    ========================================================= */
    const DEBUG          = false;
    const API_URL        = "http://127.0.0.1:80/api";
    const REQUESTS_API   = `${API_URL}/service-requests`;
    const CATEGORIES_API = `${API_URL}/categories`;

    // Limits
    const TITLE_MAX = 80, DESC_MAX = 255;

    // Used to track whether a form was successfully submitted once
    const formCompletedRef = { value:false };

    /* =========================================================
      2) DOM
    ========================================================= */
    const $ = (id) => document.getElementById(id);
    const form      = $("requestForm");
    const submitBtn = $("submitBtn");
    const statusEl  = $("status");

    const input = {
      category:    $("category"),
      title:       $("title"),
      description: $("description"),
      categoryDesc:$("categoryDesc"),
    };
    const err = {
      category:    $("err-category"),
      title:       $("err-title"),
      description: $("err-desc"),
    };

    /* =========================================================
      3) Utils & status helpers
    ========================================================= */
    const collapse = (s)=> String(s ?? "").replace(/\s+/g, " ").trim();
    const nonEmpty = (s)=> collapse(s).length > 0;

    let hasSubmitted = false;
    let submitting   = false;
    let allCategories = [];

    function showOk(msg){
      statusEl.style.display = "block";
      statusEl.style.background = "#dcfce7";
      statusEl.style.border = "1px solid #bbf7d0";
      statusEl.style.color = "#166534";
      statusEl.textContent = msg;
      statusEl.setAttribute("aria-live", "polite");
      formCompletedRef.value = true;
    }
    function showErr(msg){
      statusEl.style.display = "block";
      statusEl.style.background = "#fee2e2";
      statusEl.style.border = "1px solid #fecaca";
      statusEl.style.color = "#991b1b";
      statusEl.textContent = msg;
      statusEl.setAttribute("aria-live", "assertive");
    }
    function showDebug(payload){
      statusEl.style.display = "block";
      statusEl.style.background = "#fef9c3";
      statusEl.style.border = "1px solid #fde047";
      statusEl.style.color = "#854d0e";
      statusEl.style.whiteSpace = "pre-wrap";
      statusEl.textContent = `[DEBUG]\nPOST ${REQUESTS_API}\n\n${JSON.stringify(payload, null, 2)}`;
    }
    function clearStatus(){
      statusEl.style.display = "none";
      statusEl.textContent = "";
      statusEl.setAttribute("aria-live", "polite");
    }

    // Apply runtime constraints from constants (avoid drift)
    (function applyRuntimeConstraints(){
      const set = (el, prop, val) => { if (el && val != null) el[prop] = val; };
      set(input.title,       "maxLength", TITLE_MAX);
      set(input.description, "maxLength", DESC_MAX);
    })();

    // After success, focus in any field resets the form once
    function attachPostSuccessReset(inputs, form, clearFn, flagRef){
      Object.values(inputs).forEach((f)=>{
        f.addEventListener("focus", ()=>{
          if(!flagRef.value) return;
          form.reset();
          clearFn();
          Object.values(inputs).forEach(el=> el.removeAttribute("aria-invalid"));
          inputs.categoryDesc.value = "";
          flagRef.value = false;
        });
      });
    }

    /* =========================================================
      4) Validation (inline + on submit)
    ========================================================= */
    function validateCategory(){
      const v = String(input.category.value || "").trim();
      const ok = nonEmpty(v);
      err.category.style.display = ok ? "none" : "block";
      input.category.toggleAttribute("aria-invalid", !ok);
      return ok;
    }
    function validateTitle(){
      const v = collapse(input.title.value);
      const ok = nonEmpty(v) && v.length <= TITLE_MAX;
      err.title.style.display = ok ? "none" : "block";
      input.title.toggleAttribute("aria-invalid", !ok);
      return ok;
    }
    function validateDesc(){
      const v = collapse(input.description.value);
      const ok = nonEmpty(v) && v.length <= DESC_MAX;
      err.description.style.display = ok ? "none" : "block";
      input.description.toggleAttribute("aria-invalid", !ok);
      return ok;
    }
    function validateForm(){
      const a = validateCategory();
      const b = validateTitle();
      const c = validateDesc();
      if(!a){ input.category.focus({preventScroll:true}); return false; }
      if(!b){ input.title.focus({preventScroll:true}); return false; }
      if(!c){ input.description.focus({preventScroll:true}); return false; }
      return true;
    }

    // Gentle live validation after first submit
    function attachLiveValidation(){
      const map = new Map([
        [input.category,    validateCategory],
        [input.title,       validateTitle],
        [input.description, validateDesc],
      ]);

      let timer;
      map.forEach((fn, el) => {
        if (!el) return;

        el.addEventListener("input", () => {
          if (!hasSubmitted) return;
          clearTimeout(timer);
          timer = setTimeout(() => { clearStatus(); fn(); }, 300);
        });

        el.addEventListener("blur", () => {
          if (!hasSubmitted) return;
          clearTimeout(timer); clearStatus(); fn();
        });
      });
    }

    /* =========================================================
      5) Load Categories + preview
    ========================================================= */
    document.addEventListener("DOMContentLoaded", loadCategories);
    async function loadCategories(){
      const sel = input.category;
      sel.innerHTML = '<option value="">Loading categories...</option>';
      sel.disabled = true;

      try{
        const res = await fetch(CATEGORIES_API, {
          method: "GET", mode: "cors", credentials: "include",
          headers: { "Content-Type": "application/json" },
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const raw = Array.isArray(data?.categories) ? data.categories : [];

        const active = raw
          .filter(c => String(c.status).toUpperCase() === "ACTIVE" && c?.name)
          .sort((a,b)=> String(a.name).localeCompare(String(b.name), undefined, { sensitivity: "base" }));

        allCategories = active;

        const opts = [];
        if(active.length === 0){
          opts.push(new Option("No categories available", ""));
          sel.disabled = true;
          showErr("No categories found. Please contact support to add categories.");
        }else{
          opts.push(new Option("Select a category...", ""));
          active.forEach(c => opts.push(new Option(c.name, c.name)));
          sel.disabled = false;
        }
        sel.replaceChildren(...opts);
      }catch(err){
        console.error("Failed to load categories:", err);
        sel.innerHTML = "";
        sel.appendChild(new Option("Error loading categories", ""));
        sel.disabled = true;
        showErr("Unable to load categories. Please try again later.");
      }
    }

    input.category.addEventListener("change", ()=>{
      const name = String(input.category.value || "").trim();
      const found = allCategories.find(c => String(c.name).trim() === name);
      if(!name){ input.categoryDesc.value = ""; return; }
      input.categoryDesc.value = found?.description || "No description available for this category.";
    });

    /* =========================================================
      6) Server boundary
    ========================================================= */
    async function displayServerMessage(response, { onSuccess } = {}){
      let body=null, serverMsg="";
      try{
        const ct = response.headers.get("content-type") || "";
        if(ct.includes("application/json")){
          body = await response.clone().json();
          serverMsg = body?.message || body?.error || "";
        }else{
          serverMsg = (await response.clone().text()).trim();
        }
      }catch{}

      if(response.status === 201 || response.status === 200){
        const okFlag = body === true || body === "true" || !body; // accept boolean true or empty
        if(okFlag){ showOk(serverMsg || "Request submitted successfully!"); onSuccess?.(body); return; }
        showErr(serverMsg || "Unexpected response from server (expected true)."); return;
      }
      if(response.status === 400){ showErr(serverMsg || "Submission failed. Please check your inputs."); return; }
      if(response.status === 401){ showErr(serverMsg || "Unauthorized. Please log in and try again."); return; }
      if(response.status === 403){ showErr(serverMsg || "Forbidden. You do not have permission for this action."); return; }

      showErr(serverMsg || `Unexpected Error: ${response.status}`);
    }

    /* =========================================================
      7) Submit / Reset / Nav
    ========================================================= */
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(submitting) return;
      submitting = true; hasSubmitted = true; clearStatus();

      if(!validateForm()){ submitting=false; return; }

      submitBtn.disabled = true;
      const payload = {
        category:    collapse(input.category.value),
        title:       collapse(input.title.value),
        description: collapse(input.description.value),
        created_by:  localStorage.getItem("user_id"),
      };

      if(DEBUG){ showDebug(payload); submitBtn.disabled=false; submitting=false; hasSubmitted=false; return; }

      try{
        const res = await fetch(REQUESTS_API, {
          method: "POST", mode: "cors", credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        await displayServerMessage(res, { 
          onSuccess: ()=> { 
            formCompletedRef.value = true; 

            // Manually clear fields
            // form.reset()  // <- don't call this as it clears the success banner as well
            input.category.value = "";
            input.title.value = "";
            input.description.value = "";
            input.categoryDesc.value = "";

            // Hide any inline errors and ARIA flags
            Object.values(err).forEach(el => el.style.display = "none");
            Object.values(input).forEach(el => el.removeAttribute("aria-invalid"));

            // stop live-validation from running immediately
            hasSubmitted = false;
          } 
        });
      }catch(err){
        console.error("Network error:", err);
        showErr("Network error. Please ensure the server is running.");
      }finally{
        setTimeout(()=>{ submitBtn.disabled = false; submitting=false; }, 700);
      }
    });

    form.addEventListener("reset", ()=>{
      Object.values(err).forEach(el => el.style.display = "none");
      Object.values(input).forEach(f => f.removeAttribute("aria-invalid"));
      input.categoryDesc.value = "";
      clearStatus(); hasSubmitted = false; formCompletedRef.value = false;
    });

    function returnToDashboard(){ window.location.href = "/pin/pin_dashboard.html"; }

    /* =========================================================
      8) Boot
    ========================================================= */
    (async function init(){
      attachLiveValidation();
      attachPostSuccessReset(input, form, clearStatus, formCompletedRef);
    })();
  </script>
</body>
</html>
