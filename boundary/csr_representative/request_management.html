<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Requests</title>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"/>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

    <style>
      /* =========================
        Design Tokens
      ========================= */
      :root{
        --bg-light:#f7f9fc; --primary:#34495e; --secondary:#2c3e50;
        --accent:#3498db; --accent-2:#2980b9; --text-dark:#2c3e50; --text-light:#fff;
        --shadow:0 4px 10px rgba(0,0,0,.1); --border:#eef2f7;
        --danger:#ef4444; --ring:rgba(14,165,233,.3);
        --tray-max: 980px; --input-h: 40px; --radius: 12px;
      }

      /* =========================
        Base / Reset
      ========================= */
      *{ box-sizing:border-box }
      html,body{ height:100% }
      body{
        margin:0;
        font-family:"Poppins",sans-serif;
        background:var(--bg-light);
        color:var(--text-dark);
      }
      button:disabled,.btn:disabled{ opacity:.55 !important; cursor:not-allowed !important; }
      :focus-visible{ outline:none; box-shadow:0 0 0 3px var(--ring) }

      /* =========================
        Layout
      ========================= */
      .main{ min-height:100%; display:flex; flex-direction:column; gap:1.25rem; padding:2rem }

      .topbar{ display:flex; justify-content:space-between; align-items:center; gap:1rem }
      .topbar h1{ font-size:1.6rem; font-weight:600; margin:0; color:var(--accent-2); }

      .controls-tray{
        display:flex; align-items:center; gap:.6rem;
        max-width:820px; width:min(100%, var(--tray-max));
      }
      .search-bar{ flex:1 1 auto; min-width:280px; }
      .search-bar input{
        width:100%; height:var(--input-h);
        padding:.6rem 1rem; border:1px solid #cbd5e1; border-radius:10px;
        outline:none; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.03);
      }
      .search-bar input:focus{ border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring); }

      #btnBackToDash{
        height:var(--input-h);
        padding:0 .95rem; border-radius:10px; border:1px solid #cbd5e1;
        background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.03);
        display:inline-flex; align-items:center; gap:.45rem;
        font-size:.85rem; font-weight:600; color:var(--secondary); white-space:nowrap;
      }
      #btnBackToDash:hover{ background:#f8fafc; }

      /* =========================
        Buttons
      ========================= */
      .btn{
        height:var(--input-h);
        padding:0 .9rem;
        border-radius:10px;
        border:none;
        cursor:pointer;
        font-size:.85rem;
        font-weight:600;
        display:inline-flex;
        align-items:center;
        gap:.45rem;
      }
      .btn.primary{ background:var(--accent); color:#fff }
      .btn.primary:hover{ background:var(--accent-2) }
      .btn.ghost{ background:#eef2f7; color:#34495e }
      .btn.outline{
        background:#fff; border:1px solid #cbd5e1; color:var(--secondary);
        box-shadow:0 1px 2px rgba(0,0,0,.03);
      }
      .btn.outline:hover{ background:#f8fafc; }

      /* =========================
        Filters
      ========================= */
      .filters{
        background:#fff; border:1px solid var(--border); border-radius:var(--radius);
        padding:.9rem; box-shadow:0 2px 8px rgba(0,0,0,.04);
        display:flex; flex-direction:column; gap:.8rem;
      }

      /* Row 1: Filters + Status chips */
      .filters .row-top{
        display:grid; align-items:center; column-gap:.6rem; row-gap:.5rem;
        grid-template-columns: auto 1fr; /* title | chips fill */
      }
      .filters .section-title{
        display:flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border-radius:999px;
        background:#f1f5f9; color:#475569; font-size:.82rem; font-weight:600;
      }
      .segmented{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
      .filter-btn{
        padding:.35rem .9rem; background:#fff; border:1px solid var(--accent);
        border-radius:999px; color:var(--accent); height:34px; display:inline-flex; align-items:center;
      }
      .filter-btn.active,.filter-btn:hover{
        background:var(--accent); color:#fff; box-shadow:0 0 0 3px var(--ring); border-color:var(--accent);
      }
      .filters .spacer{ display:block; width:12px; }

      /* Search (Row 2) should fill its grid cell + show icon */
      .search-bar.in-filters{ position:relative; width:100%; }
      .search-bar.in-filters .fa-magnifying-glass{
        position:absolute; left:12px; top:50%; transform:translateY(-50%);
        pointer-events:none; color:#94a3b8; font-size:.95rem;
      }
      .search-bar.in-filters input{
        width:100%; height:var(--input-h);
        padding:.6rem 1rem .6rem 2.25rem; /* room for the icon */
        border:1px solid #cbd5e1; border-radius:10px; background:#fff;
        box-shadow:0 1px 2px rgba(0,0,0,.03);
      }
      .search-bar.in-filters input:focus{ border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring); }

      /* Field group keeps label + control together */
      .field{
        display:grid;
        grid-template-columns:max-content 1fr;
        align-items:center;
        column-gap:.6rem;
        min-width:240px;
      }
      .filter-label{ font-size:.85rem; color:#64748b; white-space:nowrap }
      .select,.input{
        height:var(--input-h); padding:0 12px; border-radius:10px; font-size:.92rem;
        border:1px solid #cbd5e1; background:#fff; color:var(--text-dark);
        transition:border-color .2s, box-shadow .2s; width:100%;
      }
      .select:focus,.input:focus{ outline:none; border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring) }
      .input[type="date"]{ min-width:200px; }
      .range-sep{ text-align:center; color:#94a3b8; user-select:none; }

      /* Row 2 (outer grid): Search | spacer | Service | From | dash | To | Reset */
      .filters .row-bottom{
        display:grid; align-items:center; column-gap:1rem; row-gap:.6rem; margin-top:.5rem;
        grid-template-columns:
          minmax(360px,1.6fr)
          12px
          minmax(260px,1fr)
          minmax(240px,1fr)
          12px
          minmax(240px,1fr)
          auto;
      }
      .reset-inline{ justify-self:start; }

      /* =========================
        Card Grid
      ========================= */
      .cards{
        display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
        gap:1.5rem; align-items:stretch;
      }

      /* =========================
        Card
      ========================= */
      .card{
        background:#fff; border-radius:12px; box-shadow:var(--shadow);
        transition:transform .3s, box-shadow .3s;
        display:flex; flex-direction:column; height:100%;
      }
      .card:hover{ transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,.15) }

      .card-header{
        display:flex; justify-content:space-between; align-items:center;
        padding:1rem 1.25rem; border-bottom:1px solid var(--border);
        column-gap:.75rem; background:#f3f8ff;
        border-top-left-radius:12px; border-top-right-radius:12px;
      }
      .card-head-left{ display:flex; flex-direction:column; gap:.35rem; min-width:0; flex:1 1 auto; }
      .card-meta{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }

      .card-title{
        font-size:1.1rem; font-weight:700; color:var(--accent-2);
        margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        padding-right:.75rem; max-width:34ch;
      }

      .status-badge{
        flex:0 0 auto; font-size:.75rem; padding:.25rem .6rem;
        border-radius:999px; font-weight:600; border:1px solid #e6eef8;
      }
      .status-ACTIVE{ background:#ecf5ff; color:#1f6fba; border-color:#d6e9ff }
      .status-COMPLETED{ background:#edf9f0; color:#1f8a4d; border-color:#d9f2e0 }
      .status-CANCELLED{ background:#fee2e2; color:#991b1b; border-color:#fca5a5 }

      .id-pill{
        font-size:.72rem; padding:.25rem .5rem; border-radius:999px;
        background:#eef4ff; color:#476099; border:1px solid #dfe8ff;
      }
      .category-chip{
        font-size:.72rem; padding:.25rem .5rem; border-radius:999px;
        background:#f1f5f9; color:#475569; border:1px solid #e2e8f0;
      }

      .card-body{ padding:1rem 1.25rem 0; background:#fff; flex:1 1 auto }
      .card-row{ display:flex; gap:.5rem; margin:.35rem 0; flex-wrap:wrap; align-items:flex-start }
      .card-label{ font-weight:600; color:var(--secondary) }
      .muted{ color:#666 }
      .card-row [data-field]{ flex:1 1 auto; min-width:0; overflow-wrap:anywhere; }

      [data-field="description"]{
        display:-webkit-box; -webkit-box-orient:vertical;
        overflow:hidden; word-break:break-word;
        -webkit-line-clamp:3;
      }

      .card-footer{
        display:flex; justify-content:flex-end; align-items:center; gap:1rem;
        padding:.9rem 1.25rem; border-top:1px solid var(--border);
        margin-top:auto; background:#fbfcff;
      }

      /* =========================
        Responsive
      ========================= */
      @media (max-width: 980px){
        .filters .row-top{ grid-template-columns: auto 1fr; }
        .filters .row-bottom{
          grid-template-columns: 1fr; /* stack */
        }
        .search-bar.in-filters{ grid-column: 1 / -1; }
        .range-sep{ display:none; }
        .reset-inline{ justify-self:start; }
        .field{ min-width: unset; }
      }
      @media (max-width: 900px){
        /* reserved for future tweaks */
      }
    </style>
  </head>
  <body>
    <main class="main">

      <div class="topbar">
        <h1>Manage Requests</h1>
        <button type="button" class="btn outline" id="btnBackToDash">
          <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
          <span>Return to Dashboard</span>
        </button>
      </div>

      <!-- Filter bar -->
      <div class="filters" id="filtersBar">
        <!-- Row 1: Filters chip + status + search -->
        <div class="row-top">
          <span class="section-title"><i class="fa-solid fa-filter"></i> Filters</span>
          <div class="segmented" role="tablist" aria-label="Status">
            <button class="filter-btn active" data-status="ALL" role="tab" aria-selected="true">All</button>
            <button class="filter-btn" data-status="ACTIVE" role="tab">Active</button>
            <button class="filter-btn" data-status="CANCELLED" role="tab">Cancelled</button>
            <button class="filter-btn" data-status="COMPLETED" role="tab">Completed</button>
          </div>
        </div>

        <!-- Row 2: Search + Service + Date range + Reset -->
        <div class="row-bottom" aria-label="Additional filters">
          <div class="search-bar in-filters">
            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
            <input type="text" id="search" placeholder="Search Requests..." aria-label="Search requests"/>
          </div>

          <span class="spacer"></span>

          <div class="field">
            <label class="filter-label" for="svc">Service</label>
            <select id="svc" class="select">
              <option value="">All services</option>
            </select>
          </div>

          <div class="field">
            <label class="filter-label" id="dateFromLbl" for="from">Created from</label>
            <input type="date" id="from" class="input" />
          </div>

          <span class="range-sep" aria-hidden="true">–</span>

          <div class="field">
            <label class="filter-label" id="dateToLbl" for="to">Created to</label>
            <input type="date" id="to" class="input" />
          </div>

          <button class="btn ghost reset-inline" id="resetFilters">
            <i class="fa-solid fa-rotate-left"></i> Reset
          </button>
        </div>
      </div>

      <div class="cards" id="cards"></div>

      <!-- Template used to render cards -->
      <template id="card-template">
        <article class="card" data-status="">
          <header class="card-header">
            <div class="card-head-left">
              <h3 class="card-title"></h3>
              <div class="card-meta">
                <span class="id-pill" data-field="service_request_id"></span>
                <span class="category-chip" data-field="category_chip"></span>
              </div>
            </div>
            <span class="status-badge"></span>
          </header>

          <div class="card-body">
            <p class="card-row"><span class="card-label">Created by:</span> <span data-field="created_by" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Location:</span> <span data-field="location" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Description:</span> <span data-field="description" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Date created:</span> <span data-field="date_created" class="muted"></span></p>
            <p class="card-row"><span class="card-label">Date completed:</span> <span data-field="date_completed" class="muted"></span></p>
          </div>

          <footer class="card-footer">
            <div class="actions">
              <button class="btn primary">View</button>
            </div>
          </footer>
        </article>
      </template>

    </main>

    <script>
      const DEBUG = false;
      const API_URL = "http://127.0.0.1:80/api";
      const CATEGORIES_API = `${API_URL}/categories`;
      const SERVICE_REQUEST_API = `${API_URL}/service-requests`;
      const STATUS = { ACTIVE:"ACTIVE", COMPLETED:"COMPLETED", CANCELLED:"CANCELLED" };

      const $  = (id) => document.getElementById(id);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const DOM = {
        cardsWrap: $("cards"),
        tpl: $("card-template"),
        filterBtns: $$(".segmented .filter-btn"),
        filtersBar: $("filtersBar"),
        completedFilters: $("completedFilters"),
        svc: $("svc"),
        dateFrom: $("from"),
        dateTo: $("to"),
        dateFromLbl: $("dateFromLbl"),
        dateToLbl: $("dateToLbl"),
        resetBtn: $("resetFilters"),
        backToDashBtn: $("btnBackToDash"),
      };

      let categoriesActive = [];
      let categoriesAllMap = new Map();
      let currentStatus = "ALL";

      const log = (...a)=>{ if (DEBUG) console.log("[requests]", ...a); };

      async function fetchJSON(url, options={}) {
        const res = await fetch(url, { credentials:"include", mode:"cors", ...options });
        const ct  = res.headers.get("content-type") || "";
        let data=null; try{ data = ct.includes("application/json") ? await res.json() : await res.text(); }catch{}
        return { ok: res.ok, status: res.status, data };
      }

      function applyStatusBadge(badgeEl, status) {
        badgeEl.className = "status-badge";
        const s = String(status||"").toUpperCase();
        badgeEl.classList.add(`status-${s}`);
        badgeEl.textContent = s.charAt(0) + s.slice(1).toLowerCase();
      }

      function setSvcOptions(activeNames){
        if (!DOM.svc) return;
        const cur = DOM.svc.value || "";
        DOM.svc.innerHTML = "";
        const all = document.createElement("option");
        all.value = ""; all.textContent = "All services";
        DOM.svc.appendChild(all);
        activeNames.forEach(name=>{
          const o = document.createElement("option");
          o.value = name; o.textContent = name;
          DOM.svc.appendChild(o);
        });
        if ([...DOM.svc.options].some(o=>o.value===cur)) DOM.svc.value = cur;
      }

      function formatLocalDate(isoString) {
        if (!isoString) return "—";
        const date = new Date(isoString);
        return date.toLocaleString("en-SG", { dateStyle: "medium", timeStyle: "short" });
      }

      async function loadCategories() {
        try {
          const { ok, status, data } = await fetchJSON(CATEGORIES_API);
          if (!ok) throw new Error(`Categories load failed (${status})`);
          const list = Array.isArray(data?.categories) ? data.categories : [];
          categoriesAllMap = new Map(
            list
              .map(c => [ String(c?.name || ""), String(c?.status || "").toUpperCase() ])
              .filter(([name]) => !!name)
          );
          categoriesActive = [...categoriesAllMap.entries()]
            .filter(([, st]) => st === "ACTIVE")
            .map(([name]) => name)
            .sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:"base" }));
          setSvcOptions(categoriesActive);
        } catch (e) {
          console.error(e);
          categoriesAllMap.clear();
          categoriesActive = [];
          setSvcOptions([]);
        }
      }

      async function loadServiceRequests() {
        try {
          const { ok, status, data } = await fetchJSON(`${SERVICE_REQUEST_API}`);
          if (!ok) throw new Error(`Service requests load failed (${status})`);
          return Array.isArray(data) ? data
               : Array.isArray(data?.items) ? data.items
               : [];
        } catch (e) {
          console.error(e);
          return [];
        }
      }

      function renderCards(items=[]) {
        DOM.cardsWrap.innerHTML = "";
        items.sort((a, b) => new Date(b.date_created) - new Date(a.date_created));

        items.forEach((item)=>{
          const node = DOM.tpl.content.cloneNode(true);
          const card = node.querySelector(".card");

          card.dataset.id     = item.service_request_id;
          card.dataset.status = item.status;

          node.querySelector(".card-title").textContent = item.title || "(Untitled request)";
          node.querySelector('[data-field="service_request_id"]').textContent = `#${item.service_request_id}`;
          node.querySelector('[data-field="category_chip"]').textContent = item.category ?? "—";
          applyStatusBadge(node.querySelector(".status-badge"), item.status);

          // New rows
          node.querySelector('[data-field="created_by"]').textContent = item.user?.fullname ?? "—";
          node.querySelector('[data-field="location"]').textContent   = item.user?.address ?? "—";

          node.querySelector('[data-field="description"]').textContent    = item.description ?? "—";
          node.querySelector('[data-field="date_created"]').textContent   = formatLocalDate(item.date_created);
          node.querySelector('[data-field="date_completed"]').textContent =
            item.status === "COMPLETED" && item.date_completed
              ? formatLocalDate(item.date_completed)
              : "—";

          DOM.cardsWrap.appendChild(node);
        });

        applyStatusFilter();
      }

      function updateDateLabels(){
        const isCompleted = currentStatus === "COMPLETED";
        if (DOM.dateFromLbl) DOM.dateFromLbl.textContent = isCompleted ? "Completed from" : "Created from";
        if (DOM.dateToLbl)   DOM.dateToLbl.textContent   = isCompleted ? "Completed to"   : "Created to";
      }

      function applyStatusFilter(){
        $$("#cards .card").forEach((card)=>{
          const st = String(card.dataset.status || "");
          card.style.display = (currentStatus === "ALL" || st === currentStatus) ? "" : "none";
        });
        // Extra filters are now always visible; we just update context text.
        updateDateLabels();
      }

      function wireStatusButtons(){
        DOM.filterBtns.forEach((btn)=>{
          btn.addEventListener("click", ()=>{
            DOM.filterBtns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentStatus = btn.dataset.status || "ALL";
            applyStatusFilter();
          });
        });
      }

      function resetCompletedFilters(){
        if (DOM.svc) DOM.svc.value = "";
        if (DOM.dateFrom) DOM.dateFrom.value = "";
        if (DOM.dateTo) DOM.dateTo.value = "";
      }

      (async function init(){
        wireStatusButtons();
        await loadCategories();
        const serviceRequests = await loadServiceRequests();
        renderCards(serviceRequests);
        applyStatusFilter();

        if (DOM.resetBtn) {
          DOM.resetBtn.addEventListener("click", (e)=>{
            e.preventDefault(); resetCompletedFilters();
          });
        }

        DOM.backToDashBtn.addEventListener("click", () => {
          window.location.href = "/csr_representative/csr_dashboard.html";
        });
      })();
    </script>
  </body>
</html>
