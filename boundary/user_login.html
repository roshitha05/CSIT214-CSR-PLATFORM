<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <style>
    :root{
      --bg:#f0f9ff; --card:#fff; --text:#1e293b; --muted:#64748b;
      --accent:#38bdf8; --accent-2:#0ea5e9; --danger:#ef4444;
      --radius:16px; --ring:rgba(14,165,233,.3);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:linear-gradient(180deg,#e0f2fe,var(--bg));
      color:var(--text); display:grid; place-items:center; padding:24px;
    }
    .card{
      width:100%; max-width:420px; background:var(--card);
      border:1px solid #e2e8f0; border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.08); overflow:hidden; text-align:center;
    }
    .header{ padding:24px 28px; border-bottom:1px solid #e2e8f0; background:linear-gradient(180deg,#e0f2fe,#f8fafc); }
    .header h1{ margin:0; font-size:1.5rem; color:var(--accent-2); }
    .header p{ margin:4px 0 0; color:var(--muted); font-size:.95rem; }
    form{ padding:28px; text-align:left; }
    .row{ margin-bottom:18px; }
    label{ display:inline-block; margin-bottom:6px; font-weight:600; }
    input[type="text"], input[type="password"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #cbd5e1; background:#f8fafc;
      color:var(--text); font-size:.98rem; transition:border-color .2s, box-shadow .2s;
    }
    input:focus{ border-color:var(--accent-2); box-shadow:0 0 0 3px var(--ring); outline:none; }
    .password-wrapper{ position:relative; }
    .password-wrapper input{ padding-right:2.5rem; }
    .password-wrapper i{
      position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer;
      color:var(--accent);
    }
    .password-wrapper i:hover{ color:var(--accent-2); transform:translateY(-50%) scale(1.08); }
    .hint{ margin-top:6px; font-size:.85rem; color:var(--muted); }
    .actions{ margin-top:16px; display:flex; flex-direction:column; gap:10px; }
    button{
      border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer;
      transition:background .2s, transform .1s; font-size:1rem;
    }
    .btn-primary{ background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; }
    .btn-primary:hover{ transform:scale(1.02); }
    .btn-secondary{ background:#f1f5f9; color:var(--text); border:1px solid #cbd5e1; }
    .btn-secondary:hover{ background:#e2e8f0; }
    .error{ display:none; color:var(--danger); font-size:.9rem; margin-top:6px; }
    .status{
      display:none; margin:12px 0 0; padding:12px 14px; border-radius:12px;
      font-size:.95rem; text-align:center; width:100%; box-sizing:border-box;
    }
    .footer{ padding:18px 28px; border-top:1px solid #e2e8f0; color:var(--muted); font-size:.9rem; text-align:center; }
    @media (max-width:420px){ form,.header,.footer{ padding:18px; } .status{ margin:10px 0 0; } }
  </style>
</head>
<body>
  <div class="card" role="region">
    <div class="header">
      <h1>Welcome Back</h1>
      <p>Sign in to continue…</p>
    </div>

    <form id="loginForm" novalidate>
      <div class="row">
        <label for="username">Username / Email <span style="color:var(--muted)">*</span></label>
        <input
          type="text"
          id="username"
          name="username"
          required
          aria-describedby="user-error"
          placeholder="Enter your username or email"
          autocomplete="username"
          autofocus
        />
        <div id="user-error" class="error">Please enter your username or email.</div>
      </div>

      <div class="row">
        <label for="password">Password <span style="color:var(--muted)">*</span></label>
        <div class="password-wrapper">
          <input
            type="password"
            id="password"
            name="password"
            required
            aria-describedby="pass-error"
            placeholder="Enter your password"
            autocomplete="current-password"
          />
          <i class="fa-solid fa-eye-slash" id="togglePassword" aria-hidden="true" title="Show/Hide password"></i>
        </div>
        <div id="pass-error" class="error">Please enter your password.</div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="submit" id="loginBtn">Login</button>
        <button class="btn-secondary" type="reset">Clear</button>
      </div>
      <div id="status" class="status" role="status" aria-live="polite"></div>
    </form>

    <div class="footer">© 2025 Community Support Platform</div>
  </div>

  <script>
    // ========= Config =========
    const DEBUG = false;
    const API_URL = "http://127.0.0.1:80/api";
    const LOGIN_API = `${API_URL}/login`;

    const ROLE_REDIRECT = {
      "User Admin"         : "/user_admin/admin_dashboard.html",
      "CSR Representative" : "/csr_representative/csr_dashboard.html",
      "Person-In-Need"     : "/pin/pin_dashboard.html",
      "Platform Management": "/platform_management/platform_dashboard.html",
    };

    // ========= DOM =========
    const $ = (id) => document.getElementById(id);
    const form = $("loginForm");
    const btnLogin = $("loginBtn");
    const statusBox = $("status");
    const input = { loginId: $("username"), password: $("password") };
    const err = { loginId: $("user-error"), password: $("pass-error") };
    const togglePassword = $("togglePassword");

    // ========= Helpers =========
    const trim = (s) => String(s ?? "").trim();

    function setStatus(kind, msg, assertive = false) {
      statusBox.style.display = "block";
      statusBox.style.whiteSpace = "pre-wrap";
      statusBox.textContent = msg;
      statusBox.setAttribute("aria-live", assertive ? "assertive" : "polite");

      if (kind === "ok") {
        statusBox.style.background = "#dcfce7";
        statusBox.style.border = "1px solid #bbf7d0";
        statusBox.style.color = "#166534";
      } else if (kind === "err") {
        statusBox.style.background = "#fee2e2";
        statusBox.style.border = "1px solid #fecaca";
        statusBox.style.color = "#991b1b";
      } else {
        statusBox.style.background = "#fef9c3";
        statusBox.style.border = "1px solid #fde047";
        statusBox.style.color = "#854d0e";
      }
    }
    function clearStatus(){ statusBox.style.display="none"; statusBox.textContent=""; statusBox.setAttribute("aria-live","polite"); }

    function focusFirstInvalid(){
      for (const el of [input.loginId, input.password]) {
        if (el.hasAttribute("aria-invalid")) { el.focus({ preventScroll:true }); return; }
      }
    }

    function validateFields(){
      const loginVal = trim(input.loginId.value);
      const passVal = trim(input.password.value);
      let valid = true;

      if (!loginVal) {
        err.loginId.style.display = "block";
        input.loginId.setAttribute("aria-invalid","true");
        valid = false;
      } else {
        err.loginId.style.display = "none";
        input.loginId.removeAttribute("aria-invalid");
      }

      if (!passVal) {
        err.password.style.display = "block";
        input.password.setAttribute("aria-invalid","true");
        valid = false;
      } else {
        err.password.style.display = "none";
        input.password.removeAttribute("aria-invalid");
      }
      return valid;
    }

    // Live validation after first submit attempt
    let hasSubmitted = false;
    function attachLiveValidation(fields, validateFn, debounceMs = 200){
      let timer = null;
      fields.forEach(field => field.addEventListener("input", () => {
        if (!hasSubmitted) return;
        clearTimeout(timer);
        timer = setTimeout(() => { clearStatus(); validateFn(); }, debounceMs);
      }));
    }
    attachLiveValidation([input.loginId, input.password], validateFields);

    // Password toggle
    togglePassword.addEventListener("click", function(){
      const isPwd = input.password.type === "password";
      input.password.type = isPwd ? "text" : "password";
      this.classList.toggle("fa-eye", isPwd);
      this.classList.toggle("fa-eye-slash", !isPwd);
    });

    // ========= Network helpers =========
    async function login(payload){
      if (DEBUG){
        setStatus("warn", `[DEBUG]\n\nPOST ${LOGIN_API}\n\n${JSON.stringify(payload, null, 2)}`);
        return { ok:true, mock:true, user:{ user_id:"U123", username:"demo", fullname:"Demo User", user_profile:"User Admin" } };
      }

      const res = await fetch(LOGIN_API, {
        method: "POST",
        mode: "cors",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      return res;
    }

    async function displayServerMessage(res){
      let body = null;
      try { body = await res.clone().json(); } catch(_) {}
      
      const msg = trim(body?.message || "");
      if (res.ok === true){
        const user = body?.user || {};
        const role = trim(user.user_profile || "");

        // Persist identity for downstream pages
        if (user.user_id)  localStorage.setItem("user_id", user.user_id);
        if (user.username) localStorage.setItem("username", user.username);
        if (user.fullname) localStorage.setItem("fullname", user.fullname);
        if (role)          localStorage.setItem("role", role);

        setStatus("ok", msg || "Login successful.");
        const target = ROLE_REDIRECT[role];
        if (!target){
          setStatus("err", "Logged in but no dashboard assigned. Please contact support.", true);
          return;
        }
        setTimeout(() => { window.location.href = target; }, 800);
        return;
      }
      setStatus("err", msg || "Invalid username or password.", true);
    }

    // ========= Submit =========
    let submitting = false;
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (submitting) return;

      hasSubmitted = true;
      clearStatus();

      if (!validateFields()){
        focusFirstInvalid();
        return;
      }

      submitting = true;
      form.setAttribute("aria-busy","true");
      btnLogin.disabled = true; btnLogin.textContent = "Signing in…";

      const payload = {
        login: trim(input.loginId.value),
        password: trim(input.password.value),
      };

      try{
        const res = await login(payload);
        if (res?.mock){ setStatus("ok", "DEBUG: Logged in."); }
        else          { await displayServerMessage(res); }
      } catch(err){
        console.error(err);
        setStatus("err", "Network Error. Please ensure the server is running.", true);
      } finally{
        form.removeAttribute("aria-busy");
        btnLogin.disabled = false; btnLogin.textContent = "Login";
        submitting = false;
      }
    });

    // ========= Reset =========
    form.addEventListener("reset", () => {
      Object.values(err).forEach(el => el.style.display = "none");
      [input.loginId, input.password].forEach(f => f.removeAttribute("aria-invalid"));
      clearStatus();
      hasSubmitted = false;
      submitting = false;
    });
  </script>
</body>
</html>
